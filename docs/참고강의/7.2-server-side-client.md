# 7.2 Server Side Client

## 커밋 요약

React Router의 서버 사이드에서 Supabase 클라이언트를 올바르게 생성하고 사용하는 패턴을 구현한 커밋입니다. `@supabase/ssr` 패키지를 사용하여 쿠키 기반 인증을 지원하고, 모든 쿼리 함수들이 서버 사이드 클라이언트를 받도록 리팩토링합니다.

## 주요 변경사항

### 1. makeSSRClient 함수 생성

**파일**: `app/supa-client.ts`

```typescript
import {
  createBrowserClient,
  createServerClient,
  parseCookieHeader,
  serializeCookieHeader,
} from "@supabase/ssr";

export const makeSSRClient = (request: Request) => {
  const headers = new Headers();
  const serverSideClient = createServerClient<Database>(
    process.env.SUPABASE_URL!,
    process.env.SUPABASE_ANON_KEY!,
    {
      cookies: {
        getAll() {
          return parseCookieHeader(request.headers.get("Cookie") ?? "");
        },
        setAll(cookiesToSet) {
          cookiesToSet.forEach(({ name, value, options }) => {
            headers.append(
              "Set-Cookie",
              serializeCookieHeader(name, value, options)
            );
          });
        },
      },
    }
  );
  return {
    client: serverSideClient,
    headers,
  };
};
```

**패턴**:
- `createServerClient`로 서버 사이드 클라이언트 생성
- 쿠키 파싱 및 직렬화를 통해 인증 상태 관리
- `headers`를 반환하여 쿠키 설정 가능

**장점**:
- 서버 사이드에서 쿠키 기반 인증 지원
- 사용자 세션 상태 유지
- SSR 환경에서 올바른 인증 처리

### 2. 쿼리 함수 시그니처 변경

**변경 전**:
```typescript
export const getPosts = async ({
  limit,
  sorting,
  period = "all",
  keyword,
  topic,
}: {
  limit: number;
  sorting: "newest" | "popular";
  period?: "all" | "today" | "week" | "month" | "year";
  keyword?: string;
  topic?: string;
}) => {
  const { data, error } = await client.from("posts").select("*");
  // ...
};
```

**변경 후**:
```typescript
export const getPosts = async (
  client: SupabaseClient<Database>,
  {
    limit,
    sorting,
    period = "all",
    keyword,
    topic,
  }: {
    limit: number;
    sorting: "newest" | "popular";
    period?: "all" | "today" | "week" | "month" | "year";
    keyword?: string;
    topic?: string;
  }
) => {
  const { data, error } = await client.from("posts").select("*");
  // ...
};
```

**패턴**:
- `client`를 첫 번째 파라미터로 받음
- 나머지 파라미터는 객체로 전달
- 타입 안정성 향상

### 3. Loader 함수에서 makeSSRClient 사용

**변경 전**:
```typescript
export const loader = async ({ params }: Route.LoaderArgs) => {
  const posts = await getPosts({
    limit: 7,
    sorting: "newest",
  });
  return { posts };
};
```

**변경 후**:
```typescript
export const loader = async ({ request }: Route.LoaderArgs) => {
  const { client, headers } = makeSSRClient(request);
  const posts = await getPosts(client, {
    limit: 7,
    sorting: "newest",
  });
  return { posts };
};
```

**패턴**:
- `request`를 받아서 `makeSSRClient` 호출
- 생성된 `client`를 쿼리 함수에 전달
- `headers`는 필요시 사용 (쿠키 설정 등)

### 4. 브라우저 클라이언트 분리

**파일**: `app/supa-client.ts`

```typescript
export const browserClient = createBrowserClient<Database>(
  process.env.SUPABASE_URL!,
  process.env.SUPABASE_ANON_KEY!
);
```

**패턴**:
- 브라우저용 클라이언트와 서버용 클라이언트 분리
- 각각의 환경에 맞는 클라이언트 사용

## 적용 패턴

### 1. makeSSRClient 패턴

```typescript
export const makeSSRClient = (request: Request) => {
  const headers = new Headers();
  const serverSideClient = createServerClient<Database>(
    process.env.SUPABASE_URL!,
    process.env.SUPABASE_ANON_KEY!,
    {
      cookies: {
        getAll() {
          return parseCookieHeader(request.headers.get("Cookie") ?? "");
        },
        setAll(cookiesToSet) {
          cookiesToSet.forEach(({ name, value, options }) => {
            headers.append(
              "Set-Cookie",
              serializeCookieHeader(name, value, options)
            );
          });
        },
      },
    }
  );
  return { client: serverSideClient, headers };
};
```

### 2. 쿼리 함수 패턴

```typescript
export const getItems = async (
  client: SupabaseClient<Database>,
  {
    limit,
    // ... 다른 파라미터들
  }: {
    limit: number;
    // ... 타입 정의
  }
) => {
  const { data, error } = await client
    .from("table_name")
    .select("*")
    .limit(limit);
  
  if (error) throw error;
  return data;
};
```

### 3. Loader 패턴

```typescript
export const loader = async ({ request }: Route.LoaderArgs) => {
  const { client, headers } = makeSSRClient(request);
  
  const items = await getItems(client, {
    limit: 10,
  });
  
  return { items };
};
```

## 장점

1. **쿠키 기반 인증**: 서버 사이드에서 사용자 세션 상태 유지
2. **타입 안정성**: 클라이언트 타입을 명시적으로 전달
3. **테스트 용이성**: 클라이언트를 주입하여 테스트 가능
4. **환경 분리**: 브라우저와 서버 클라이언트 분리
5. **확장성**: 인증이 필요한 기능 추가 시 쉽게 확장 가능

## 주의사항

1. **모든 쿼리 함수 수정 필요**: 기존 쿼리 함수들이 모두 `client`를 받도록 변경해야 함
2. **모든 Loader 수정 필요**: 모든 loader 함수가 `makeSSRClient`를 사용하도록 변경해야 함
3. **타입 일관성**: `SupabaseClient<Database>` 타입을 일관되게 사용
4. **에러 처리**: 쿠키 파싱 실패 시 적절한 처리 필요

## 마이그레이션 순서

1. `makeSSRClient` 함수 생성
2. 쿼리 함수들에 `client` 파라미터 추가
3. Loader 함수들에서 `makeSSRClient` 사용
4. 기존 `client` import 제거
5. 테스트 및 검증

## 참고

- `@supabase/ssr` 패키지는 React Router와 Supabase를 함께 사용할 때 권장되는 패턴
- 쿠키 기반 인증은 서버 사이드 렌더링에서 필수적
- 클라이언트를 파라미터로 받으면 테스트와 재사용성이 향상됨

