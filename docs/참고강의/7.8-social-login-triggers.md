# 7.8 Social Login Triggers

## 커밋 요약

소셜 로그인(OAuth)을 통해 회원가입한 사용자의 프로필을 자동으로 생성하는 트리거를 개선한 커밋입니다. 각 소셜 프로바이더(Kakao, GitHub)별로 제공하는 메타데이터 구조가 다르기 때문에, 프로바이더별로 적절한 필드를 매핑하여 프로필을 생성하도록 트리거 함수를 확장했습니다.

## 주요 변경사항

### 소셜 로그인 프로바이더별 프로필 생성 로직 추가

**파일**: `app/sql/triggers/user_to_profile_trigger.sql`

기존의 일반적인 프로필 생성 로직에 추가하여, 각 소셜 프로바이더별로 특화된 메타데이터 필드를 사용하도록 개선했습니다.

#### Kakao 프로바이더 처리

```sql
if new.raw_app_meta_data ? 'provider' AND new.raw_app_meta_data ->> 'provider' = 'kakao' then
    insert into public.profiles (
        profile_id, 
        name, 
        username, 
        role, 
        avatar
    )
    values (
        new.id, 
        new.raw_user_meta_data ->> 'name', 
        new.raw_user_meta_data ->> 'preferred_username' || substr(md5(random()::text), 1, 5), 
        'developer', 
        new.raw_user_meta_data ->> 'avatar_url'
    );
end if;
```

**Kakao 메타데이터 구조**:
- `name`: 사용자 이름
- `preferred_username`: 선호하는 사용자명 (중복 방지를 위해 랜덤 suffix 추가)
- `avatar_url`: 프로필 이미지 URL

#### GitHub 프로바이더 처리

```sql
if new.raw_app_meta_data ? 'provider' AND new.raw_app_meta_data ->> 'provider' = 'github' then
    insert into public.profiles (
        profile_id, 
        name, 
        username, 
        role, 
        avatar
    )
    values (
        new.id, 
        new.raw_user_meta_data ->> 'full_name', 
        new.raw_user_meta_data ->> 'user_name' || substr(md5(random()::text), 1, 5), 
        'developer', 
        new.raw_user_meta_data ->> 'avatar_url'
    );
end if;
```

**GitHub 메타데이터 구조**:
- `full_name`: 전체 이름 (예: "John Doe")
- `user_name`: GitHub 사용자명 (중복 방지를 위해 랜덤 suffix 추가)
- `avatar_url`: 프로필 이미지 URL

## 메타데이터 구조 이해

### `raw_user_meta_data` vs `raw_app_meta_data`

Supabase Auth에서 사용자 메타데이터는 두 가지 형태로 저장됩니다:

1. **`raw_user_meta_data`**: 사용자가 제공하거나 OAuth 프로바이더에서 받은 사용자 정보
   - 예: 이름, 프로필 이미지, 사용자명 등
   - OAuth 프로바이더마다 구조가 다름

2. **`raw_app_meta_data`**: 애플리케이션에서 설정한 메타데이터
   - 예: `provider` (어떤 OAuth 프로바이더를 사용했는지)
   - 애플리케이션 로직에 의해 설정됨

### 프로바이더별 메타데이터 필드 매핑

| 프로바이더 | 이름 필드 | 사용자명 필드 | 아바타 필드 |
|-----------|---------|------------|-----------|
| **Kakao** | `name` | `preferred_username` | `avatar_url` |
| **GitHub** | `full_name` | `user_name` | `avatar_url` |
| **Google** | `full_name` 또는 `name` | `email` (기본값) | `avatar_url` |
| **Email** | `name` | `username` | 없음 |

## 트리거 실행 순서

```
1. 사용자가 소셜 로그인 완료
   ↓
2. Supabase Auth에 auth.users 레코드 생성
   ↓
3. user_to_profile_trigger 트리거 실행
   ↓
4. handle_new_user() 함수 실행
   ↓
5. raw_app_meta_data에서 provider 확인
   ↓
6. 프로바이더별 분기 처리:
   - Kakao → Kakao 메타데이터 필드 사용
   - GitHub → GitHub 메타데이터 필드 사용
   - 기타 → 일반 프로필 생성 로직 사용
   ↓
7. public.profiles 테이블에 프로필 생성
```

## 구현 패턴

### 1. 프로바이더 확인 패턴

```sql
-- raw_app_meta_data에 provider 키가 있는지 확인
if new.raw_app_meta_data ? 'provider' then
    -- provider 값 확인
    if new.raw_app_meta_data ->> 'provider' = 'kakao' then
        -- Kakao 처리
    elsif new.raw_app_meta_data ->> 'provider' = 'github' then
        -- GitHub 처리
    end if;
end if;
```

**주요 포인트**:
- `?` 연산자: JSONB 필드에 특정 키가 있는지 확인
- `->>` 연산자: JSONB 필드에서 텍스트 값 추출

### 2. 중복 방지 패턴

```sql
-- 사용자명에 랜덤 suffix 추가
new.raw_user_meta_data ->> 'preferred_username' || substr(md5(random()::text), 1, 5)
```

**이유**:
- 소셜 로그인 사용자명이 중복될 수 있음
- 데이터베이스 제약조건 위반 방지
- 짧은 랜덤 문자열 추가로 충돌 가능성 최소화

### 3. 기본값 설정 패턴

```sql
-- 프로바이더별 처리 후에도 기본 프로필 생성 로직 실행
-- (메타데이터가 없는 경우 대비)
```

## 현재 프로젝트 적용 고려사항

### 현재 트리거 상태

현재 프로젝트의 `user_to_profile_trigger.sql`은 일반적인 프로필 생성 로직만 포함하고 있습니다:

```sql
-- 이름/역할 값 구성 (raw_user_meta_data → raw_app_meta_data → 기본값)
v_name := coalesce(
  new.raw_user_meta_data ->> 'name',
  new.raw_app_meta_data ->> 'name',
  split_part(new.email, '@', 1),
  'Anonymous'
);
```

### 적용 필요 여부

**적용 권장**:
- ✅ Kakao, GitHub 등 소셜 로그인을 지원하는 경우
- ✅ 각 프로바이더의 고유한 메타데이터 구조를 활용하고 싶은 경우
- ✅ 프로필 이미지(avatar)를 자동으로 가져오고 싶은 경우

**적용 불필요**:
- ❌ 소셜 로그인을 지원하지 않는 경우
- ❌ 현재 일반 로직으로 충분한 경우
- ❌ 프로바이더별 차이를 신경 쓰지 않는 경우

### 적용 시 주의사항

1. **프로필 스키마 확인**: 현재 프로젝트의 `profiles` 테이블에 `avatar` 필드가 있는지 확인
   - 현재 스키마: `avatarUrl: text("avatar_url")` ✅

2. **필드명 매핑**: 프로바이더별 필드명이 다를 수 있음
   - Kakao: `preferred_username`
   - GitHub: `user_name`
   - Google: `email` 또는 `name`

3. **중복 처리**: 사용자명(slug) 중복 방지 로직 필요
   - 현재 프로젝트는 이미 랜덤 suffix를 사용 중 ✅

4. **기본값 처리**: 프로바이더별 처리 후에도 기본 프로필 생성 로직이 실행되도록 순서 조정 필요

## 개선된 트리거 예시

```sql
create function public.handle_new_user()
returns trigger
language plpgsql
security definer
set search_path = public
as $$
declare
  v_name text;
  v_role text;
  v_slug_base text;
  v_slug text;
  v_avatar_url text;
begin
  -- 안전장치: 이메일이 없으면 프로필을 생성할 수 없음
  if new.email is null then
    raise exception 'Cannot create profile for auth user % without email', new.id;
  end if;

  -- 프로바이더별 특화 처리
  if new.raw_app_meta_data ? 'provider' then
    -- Kakao 처리
    if new.raw_app_meta_data ->> 'provider' = 'kakao' then
      v_name := new.raw_user_meta_data ->> 'name';
      v_slug_base := new.raw_user_meta_data ->> 'preferred_username';
      v_avatar_url := new.raw_user_meta_data ->> 'avatar_url';
      v_role := 'creator';
      
      -- 사용자명 중복 방지
      v_slug := v_slug_base || '-' || substr(md5(random()::text), 1, 5);
      
      insert into public.profiles (
        id,
        auth_user_id,
        name,
        email,
        slug,
        role,
        avatar_url
      )
      values (
        new.id,
        new.id,
        v_name,
        new.email,
        v_slug,
        v_role,
        v_avatar_url
      );
      
      return new;
    end if;

    -- GitHub 처리
    if new.raw_app_meta_data ->> 'provider' = 'github' then
      v_name := new.raw_user_meta_data ->> 'full_name';
      v_slug_base := new.raw_user_meta_data ->> 'user_name';
      v_avatar_url := new.raw_user_meta_data ->> 'avatar_url';
      v_role := 'creator';
      
      -- 사용자명 중복 방지
      v_slug := v_slug_base || '-' || substr(md5(random()::text), 1, 5);
      
      insert into public.profiles (
        id,
        auth_user_id,
        name,
        email,
        slug,
        role,
        avatar_url
      )
      values (
        new.id,
        new.id,
        v_name,
        new.email,
        v_slug,
        v_role,
        v_avatar_url
      );
      
      return new;
    end if;
  end if;

  -- 일반 프로필 생성 로직 (기존 로직)
  -- ... (기존 코드)
end;
$$;
```

## 테스트 방법

### 1. Kakao 로그인 테스트

1. Kakao로 소셜 로그인 완료
2. Supabase Dashboard에서 `auth.users` 테이블 확인
3. `raw_app_meta_data`에 `provider: 'kakao'` 확인
4. `raw_user_meta_data`에 `name`, `preferred_username`, `avatar_url` 확인
5. `public.profiles` 테이블에 프로필이 올바르게 생성되었는지 확인

### 2. GitHub 로그인 테스트

1. GitHub로 소셜 로그인 완료
2. Supabase Dashboard에서 `auth.users` 테이블 확인
3. `raw_app_meta_data`에 `provider: 'github'` 확인
4. `raw_user_meta_data`에 `full_name`, `user_name`, `avatar_url` 확인
5. `public.profiles` 테이블에 프로필이 올바르게 생성되었는지 확인

## 참고 자료

- [Supabase Auth Metadata 문서](https://supabase.com/docs/guides/auth/auth-metadata)
- [PostgreSQL JSONB 연산자 문서](https://www.postgresql.org/docs/current/functions-json.html)
- [7.7 Social Login 문서](./7.7-social-login.md)

