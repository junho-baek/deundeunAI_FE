# 8.0 Create Post Page

## ì»¤ë°‹ ìš”ì•½

ì»¤ë®¤ë‹ˆí‹° í¬ìŠ¤íŠ¸ ìƒì„± í˜ì´ì§€ë¥¼ êµ¬í˜„í•œ ì»¤ë°‹ì…ë‹ˆë‹¤. Mutations íŒŒì¼ ë¶„ë¦¬, Zod ê²€ì¦, ì¸ì¦ ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ ì¶”ê°€ ë“±ì˜ íŒ¨í„´ì„ ë„ì…í–ˆìŠµë‹ˆë‹¤.

## ì£¼ìš” ë³€ê²½ì‚¬í•­

### 1. Mutations íŒŒì¼ ë¶„ë¦¬ (`mutations.ts`)

**ëª©ì **: ë°ì´í„° ìƒì„±/ìˆ˜ì •/ì‚­ì œ ë¡œì§ì„ `queries.ts`ì—ì„œ ë¶„ë¦¬í•˜ì—¬ ê´€ì‹¬ì‚¬ ë¶„ë¦¬

**íŒ¨í„´**:
- `queries.ts`: ë°ì´í„° ì¡°íšŒ (SELECT)
- `mutations.ts`: ë°ì´í„° ë³€ê²½ (INSERT, UPDATE, DELETE)

**ì˜ˆì‹œ**:
```typescript
// app/features/community/mutations.ts
export const createPost = async (
  client: SupabaseClient<Database>,
  {
    title,
    category,
    content,
    userId,
  }: {
    title: string;
    category: string;
    content: string;
    userId: string;
  }
) => {
  // 1. ì¹´í…Œê³ ë¦¬ ì¡°íšŒ
  const { data: categoryData, error: categoryError } = await client
    .from("topics")
    .select("topic_id")
    .eq("slug", category)
    .single();

  if (categoryError) {
    throw categoryError;
  }

  // 2. í¬ìŠ¤íŠ¸ ìƒì„±
  const { data, error } = await client
    .from("posts")
    .insert({
      title,
      content,
      profile_id: userId,
      topic_id: categoryData.topic_id,
    })
    .select()
    .single();

  if (error) {
    throw error;
  }

  return data;
};
```

### 2. ì¸ì¦ ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ (`getLoggedInUserId`)

**ëª©ì **: ì—¬ëŸ¬ ê³³ì—ì„œ ë°˜ë³µë˜ëŠ” ì¸ì¦ ì²´í¬ ë¡œì§ì„ ì¬ì‚¬ìš© ê°€ëŠ¥í•œ í•¨ìˆ˜ë¡œ ì¶”ì¶œ

**êµ¬í˜„**:
```typescript
// app/features/users/queries.ts
export const getLoggedInUserId = async (
  client: SupabaseClient<Database>
) => {
  const { data, error } = await client.auth.getUser();
  if (error || data.user === null) {
    throw redirect("/auth/login");
  }
  return data.user.id;
};
```

**ì‚¬ìš© ì˜ˆì‹œ**:
```typescript
export const loader = async ({ request }: Route.LoaderArgs) => {
  const { client } = makeSSRClient(request);
  await getLoggedInUserId(client); // ì¸ì¦ ì²´í¬
  const topics = await getTopics(client);
  return { topics };
};

export const action = async ({ request }: Route.ActionArgs) => {
  const { client } = makeSSRClient(request);
  const userId = await getLoggedInUserId(client); // ì¸ì¦ ì²´í¬ + userId ë°˜í™˜
  // ... ë‚˜ë¨¸ì§€ ë¡œì§
};
```

### 3. Action í•¨ìˆ˜ì—ì„œ Zod ê²€ì¦

**íŒ¨í„´**: Form ë°ì´í„°ë¥¼ Zod ìŠ¤í‚¤ë§ˆë¡œ ê²€ì¦í•˜ê³ , ì—ëŸ¬ë¥¼ `actionData`ë¡œ ë°˜í™˜

**êµ¬í˜„**:
```typescript
const formSchema = z.object({
  title: z.string().min(1).max(40),
  category: z.string().min(1).max(100),
  content: z.string().min(1).max(1000),
});

export const action = async ({ request }: Route.ActionArgs) => {
  const formData = await request.formData();
  const { success, error, data } = formSchema.safeParse(
    Object.fromEntries(formData)
  );

  if (!success) {
    return {
      fieldErrors: error.flatten().fieldErrors,
    };
  }

  const { title, category, content } = data;
  // ... ë‚˜ë¨¸ì§€ ë¡œì§
};
```

**UIì—ì„œ ì—ëŸ¬ í‘œì‹œ**:
```typescript
{actionData && "fieldErrors" in actionData && (
  <div className="text-red-500">
    {actionData.fieldErrors.title?.join(", ")}
  </div>
)}
```

### 4. Meta í•¨ìˆ˜ì—ì„œ loaderData ì‚¬ìš©

**ë³€ê²½ ì „**:
```typescript
export const meta: Route.MetaFunction = ({ params }) => {
  return [{ title: `${params.postId} | wemake` }];
};
```

**ë³€ê²½ í›„**:
```typescript
export const meta: Route.MetaFunction = ({ data }) => {
  return [{ title: `${data.post.title} on ${data.post.topic_name} | wemake` }];
};
```

**ì¥ì **: ì‹¤ì œ ë°ì´í„°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ë™ì  ë©”íƒ€ ì •ë³´ ìƒì„± ê°€ëŠ¥

### 5. DateTime ì²˜ë¦¬ ê°œì„ 

**ë³€ê²½ ì „**:
```typescript
DateTime.fromISO(loaderData.post.created_at).toRelative()
```

**ë³€ê²½ í›„**:
```typescript
DateTime.fromISO(loaderData.post.created_at, {
  zone: "utc",
}).toRelative({ unit: "hours" })
```

**ì¥ì **: íƒ€ì„ì¡´ ëª…ì‹œë¡œ ì¼ê´€ëœ ì‹œê°„ í‘œì‹œ ë³´ì¥

### 6. Foreign Key ì œì•½ì¡°ê±´ ëª…ì‹œì  ì •ì˜

**ë³€ê²½ ì „**:
```typescript
topic_id: bigint({ mode: "number" }).references(() => topics.topic_id, {
  onDelete: "cascade",
}),
profile_id: uuid().references(() => profiles.profile_id, {
  onDelete: "cascade",
}),
```

**ë³€ê²½ í›„**:
```typescript
topic_id: bigint({ mode: "number" })
  .references(() => topics.topic_id, {
    onDelete: "cascade",
  })
  .notNull(),
profile_id: uuid()
  .references(() => profiles.profile_id, {
    onDelete: "cascade",
  })
  .notNull(),
```

**ì¥ì **: NOT NULL ì œì•½ì¡°ê±´ ëª…ì‹œë¡œ ë°ì´í„° ë¬´ê²°ì„± ë³´ì¥

## ì ìš© ë°©ì•ˆ

### âœ… ì´ë¯¸ ì ìš©ëœ íŒ¨í„´

1. **Foreign Key ì œì•½ì¡°ê±´ ëª…ì‹œì  ì •ì˜**: `app/features/projects/schema.ts`ì—ì„œ ì´ë¯¸ ì ìš©ë¨
2. **Action í•¨ìˆ˜ì—ì„œ Zod ê²€ì¦**: ì¼ë¶€ í˜ì´ì§€ì—ì„œ ì´ë¯¸ ì‚¬ìš© ì¤‘
3. **Meta í•¨ìˆ˜ì—ì„œ loaderData ì‚¬ìš©**: ì¼ë¶€ í˜ì´ì§€ì—ì„œ ì´ë¯¸ ì‚¬ìš© ì¤‘

### ğŸ”„ ì ìš© ê°€ëŠ¥í•œ íŒ¨í„´

#### 1. Mutations íŒŒì¼ ë¶„ë¦¬

**í˜„ì¬ ìƒíƒœ**: `queries.ts`ì— `createProject`, `updateProject` ë“±ì´ ëª¨ë‘ í¬í•¨ë¨

**ì ìš© ë°©ì•ˆ**:
- `app/features/projects/mutations.ts` ìƒì„±
- `createProject`, `updateProject`, `deleteProject`, `createInitialProjectSteps`, `updateProjectStep` ë“±ì„ ì´ë™

**ì¥ì **:
- ê´€ì‹¬ì‚¬ ë¶„ë¦¬ (ì¡°íšŒ vs ë³€ê²½)
- ì½”ë“œ ê°€ë…ì„± í–¥ìƒ
- í…ŒìŠ¤íŠ¸ ìš©ì´ì„± í–¥ìƒ

#### 2. `getLoggedInUserId` ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ ì¶”ê°€

**í˜„ì¬ ìƒíƒœ**: ê° action/loaderì—ì„œ ì¸ì¦ ì²´í¬ë¥¼ ì§ì ‘ êµ¬í˜„

**ì ìš© ë°©ì•ˆ**:
- `app/features/users/queries.ts`ì— `getLoggedInUserId` í•¨ìˆ˜ ì¶”ê°€
- ê¸°ì¡´ ì¸ì¦ ì²´í¬ ë¡œì§ì„ ì´ í•¨ìˆ˜ë¡œ êµì²´

**ì ìš© ëŒ€ìƒ**:
- `project-create-page.tsx`ì˜ action
- `project-status-action.tsx`ì˜ action
- `subscribe-action.tsx`ì˜ action
- ê¸°íƒ€ ì¸ì¦ì´ í•„ìš”í•œ action/loader

**ì¥ì **:
- ì½”ë“œ ì¤‘ë³µ ì œê±°
- ì¼ê´€ëœ ì¸ì¦ ì²´í¬
- ìœ ì§€ë³´ìˆ˜ ìš©ì´

#### 3. DateTime ì²˜ë¦¬ ê°œì„ 

**í˜„ì¬ ìƒíƒœ**: DateTime ì²˜ë¦¬ ì‹œ íƒ€ì„ì¡´ ëª…ì‹œ ì—†ìŒ

**ì ìš© ë°©ì•ˆ**:
- ëª¨ë“  `DateTime.fromISO()` í˜¸ì¶œì— `zone: "utc"` ì¶”ê°€
- í•„ìš”ì‹œ `unit` ì˜µì…˜ ëª…ì‹œ

**ì ìš© ëŒ€ìƒ**:
- í”„ë¡œì íŠ¸ ìƒì„± ì‹œê°„ í‘œì‹œ
- í”„ë¡œì íŠ¸ ì—…ë°ì´íŠ¸ ì‹œê°„ í‘œì‹œ
- í”„ë¡œí•„ ê°€ì… ì‹œê°„ í‘œì‹œ

## êµ¬í˜„ ìš°ì„ ìˆœìœ„

### ë†’ìŒ (ì¦‰ì‹œ ì ìš© ê¶Œì¥)

1. **`getLoggedInUserId` í•¨ìˆ˜ ì¶”ê°€**
   - ì˜í–¥ë„: ë†’ìŒ (ì—¬ëŸ¬ íŒŒì¼ì—ì„œ ì‚¬ìš©)
   - ë‚œì´ë„: ë‚®ìŒ
   - íš¨ê³¼: ì½”ë“œ ì¤‘ë³µ ì œê±°, ì¼ê´€ì„± í–¥ìƒ

2. **Action í•¨ìˆ˜ì—ì„œ Zod ê²€ì¦ ê°•í™”**
   - ì˜í–¥ë„: ì¤‘ê°„ (ë°ì´í„° ë¬´ê²°ì„±)
   - ë‚œì´ë„: ë‚®ìŒ
   - íš¨ê³¼: ì…ë ¥ ê²€ì¦ ê°•í™”

### ì¤‘ê°„ (ì ì§„ì  ì ìš©)

3. **Mutations íŒŒì¼ ë¶„ë¦¬**
   - ì˜í–¥ë„: ì¤‘ê°„ (ì½”ë“œ êµ¬ì¡° ê°œì„ )
   - ë‚œì´ë„: ì¤‘ê°„
   - íš¨ê³¼: ì½”ë“œ ê°€ë…ì„± í–¥ìƒ

4. **DateTime ì²˜ë¦¬ ê°œì„ **
   - ì˜í–¥ë„: ë‚®ìŒ (UX ê°œì„ )
   - ë‚œì´ë„: ë‚®ìŒ
   - íš¨ê³¼: ì‹œê°„ í‘œì‹œ ì¼ê´€ì„±

## ì°¸ê³ ì‚¬í•­

- ì»¤ë®¤ë‹ˆí‹° ê¸°ëŠ¥ì€ í˜„ì¬ í”„ë¡œì íŠ¸ì—ì„œ ì œì™¸ë˜ë¯€ë¡œ, íŒ¨í„´ë§Œ ì°¸ê³ í•˜ì—¬ í”„ë¡œì íŠ¸ ìƒì„±/ìˆ˜ì • ë“±ì— ì ìš©
- Mutations ë¶„ë¦¬ëŠ” ì„ íƒì‚¬í•­ì´ì§€ë§Œ, ì½”ë“œë² ì´ìŠ¤ê°€ ì»¤ì§ˆìˆ˜ë¡ ìœ ìš©í•¨
- `getLoggedInUserId`ëŠ” ë°˜ë“œì‹œ ì ìš© ê¶Œì¥ (ì½”ë“œ ì¤‘ë³µ ì œê±° íš¨ê³¼ í¼)

