# 7.6 Triggers and Navigation

## 커밋 요약

사용자 인증 후 프로필 정보를 네비게이션에 표시하고, 트리거를 개선하여 회원가입 시 프로필을 자동 생성하는 기능을 구현한 커밋입니다. 루트 레이아웃에서 사용자 프로필 정보를 가져와 네비게이션 컴포넌트에 전달하고, 트리거를 수정하여 회원가입 시 전달된 메타데이터를 활용하도록 개선했습니다.

## 주요 변경사항

### 1. Navigation 컴포넌트에 사용자 정보 Props 추가

**파일**: `app/common/components/navigation.tsx`

```typescript
export default function Navigation({
  isLoggedIn,
  hasNotifications,
  hasMessages,
  username,
  avatar,
  name,
}: {
  isLoggedIn: boolean;
  hasNotifications: boolean;
  hasMessages: boolean;
  username?: string;
  avatar?: string | null;
  name?: string;
}) {
  return (
    <nav>
      {/* ... */}
      <DropdownMenu>
        <DropdownMenuTrigger asChild>
          <Avatar>
            {avatar ? (
              <AvatarImage src={avatar} />
            ) : (
              <AvatarFallback>{name?.[0]}</AvatarFallback>
            )}
          </Avatar>
        </DropdownMenuTrigger>
        <DropdownMenuContent>
          <DropdownMenuLabel className="flex flex-col">
            <span className="font-medium">{name}</span>
            <span className="text-xs text-muted-foreground">
              @{username}
            </span>
          </DropdownMenuLabel>
        </DropdownMenuContent>
      </DropdownMenu>
    </nav>
  );
}
```

**패턴**:
- `username`, `avatar`, `name` props 추가
- `avatar`가 있으면 `AvatarImage` 표시, 없으면 `name`의 첫 글자로 `AvatarFallback` 표시
- 드롭다운 메뉴에 사용자 이름과 사용자명 표시

**장점**:
- 실제 사용자 정보 표시
- 아바타 이미지가 없을 때 대체 표시
- 사용자 경험 향상

### 2. 루트 레이아웃에서 프로필 정보 가져오기

**파일**: `app/root.tsx`

```typescript
import { makeSSRClient } from "./supa-client";
import { getUserById } from "./features/users/queries";

export const loader = async ({ request }: Route.LoaderArgs) => {
  const { client } = makeSSRClient(request);
  const {
    data: { user },
  } = await client.auth.getUser();
  
  if (user) {
    const profile = await getUserById(client, { id: user.id });
    return { user, profile };
  }
  
  return { user: null, profile: null };
};

export default function App({ loaderData }: Route.ComponentProps) {
  const isLoggedIn = loaderData.user !== null;
  
  return (
    <Navigation
      isLoggedIn={isLoggedIn}
      username={loaderData.profile?.username}
      avatar={loaderData.profile?.avatar}
      name={loaderData.profile?.name}
      hasNotifications={false}
      hasMessages={false}
    />
  );
}
```

**패턴**:
- 사용자가 로그인되어 있으면 프로필 정보도 함께 가져오기
- `getUserById`로 프로필 정보 조회
- 프로필 정보를 Navigation 컴포넌트에 전달

**장점**:
- 전역에서 사용자 프로필 정보 접근 가능
- 네비게이션에 실제 사용자 정보 표시
- 인증 상태와 프로필 정보를 함께 관리

### 3. getUserById 쿼리 함수 추가

**파일**: `app/features/users/queries.ts`

```typescript
export const getUserById = async (
  client: SupabaseClient<Database>,
  { id }: { id: string }
) => {
  const { data, error } = await client
    .from("profiles")
    .select(`
      profile_id,
      name,
      username,
      avatar
    `)
    .eq("profile_id", id)
    .single();

  if (error) {
    throw error;
  }

  return data;
};
```

**패턴**:
- `profile_id`로 프로필 조회
- 필요한 필드만 선택 (`profile_id`, `name`, `username`, `avatar`)
- `.single()`로 단일 결과만 반환
- 에러 발생 시 throw

**장점**:
- 사용자 ID로 프로필 정보 조회
- 필요한 필드만 선택하여 성능 최적화
- 재사용 가능한 쿼리 함수

### 4. My Profile 페이지에서 실제 사용자로 리다이렉트

**파일**: `app/features/users/pages/my-profile-page.tsx`

```typescript
import { makeSSRClient } from "~/supa-client";
import { getUserById } from "../queries";

export async function loader({ request }: Route.LoaderArgs) {
  const { client } = makeSSRClient(request);
  const {
    data: { user },
  } = await client.auth.getUser();
  
  if (user) {
    const profile = await getUserById(client, { id: user.id });
    return redirect(`/users/${profile.username}`);
  }
  
  return redirect("/auth/login");
}
```

**패턴**:
- 쿠키에서 사용자 정보 가져오기
- 사용자가 있으면 프로필 정보 조회
- 프로필의 `username`으로 공개 프로필 페이지로 리다이렉트
- 사용자가 없으면 로그인 페이지로 리다이렉트

**장점**:
- 실제 사용자 프로필로 리다이렉트
- 인증되지 않은 사용자는 로그인 페이지로 이동
- 공개 프로필 페이지 재사용

### 5. 트리거 개선 - 회원가입 시 메타데이터 활용

**파일**: `app/sql/triggers/user_to_profile_trigger.sql`

```sql
create or replace function public.handle_new_user()
returns trigger
language plpgsql
security definer
set search_path = public
as $$
begin
    if new.raw_app_meta_data is not null then
        if new.raw_app_meta_data ? 'provider' AND new.raw_app_meta_data ->> 'provider' = 'email' then
            if new.raw_user_meta_data ? 'name' and new.raw_user_meta_data ? 'username' then
                insert into public.profiles (profile_id, name, username, role)
                values (new.id, new.raw_user_meta_data ->> 'name', new.raw_user_meta_data ->> 'username', 'developer');
            else
                insert into public.profiles (profile_id, name, username, role)
                values (new.id, 'Anonymous', 'mr.' || substr(md5(random()::text), 1, 8), 'developer');
            end if;
        end if;
    end if;
    return new;
end;
$$;
```

**패턴**:
- `raw_user_meta_data`에서 `name`과 `username` 확인
- 메타데이터가 있으면 해당 값 사용
- 메타데이터가 없으면 기본값 사용 (`Anonymous`, 랜덤 사용자명)

**장점**:
- 회원가입 시 전달된 메타데이터 활용
- 프로필 자동 생성
- 메타데이터가 없어도 기본 프로필 생성

## 적용 패턴

### 1. Navigation에 사용자 정보 전달 패턴

```typescript
// root.tsx
export const loader = async ({ request }: Route.LoaderArgs) => {
  const { client } = makeSSRClient(request);
  const { data: { user } } = await client.auth.getUser();
  
  if (user) {
    const profile = await getUserById(client, { id: user.id });
    return { user, profile };
  }
  
  return { user: null, profile: null };
};

// Navigation 컴포넌트
<Navigation
  isLoggedIn={isLoggedIn}
  username={loaderData.profile?.username}
  avatar={loaderData.profile?.avatar}
  name={loaderData.profile?.name}
/>
```

### 2. 사용자 ID로 프로필 조회 패턴

```typescript
export const getUserById = async (
  client: SupabaseClient<Database>,
  { id }: { id: string }
) => {
  const { data, error } = await client
    .from("profiles")
    .select("profile_id, name, username, avatar")
    .eq("profile_id", id)
    .single();

  if (error) throw error;
  return data;
};
```

### 3. My Profile 리다이렉트 패턴

```typescript
export async function loader({ request }: Route.LoaderArgs) {
  const { client } = makeSSRClient(request);
  const { data: { user } } = await client.auth.getUser();
  
  if (user) {
    const profile = await getUserById(client, { id: user.id });
    return redirect(`/users/${profile.username}`);
  }
  
  return redirect("/auth/login");
}
```

### 4. 트리거에서 메타데이터 활용 패턴

```sql
if new.raw_user_meta_data ? 'name' and new.raw_user_meta_data ? 'username' then
    insert into public.profiles (profile_id, name, username, role)
    values (new.id, new.raw_user_meta_data ->> 'name', new.raw_user_meta_data ->> 'username', 'developer');
else
    insert into public.profiles (profile_id, name, username, role)
    values (new.id, 'Anonymous', 'mr.' || substr(md5(random()::text), 1, 8), 'developer');
end if;
```

## 장점

1. **사용자 경험**: 네비게이션에 실제 사용자 정보 표시
2. **자동화**: 트리거로 프로필 자동 생성
3. **일관성**: 회원가입 시 전달된 메타데이터 활용
4. **재사용성**: 공개 프로필 페이지 재사용
5. **타입 안정성**: 프로필 정보 타입 안정성

## 주의사항

1. **트리거 실행**: 트리거는 Supabase에서 실행되므로 마이그레이션 필요
2. **메타데이터 구조**: `raw_user_meta_data`의 구조를 정확히 파악해야 함
3. **에러 처리**: `getUserById`에서 에러 발생 시 적절히 처리
4. **프로필 존재 여부**: 프로필이 없을 수 있으므로 옵셔널 체이닝 사용
5. **성능**: 루트 레이아웃의 loader는 모든 페이지에서 실행되므로 최적화 필요

## 마이그레이션 순서

1. `getUserById` 쿼리 함수 추가
2. 루트 레이아웃의 loader에서 프로필 정보 가져오기
3. Navigation 컴포넌트에 사용자 정보 props 추가
4. My Profile 페이지의 loader 수정
5. 트리거 SQL 파일 수정 및 마이그레이션 실행

## 참고

- `raw_user_meta_data`는 Supabase `signUp`의 `options.data`로 전달된 데이터
- 트리거는 `auth.users` 테이블에 새 사용자가 추가될 때 자동 실행
- 프로필 정보는 옵셔널이므로 옵셔널 체이닝(`?.`) 사용
- 루트 레이아웃의 loader는 모든 페이지에서 실행되므로 성능 고려 필요

