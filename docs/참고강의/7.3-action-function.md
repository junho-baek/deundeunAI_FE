# 7.3 Action Function

## 커밋 요약

React Router의 `action` 함수를 사용하여 폼 제출을 처리하고, `useNavigation`을 통해 제출 상태를 표시하며, `actionData`를 사용하여 에러 메시지를 표시하는 패턴을 구현한 커밋입니다. 또한 루트 레이아웃에서 `makeSSRClient`를 사용하여 사용자 인증 상태를 확인하는 방법도 포함합니다.

## 주요 변경사항

### 1. Action 함수 구현

**파일**: `app/features/auth/pages/login-page.tsx`

```typescript
export const action = async ({ request }: Route.ActionArgs) => {
  await new Promise((resolve) => setTimeout(resolve, 4000));
  const formData = await request.formData();
  const email = formData.get("email");
  const password = formData.get("password");
  
  return {
    message: "Error wrong password",
  };
};
```

**패턴**:
- `action` 함수는 POST 요청을 처리
- `request.formData()`로 폼 데이터 추출
- 에러 메시지나 성공 데이터를 반환
- `actionData`를 통해 컴포넌트에서 접근 가능

**장점**:
- 서버 사이드에서 폼 제출 처리
- 타입 안정성 향상
- 에러 처리 중앙화

### 2. useNavigation으로 제출 상태 표시

**파일**: `app/features/auth/pages/login-page.tsx`

```typescript
import { useNavigation } from "react-router";

export default function LoginPage({ actionData }: Route.ComponentProps) {
  const navigation = useNavigation();
  const isSubmitting = navigation.state === "submitting";
  
  return (
    <Form className="w-full space-y-4" method="post">
      <Button className="w-full" type="submit" disabled={isSubmitting}>
        {isSubmitting ? (
          <LoaderCircle className="animate-spin" />
        ) : (
          "Log in"
        )}
      </Button>
      {actionData?.message && (
        <p className="text-sm text-red-500">{actionData.message}</p>
      )}
    </Form>
  );
}
```

**패턴**:
- `useNavigation()`으로 네비게이션 상태 확인
- `navigation.state === "submitting"`으로 제출 중 상태 확인
- 제출 중일 때 버튼 비활성화 및 로딩 표시
- `actionData`로 에러 메시지 표시

**장점**:
- 사용자 경험 향상 (제출 중 피드백)
- 중복 제출 방지
- 에러 메시지 표시

### 3. Form에 method="post" 추가

**변경 전**:
```typescript
<Form className="w-full space-y-4">
```

**변경 후**:
```typescript
<Form className="w-full space-y-4" method="post">
```

**패턴**:
- `method="post"`를 명시하여 action 함수 호출
- 기본값은 GET이므로 POST를 명시해야 함

### 4. 루트 레이아웃에서 사용자 인증 상태 확인

**파일**: `app/root.tsx`

```typescript
import { makeSSRClient } from "./supa-client";

export const loader = async ({ request }: Route.LoaderArgs) => {
  const { client } = makeSSRClient(request);
  const {
    data: { user },
  } = await client.auth.getUser();
  return { user };
};

export default function App({ loaderData }: Route.ComponentProps) {
  const { pathname } = useLocation();
  const navigation = useNavigation();
  const isLoading = navigation.state === "loading";
  const isLoggedIn = loaderData.user !== null;
  
  return (
    <Navigation
      isLoggedIn={isLoggedIn}
      hasNotifications={false}
      hasMessages={false}
    />
  );
}
```

**패턴**:
- 루트 레이아웃의 `loader`에서 사용자 인증 상태 확인
- `makeSSRClient`를 사용하여 서버 사이드에서 쿠키 기반 인증 확인
- `client.auth.getUser()`로 현재 사용자 정보 가져오기
- `loaderData`를 통해 컴포넌트에서 사용자 정보 접근

**장점**:
- 전역 인증 상태 관리
- 모든 페이지에서 사용자 정보 접근 가능
- 쿠키 기반 인증 지원

## 적용 패턴

### 1. Action 함수 패턴

```typescript
export const action = async ({ request }: Route.ActionArgs) => {
  const formData = await request.formData();
  const field1 = formData.get("field1");
  const field2 = formData.get("field2");
  
  // 유효성 검사
  if (!field1 || !field2) {
    return {
      error: "필수 필드가 누락되었습니다.",
    };
  }
  
  // 처리 로직
  try {
    // 데이터 저장 또는 업데이트
    return { success: true };
  } catch (error) {
    return {
      error: error instanceof Error ? error.message : "알 수 없는 오류",
    };
  }
};
```

### 2. 제출 상태 표시 패턴

```typescript
import { useNavigation } from "react-router";

export default function MyPage({ actionData }: Route.ComponentProps) {
  const navigation = useNavigation();
  const isSubmitting = navigation.state === "submitting";
  
  return (
    <Form method="post">
      <Button type="submit" disabled={isSubmitting}>
        {isSubmitting ? "제출 중..." : "제출"}
      </Button>
      {actionData?.error && (
        <p className="text-red-500">{actionData.error}</p>
      )}
    </Form>
  );
}
```

### 3. 루트 레이아웃 인증 패턴

```typescript
export const loader = async ({ request }: Route.LoaderArgs) => {
  const { client } = makeSSRClient(request);
  const {
    data: { user },
  } = await client.auth.getUser();
  return { user };
};

export default function App({ loaderData }: Route.ComponentProps) {
  const isLoggedIn = loaderData.user !== null;
  // ...
}
```

## 장점

1. **타입 안정성**: `actionData` 타입이 자동으로 추론됨
2. **에러 처리**: 서버 사이드에서 에러 처리 및 메시지 반환
3. **사용자 경험**: 제출 중 상태 표시로 피드백 제공
4. **중복 제출 방지**: `disabled` 속성으로 중복 제출 방지
5. **전역 인증 상태**: 루트 레이아웃에서 인증 상태 관리

## 주의사항

1. **Form method 명시**: `method="post"`를 명시해야 action 함수가 호출됨
2. **에러 처리**: action 함수에서 적절한 에러 처리 필요
3. **타입 안정성**: `actionData`의 타입을 명시적으로 정의하는 것이 좋음
4. **인증 상태**: 루트 레이아웃의 loader는 모든 페이지에서 실행되므로 성능 고려 필요

## 마이그레이션 순서

1. Action 함수 추가
2. Form에 `method="post"` 추가
3. `useNavigation`으로 제출 상태 표시
4. `actionData`로 에러 메시지 표시
5. 루트 레이아웃에 인증 상태 확인 추가 (선택사항)

## 참고

- `action` 함수는 POST 요청만 처리 (GET은 loader에서 처리)
- `useNavigation`은 네비게이션 상태를 실시간으로 추적
- `actionData`는 action 함수의 반환값을 포함
- 루트 레이아웃의 loader는 모든 페이지에서 실행되므로 최적화 필요

