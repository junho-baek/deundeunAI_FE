# 5.5 Type Fest

## 커밋 개요

이 커밋은 `type-fest` 라이브러리를 사용하여 Supabase에서 자동 생성된 타입을 확장하고 조정하는 작업을 포함합니다. View의 필드 타입을 더 정확하게 정의하고, 컴포넌트에서 불필요한 non-null assertion (`!`)을 제거하여 타입 안전성을 향상시킵니다.

## 주요 변경사항

### 1. type-fest 패키지 추가

**package.json에 추가된 패키지:**

```json
{
  "dependencies": {
    "type-fest": "^4.30.1"
  }
}
```

**핵심 포인트:**

- `type-fest`: TypeScript 타입 유틸리티 라이브러리
- 타입 조작 및 확장을 위한 강력한 유틸리티 제공
- `MergeDeep`, `SetNonNullable`, `SetFieldType` 등의 유틸리티 사용

### 2. Supabase 클라이언트 타입 확장

**Before (기본 타입 사용):**

```typescript
// app/supa-client.ts
import { createClient } from "@supabase/supabase-js";
import { Database } from "database.types";

const client = createClient<Database>(
  process.env.SUPABASE_URL!,
  process.env.SUPABASE_ANON_KEY!
);
```

**After (type-fest로 타입 확장):**

```typescript
// app/supa-client.ts
import { createClient } from "@supabase/supabase-js";
import { MergeDeep, SetNonNullable, SetFieldType } from "type-fest";
import { Database as SupabaseDatabase } from "database.types";

type Database = MergeDeep<
  SupabaseDatabase,
  {
    public: {
      Views: {
        community_post_list_view: {
          Row: SetFieldType<
            SetNonNullable<
              SupabaseDatabase["public"]["Views"]["community_post_list_view"]["Row"]
            >,
            "author_avatar",
            string | null
          >;
        };
      };
    };
  }
>;

const client = createClient<Database>(
  process.env.SUPABASE_URL!,
  process.env.SUPABASE_ANON_KEY!
);
```

**주요 차이점:**

- `MergeDeep`: 타입을 깊게 병합하여 확장
- `SetNonNullable`: 특정 필드를 non-nullable로 설정
- `SetFieldType`: 특정 필드의 타입을 변경
- View의 특정 필드 타입을 더 정확하게 정의

### 3. 컴포넌트에서 Non-null Assertion 제거

**Before (non-null assertion 사용):**

```typescript
// app/features/community/pages/community-page.tsx
<PostCard
  key={post.post_id}
  id={post.post_id!}              // ! 사용
  title={post.title!}              // ! 사용
  author={post.author!}            // ! 사용
  authorAvatarUrl={post.author_avatar}
  category={post.topic!}           // ! 사용
  postedAt={post.created_at!}      // ! 사용
  votesCount={post.upvotes!}       // ! 사용
  expanded
/>
```

**After (non-null assertion 제거):**

```typescript
// app/features/community/pages/community-page.tsx
<PostCard
  key={post.post_id}
  id={post.post_id}                // ! 제거
  title={post.title}                // ! 제거
  author={post.author}              // ! 제거
  authorAvatarUrl={post.author_avatar}
  category={post.topic}             // ! 제거
  postedAt={post.created_at}        // ! 제거
  votesCount={post.upvotes}         // ! 제거
  expanded
/>
```

**변경 이유:**

- 타입 확장으로 인해 필드가 이미 non-nullable로 정의됨
- 불필요한 non-null assertion 제거로 코드 가독성 향상
- 타입 안전성 향상 (런타임 에러 가능성 감소)

## 우리 프로젝트에 적용하기

### 현재 상태 분석

우리 프로젝트는 현재:

- ✅ Supabase 클라이언트 설정 완료
- ✅ View 사용 중 (project_list_view, project_stats_view 등)
- ✅ 컴포넌트에서 non-null assertion 사용 중
- ❌ type-fest 미설치
- ❌ 타입 확장 미적용

### 적용 전략

#### 1단계: type-fest 패키지 설치

```bash
npm install type-fest
```

#### 2단계: 타입 확장 전략 수립

**타입 확장이 필요한 경우:**

1. **View의 필드 타입이 부정확한 경우**
   - Supabase가 자동 생성한 타입이 실제 데이터와 맞지 않음
   - 예: `author_avatar`가 `string | null`이어야 하는데 `string`으로 정의됨

2. **특정 필드를 non-nullable로 만들고 싶은 경우**
   - View에서 항상 값이 존재하는 필드
   - 예: `post_id`, `title` 등 필수 필드

3. **타입을 더 구체적으로 정의하고 싶은 경우**
   - 기본 타입이 너무 넓게 정의됨
   - 예: `string` 대신 특정 리터럴 타입

#### 3단계: Supabase 클라이언트 타입 확장

**파일: `app/lib/supa-client.ts`**

```typescript
import { createClient } from "@supabase/supabase-js";
import { MergeDeep, SetNonNullable, SetFieldType } from "type-fest";
import { Database as SupabaseDatabase } from "~/database.types";

// 타입 확장 정의
type Database = MergeDeep<
  SupabaseDatabase,
  {
    public: {
      Views: {
        // project_list_view 타입 확장 예시
        project_list_view: {
          Row: SetFieldType<
            SetNonNullable<
              SupabaseDatabase["public"]["Views"]["project_list_view"]["Row"],
              "project_id" | "title" | "created_at"
            >,
            "owner_avatar_url",
            string | null
          >;
        };
        // project_stats_view 타입 확장 예시
        project_stats_view: {
          Row: SetNonNullable<
            SupabaseDatabase["public"]["Views"]["project_stats_view"]["Row"],
            "total_likes" | "total_views" | "project_count"
          >;
        };
      };
    };
  }
>;

const supabaseUrl = process.env.SUPABASE_URL;
const supabaseAnonKey = process.env.SUPABASE_ANON_KEY;

if (!supabaseUrl || !supabaseAnonKey) {
  throw new Error(
    "Supabase 환경 변수가 설정되지 않았습니다. SUPABASE_URL과 SUPABASE_ANON_KEY를 확인하세요."
  );
}

const client = createClient<Database>(supabaseUrl, supabaseAnonKey);

export default client;
```

**타입 확장 패턴 설명:**

1. **SetNonNullable**: 특정 필드를 non-nullable로 설정
   ```typescript
   SetNonNullable<Type, "field1" | "field2">
   ```

2. **SetFieldType**: 특정 필드의 타입을 변경
   ```typescript
   SetFieldType<Type, "field", NewType>
   ```

3. **MergeDeep**: 타입을 깊게 병합
   ```typescript
   MergeDeep<BaseType, ExtensionType>
   ```

#### 4단계: 컴포넌트에서 Non-null Assertion 제거

**Before:**

```typescript
// app/features/projects/pages/project-list-page.tsx
{projects.map((project) => (
  <ProjectCard
    key={project.project_id}
    id={project.project_id!}
    title={project.title!}
    description={project.description || undefined}
    likes={formatNumber(project.likes || 0)}
    ctr={formatCTR(project.ctr || 0)}
    budget={formatBudget(project.budget || 0)}
    thumbnail={project.thumbnail || undefined}
  />
))}
```

**After:**

```typescript
// app/features/projects/pages/project-list-page.tsx
{projects.map((project) => (
  <ProjectCard
    key={project.project_id}
    id={project.project_id}  // ! 제거
    title={project.title}      // ! 제거
    description={project.description || undefined}
    likes={formatNumber(project.likes || 0)}
    ctr={formatCTR(project.ctr || 0)}
    budget={formatBudget(project.budget || 0)}
    thumbnail={project.thumbnail || undefined}
  />
))}
```

#### 5단계: 타입 체크 및 테스트

**타입 체크:**

```bash
npm run typecheck
```

**주의사항:**

- 타입 확장 후 컴포넌트에서 타입 에러가 발생할 수 있음
- 각 필드의 실제 사용 패턴을 확인하여 적절한 타입 확장 필요
- 모든 non-null assertion을 제거하기 전에 타입이 올바르게 확장되었는지 확인

## type-fest 유틸리티 설명

### MergeDeep

두 타입을 깊게 병합합니다. 중첩된 객체의 모든 레벨을 병합합니다.

```typescript
type A = { a: { b: string } };
type B = { a: { c: number } };
type Merged = MergeDeep<A, B>;
// 결과: { a: { b: string; c: number } }
```

### SetNonNullable

특정 필드를 non-nullable로 설정합니다.

```typescript
type User = {
  id: string | null;
  name: string | null;
  email: string | null;
};

type NonNullableUser = SetNonNullable<User, "id" | "name">;
// 결과: { id: string; name: string; email: string | null; }
```

### SetFieldType

특정 필드의 타입을 변경합니다.

```typescript
type User = {
  id: string;
  age: number;
};

type UserWithStringAge = SetFieldType<User, "age", string>;
// 결과: { id: string; age: string; }
```

## 장단점 비교

### type-fest 사용 장점

- ✅ **타입 안전성 향상**: 더 정확한 타입 정의
- ✅ **코드 가독성 향상**: non-null assertion 제거
- ✅ **유연한 타입 확장**: Supabase 자동 생성 타입을 수정 없이 확장
- ✅ **타입 재사용**: 확장된 타입을 여러 곳에서 사용 가능

### type-fest 사용 단점

- ❌ **복잡성 증가**: 타입 정의가 복잡해질 수 있음
- ❌ **학습 곡선**: type-fest 유틸리티 학습 필요
- ❌ **타입 체크 시간 증가**: 복잡한 타입으로 인한 컴파일 시간 증가 가능

### 언제 type-fest를 사용해야 할까?

**type-fest 사용 권장:**

- Supabase 자동 생성 타입이 실제 데이터와 맞지 않는 경우
- View의 필드 타입을 더 정확하게 정의하고 싶은 경우
- 여러 컴포넌트에서 non-null assertion을 반복 사용하는 경우
- 타입 안전성을 높이고 싶은 경우

**type-fest 사용 비권장:**

- 간단한 타입만 필요한 경우 (오버엔지니어링)
- 타입 확장이 불필요한 경우
- 프로젝트 초기 단계에서 타입이 자주 변경되는 경우

## 주의사항

1. **타입 확장 시 주의**
   - 실제 데이터 구조와 일치하는지 확인
   - View의 SQL 정의를 확인하여 필드가 항상 값이 있는지 검증
   - 잘못된 타입 확장은 런타임 에러를 유발할 수 있음

2. **점진적 적용**
   - 모든 View를 한 번에 확장하지 말고 필요한 것부터 적용
   - 각 확장 후 타입 체크 및 테스트 수행

3. **타입 동기화**
   - 데이터베이스 스키마 변경 시 타입 확장도 함께 업데이트
   - `db:typegen` 실행 후 타입 확장 부분도 확인

4. **Non-null Assertion 제거 시 주의**
   - 타입 확장이 올바르게 적용되었는지 확인
   - 실제로 null이 될 수 있는 필드는 assertion을 유지하거나 옵셔널 체이닝 사용

5. **성능 고려**
   - 복잡한 타입 확장은 TypeScript 컴파일 시간에 영향을 줄 수 있음
   - 필요한 경우에만 타입 확장 사용

## 다음 단계

1. ✅ type-fest 패키지 설치
2. ✅ 타입 확장 개념 이해
3. ⏳ 프로젝트에 필요한 타입 확장 식별
4. ⏳ Supabase 클라이언트 타입 확장 적용
5. ⏳ 컴포넌트에서 non-null assertion 제거
6. ⏳ 타입 체크 및 테스트
7. ⏳ 문서화 및 팀 공유

## 참고 자료

- [type-fest 공식 문서](https://github.com/sindresorhus/type-fest)
- [TypeScript 타입 조작 가이드](https://www.typescriptlang.org/docs/handbook/2/types-from-types.html)
- [Supabase TypeScript 타입 생성](https://supabase.com/docs/reference/javascript/typescript-support)

