# 6.12 User Profile (사용자 프로필 페이지)

## 개요

사용자 프로필 페이지를 실제 DB 데이터로 구현하는 패턴입니다. 프로필 레이아웃을 통해 공통 UI를 제공하고, `loader`를 통해 사용자 정보와 관련 데이터를 미리 로드합니다.

## 주요 변경사항

### 1. Foreign Key 제약조건 명시적 정의 (`products/schema.ts`)

#### 변경 전
```typescript
export const products = pgTable("products", {
  profile_id: uuid()
    .references(() => profiles.profile_id, { onDelete: "cascade" })
    .notNull(),
  // ...
});
```

#### 변경 후
```typescript
export const products = pgTable(
  "products",
  {
    profile_id: uuid().notNull(),
    // ...
  },
  (table) => [
    foreignKey({
      columns: [table.profile_id],
      foreignColumns: [profiles.profile_id],
      name: "products_to_profiles",
    }).onDelete("cascade"),
  ]
);
```

**장점:**
- Foreign key 제약조건에 명시적인 이름 부여 (`products_to_profiles`)
- Supabase 관계 쿼리에서 이름으로 참조 가능
- 마이그레이션 관리 용이

### 2. 프로필 레이아웃 (`users/layouts/profile-layout.tsx`)

#### 주요 기능
- 프로필 헤더 (아바타, 이름, 역할, 배지)
- 탭 네비게이션 (About, Products, Posts)
- `loader`에서 프로필 데이터 로드
- `Outlet`을 통해 하위 페이지 렌더링

#### Loader 구현
```typescript
export const loader = async ({ params }: Route.LoaderArgs) => {
  const profile = await getUserProfile(params.username);
  
  if (!profile) {
    throw new Response("Profile not found", { status: 404 });
  }
  
  return {
    profile,
    headline: profile.headline || "",
    bio: profile.bio || "",
  };
};
```

#### 레이아웃 구조
```typescript
export default function ProfileLayout() {
  const { profile, headline, bio } = useLoaderData<typeof loader>();
  
  return (
    <div className="space-y-10">
      {/* 프로필 헤더 */}
      <div className="flex items-center gap-4">
        <Avatar>
          <AvatarImage src={profile.avatar} />
          <AvatarFallback>{profile.name[0]}</AvatarFallback>
        </Avatar>
        <div>
          <h1>{profile.name}</h1>
          <div>
            <span>@{profile.username}</span>
            <Badge>{profile.role}</Badge>
          </div>
        </div>
      </div>
      
      {/* 탭 네비게이션 */}
      <div className="flex gap-5">
        <NavLink to={`/users/${profile.username}`}>About</NavLink>
        <NavLink to={`/users/${profile.username}/products`}>Products</NavLink>
        <NavLink to={`/users/${profile.username}/posts`}>Posts</NavLink>
      </div>
      
      {/* 하위 페이지 */}
      <Outlet context={{ headline, bio }} />
    </div>
  );
}
```

### 3. 프로필 About 페이지 (`users/pages/profile-page.tsx`)

#### 변경 전
- 하드코딩된 데이터 사용
- 레이아웃과 분리되지 않음

#### 변경 후
- `useOutletContext`로 레이아웃에서 데이터 받기
- 동적 데이터 표시

```typescript
export default function ProfilePage() {
  const { headline, bio } = useOutletContext<{
    headline: string;
    bio: string;
  }>();
  
  return (
    <div className="space-y-10">
      <div>
        <h4>Headline</h4>
        <p>{headline}</p>
      </div>
      <div>
        <h4>Bio</h4>
        <p>{bio}</p>
      </div>
    </div>
  );
}
```

### 4. 프로필 Products 페이지 (`users/pages/profile-products-page.tsx`)

#### 변경 전
- 하드코딩된 더미 데이터 사용

#### 변경 후
- `loader`로 실제 DB 데이터 로드
- `getUserProducts` 쿼리 사용

```typescript
export const loader = async ({ params }: Route.LoaderArgs) => {
  const products = await getUserProducts(params.username);
  return { products };
};

export default function ProfileProductsPage({ loaderData }: Route.ComponentProps) {
  return (
    <div className="flex flex-col gap-5">
      {loaderData.products.map((product) => (
        <ProductCard
          key={product.product_id}
          id={product.product_id}
          name={product.name}
          description={product.tagline}
          reviewsCount={product.reviews}
          viewsCount={product.views}
          votesCount={product.upvotes}
        />
      ))}
    </div>
  );
}
```

### 5. 사용자 쿼리 함수 (`users/queries.ts`)

#### `getUserProfile`
```typescript
export const getUserProfile = async (username: string) => {
  const { data, error } = await client
    .from("profiles")
    .select(`
      profile_id,
      name,
      username,
      avatar,
      role,
      headline,
      bio
    `)
    .eq("username", username)
    .single();
  
  if (error) {
    throw error;
  }
  
  return data;
};
```

#### `getUserProducts`
```typescript
export const getUserProducts = async (username: string) => {
  const { data, error } = await client
    .from("products")
    .select(`
      ${productListSelect},
      profiles!products_to_profiles!inner (
        profile_id
      )
    `)
    .eq("profiles.username", username);
  
  if (error) {
    throw error;
  }
  
  return data;
};
```

**핵심 패턴:**
- `profiles!products_to_profiles!inner`: 명시적인 foreign key 이름으로 관계 조회
- `!inner`: INNER JOIN (해당 관계가 있는 데이터만)
- `eq("profiles.username", username)`: 관계된 테이블의 필드로 필터링

### 6. 라우팅 설정 (`routes.ts`)

```typescript
...prefix("/users/:username", [
  layout("features/users/layouts/profile-layout.tsx", [
    index("features/users/pages/profile-page.tsx"),
    route("/products", "features/users/pages/profile-products-page.tsx"),
    route("/posts", "features/users/pages/profile-posts-page.tsx"),
  ]),
]),
```

## 주요 패턴 요약

### 1. Foreign Key 명시적 정의
- Drizzle ORM에서 `foreignKey()` 함수로 명시적 정의
- 제약조건 이름 부여로 Supabase 관계 쿼리에서 참조 가능

### 2. 레이아웃 기반 프로필 페이지
- 공통 UI는 레이아웃에서 처리
- `loader`로 공통 데이터 로드
- `Outlet`과 `useOutletContext`로 하위 페이지에 데이터 전달

### 3. 관계 쿼리 패턴
```typescript
.select(`
  ${productListSelect},
  profiles!products_to_profiles!inner (
    profile_id
  )
`)
.eq("profiles.username", username)
```

### 4. 탭 네비게이션
- `NavLink`로 활성 상태 관리
- `end` prop으로 정확한 매칭

## 활용 방안

### 현재 프로젝트 적용 시 고려사항

1. **프로필 페이지 구조**
   - 현재 `profile-page.tsx`는 설정 페이지로 사용 중
   - 공개 프로필 페이지는 별도로 구현 필요 (`/users/:username`)

2. **쿼리 함수 추가**
   - `getUserProfile(username)` - username 기반 프로필 조회
   - `getUserProjects(username)` - 사용자의 프로젝트 목록
   - 필요시 `getUserPosts(username)` 추가

3. **프로필 레이아웃 생성**
   - 공개 프로필용 레이아웃 (`profile-layout.tsx`)
   - 프로필 헤더, 탭 네비게이션 포함

4. **라우팅 구조**
   ```
   /users/:username              → 프로필 About 페이지
   /users/:username/projects    → 프로필 Projects 페이지
   /users/:username/posts       → 프로필 Posts 페이지 (필요시)
   ```

5. **Foreign Key 제약조건**
   - `projects` 테이블의 `owner_profile_id`에 명시적 제약조건 추가
   - 관계 쿼리에서 참조 가능하도록 이름 부여

## 우선순위

### 높음 (즉시 적용 권장)
- ✅ Foreign Key 제약조건 명시적 정의 (마이그레이션 필요)
- ✅ `getUserProfile(username)` 쿼리 함수 추가
- ✅ `getUserProjects(username)` 쿼리 함수 추가

### 중간 (필요시 적용)
- 프로필 레이아웃 생성 (`/users/:username` 경로)
- 프로필 About 페이지 (현재 설정 페이지와 분리)
- 프로필 Projects 페이지

### 낮음 (선택적)
- 프로필 Posts 페이지 (커뮤니티 기능이 활성화된 경우)

