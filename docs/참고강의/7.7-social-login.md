# 7.7 Social Login

## 커밋 요약

소셜 로그인(OAuth) 기능을 구현한 커밋입니다. GitHub, Kakao 등의 소셜 프로바이더를 통해 사용자 인증을 처리하고, OAuth 플로우를 완료하는 두 개의 페이지(`social-start-page.tsx`, `social-complete-page.tsx`)를 구현했습니다. Supabase의 `signInWithOAuth`와 `exchangeCodeForSession` API를 활용하여 소셜 로그인을 처리합니다.

## 주요 변경사항

### 1. 소셜 로그인 시작 페이지 (`social-start-page.tsx`)

**역할**: OAuth 인증 플로우를 시작하고 사용자를 소셜 프로바이더로 리다이렉트합니다.

**구현 내용**:

```typescript
import { z } from "zod";
import { Route } from "./+types/social-start-page";
import { redirect } from "react-router";
import { makeSSRClient } from "~/supa-client";

const paramsSchema = z.object({
  provider: z.enum(["github", "kakao"]),
});

export const loader = async ({ params, request }: Route.LoaderArgs) => {
  // 1. provider 파라미터 검증
  const { success, data } = paramsSchema.safeParse(params);
  if (!success) {
    return redirect("/auth/login");
  }

  const { provider } = data;

  // 2. 콜백 URL 설정
  const redirectTo = `http://localhost:5173/auth/social/${provider}/complete`;

  // 3. SSR 클라이언트 생성
  const { client, headers } = makeSSRClient(request);

  // 4. OAuth URL 생성 및 리다이렉트
  const {
    data: { url },
    error,
  } = await client.auth.signInWithOAuth({
    provider,
    options: {
      redirectTo,
    },
  });

  if (url) {
    return redirect(url, { headers });
  }

  if (error) {
    throw error;
  }
};
```

**주요 포인트**:

- **Zod 검증**: `provider` 파라미터를 `github` 또는 `kakao`로 제한
- **콜백 URL 설정**: OAuth 인증 완료 후 돌아올 URL 지정
- **`signInWithOAuth`**: Supabase의 OAuth 인증 시작 API
- **헤더 전달**: 쿠키 설정을 위한 `headers` 객체를 리다이렉트에 포함

### 2. 소셜 로그인 완료 페이지 (`social-complete-page.tsx`)

**역할**: OAuth 콜백을 처리하고 인증 코드를 세션으로 교환합니다.

**구현 내용**:

```typescript
import { z } from "zod";
import { Route } from "./+types/social-complete-page";
import { redirect } from "react-router";
import { makeSSRClient } from "~/supa-client";

const paramsSchema = z.object({
  provider: z.enum(["github", "kakao"]),
});

export const loader = async ({ params, request }: Route.LoaderArgs) => {
  // 1. provider 파라미터 검증
  const { success } = paramsSchema.safeParse(params);
  if (!success) {
    return redirect("/auth/login");
  }

  // 2. URL에서 인증 코드 추출
  const url = new URL(request.url);
  const code = url.searchParams.get("code");

  if (!code) {
    return redirect("/auth/login");
  }

  // 3. SSR 클라이언트 생성
  const { client, headers } = makeSSRClient(request);

  // 4. 인증 코드를 세션으로 교환
  const { error } = await client.auth.exchangeCodeForSession(code);

  if (error) {
    throw error;
  }

  // 5. 홈으로 리다이렉트 (세션 쿠키 포함)
  return redirect("/", { headers });
};
```

**주요 포인트**:

- **인증 코드 추출**: URL의 `code` 쿼리 파라미터에서 추출
- **`exchangeCodeForSession`**: Supabase의 인증 코드를 세션으로 교환하는 API
- **세션 쿠키 설정**: `headers` 객체를 통해 쿠키를 설정하여 인증 상태 유지
- **에러 처리**: 인증 실패 시 에러를 throw하여 React Router의 에러 바운더리에서 처리

### 3. Supabase 클라이언트 개선 (`supa-client.ts`)

**변경사항**: 하드코딩된 Supabase URL과 키를 환경변수로 변경

**Before**:
```typescript
export const browserClient = createBrowserClient<Database>(
  "https://micuqwjpvmdexbwwpixv.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
);
```

**After**:
```typescript
export const browserClient = createBrowserClient<Database>(
  process.env.SUPABASE_URL!,
  process.env.SUPABASE_ANON_KEY!
);
```

**주요 포인트**:

- **환경변수 사용**: `process.env.SUPABASE_URL`과 `process.env.SUPABASE_ANON_KEY` 사용
- **보안**: 하드코딩된 키 제거로 보안 강화
- **유연성**: 환경별로 다른 Supabase 프로젝트 사용 가능

## OAuth 플로우

```
1. 사용자가 "/auth/social/start/github" 클릭
   ↓
2. social-start-page.tsx의 loader 실행
   ↓
3. signInWithOAuth() 호출 → GitHub OAuth URL 생성
   ↓
4. 사용자를 GitHub로 리다이렉트
   ↓
5. 사용자가 GitHub에서 인증 완료
   ↓
6. GitHub이 "/auth/social/github/complete?code=xxx"로 리다이렉트
   ↓
7. social-complete-page.tsx의 loader 실행
   ↓
8. exchangeCodeForSession(code) 호출 → 세션 생성
   ↓
9. "/"로 리다이렉트 (세션 쿠키 포함)
```

## 라우팅 설정

**파일**: `app/routes.ts`

```typescript
// 소셜 로그인 라우트
route("/auth/social/:provider/start", "features/auth/pages/social-start-page.tsx"),
route("/auth/social/:provider/complete", "features/auth/pages/social-complete-page.tsx"),
```

**URL 패턴**:
- 시작: `/auth/social/github/start`, `/auth/social/kakao/start`
- 완료: `/auth/social/github/complete`, `/auth/social/kakao/complete`

## Supabase 설정

### 1. OAuth 프로바이더 설정

Supabase 대시보드에서 각 프로바이더의 OAuth 앱을 등록하고 다음 정보를 설정해야 합니다:

- **GitHub**: Client ID, Client Secret, Redirect URL
- **Kakao**: REST API Key, Client Secret, Redirect URL

### 2. Redirect URL 설정

각 프로바이더의 OAuth 앱 설정에서 다음 Redirect URL을 등록해야 합니다:

```
http://localhost:5173/auth/social/github/complete
http://localhost:5173/auth/social/kakao/complete
```

프로덕션 환경에서는 실제 도메인으로 변경:

```
https://yourdomain.com/auth/social/github/complete
https://yourdomain.com/auth/social/kakao/complete
```

## 환경변수 설정

**파일**: `.env` 또는 `.env.local`

```bash
SUPABASE_URL=https://your-project.supabase.co
SUPABASE_ANON_KEY=your-anon-key
```

## 에러 처리

### 1. 잘못된 Provider

```typescript
const { success } = paramsSchema.safeParse(params);
if (!success) {
  return redirect("/auth/login");
}
```

- `provider`가 `github` 또는 `kakao`가 아닌 경우 로그인 페이지로 리다이렉트

### 2. 인증 코드 누락

```typescript
const code = url.searchParams.get("code");
if (!code) {
  return redirect("/auth/login");
}
```

- OAuth 콜백에 `code` 파라미터가 없는 경우 로그인 페이지로 리다이렉트

### 3. 세션 교환 실패

```typescript
const { error } = await client.auth.exchangeCodeForSession(code);
if (error) {
  throw error;
}
```

- `exchangeCodeForSession` 실패 시 에러를 throw하여 React Router의 에러 바운더리에서 처리

## 보안 고려사항

### 1. CSRF 보호

Supabase의 `signInWithOAuth`는 내부적으로 CSRF 토큰을 생성하여 보호합니다. `exchangeCodeForSession`에서 이 토큰을 검증합니다.

### 2. 상태 검증

OAuth 플로우에서 `state` 파라미터를 사용하여 CSRF 공격을 방지할 수 있습니다. Supabase는 이를 자동으로 처리합니다.

### 3. 쿠키 보안

`makeSSRClient`에서 생성된 `headers` 객체를 통해 쿠키를 안전하게 설정합니다. 프로덕션 환경에서는 `Secure`, `HttpOnly`, `SameSite` 옵션을 설정해야 합니다.

## 사용 예시

### 로그인 페이지에서 소셜 로그인 버튼

```typescript
import { Link } from "react-router";

export function SocialLoginButtons() {
  return (
    <>
      <Link to="/auth/social/start/github">
        <Button>GitHub로 로그인</Button>
      </Link>
      <Link to="/auth/social/start/kakao">
        <Button>Kakao로 로그인</Button>
      </Link>
    </>
  );
}
```

## 테스트 체크리스트

- [ ] GitHub OAuth 로그인 성공
- [ ] Kakao OAuth 로그인 성공
- [ ] 잘못된 provider 파라미터 처리
- [ ] 인증 코드 누락 시 처리
- [ ] 세션 교환 실패 시 에러 처리
- [ ] 로그인 후 홈으로 리다이렉트 확인
- [ ] 세션 쿠키 설정 확인
- [ ] 프로덕션 환경 Redirect URL 설정

## 참고 자료

- [Supabase OAuth 문서](https://supabase.com/docs/guides/auth/social-login)
- [React Router redirect 문서](https://reactrouter.com/en/main/fetch/redirect)
- [Zod 검증 문서](https://zod.dev/)

