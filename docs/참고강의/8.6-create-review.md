# 8.6 Create Review

## 커밋 요약

제품 리뷰 생성 기능을 구현한 커밋입니다. Dialog 컴포넌트를 사용한 모달 폼, `useActionData` + `useEffect`로 다이얼로그 자동 닫기, Form 에러 메시지 표시, Zod 검증, Mutations 분리 등의 패턴을 보여줍니다.

## 주요 변경사항

### 1. Mutations에 리뷰 생성 함수 추가

**구현**:
```typescript
// app/features/products/mutations.ts
export const createProductReview = async (
  client: SupabaseClient<Database>,
  {
    productId,
    review,
    rating,
    userId,
  }: { productId: string; review: string; rating: number; userId: string }
) => {
  const { error } = await client.from("reviews").insert({
    product_id: +productId, // 문자열을 숫자로 변환
    review,
    rating,
    profile_id: userId,
  });

  if (error) {
    throw error;
  }
};
```

**패턴**:
- 간단한 insert 작업
- `+productId`로 문자열을 숫자로 변환
- 에러는 그대로 throw하여 상위에서 처리

### 2. Action 함수 구현 (Zod 검증)

**구현**:
```typescript
const formSchema = z.object({
  review: z.string().min(1),
  rating: z.coerce.number().min(1).max(5),
});

export const action = async ({ request, params }: Route.ActionArgs) => {
  const { client } = makeSSRClient(request);
  const userId = await getLoggedInUserId(client);

  const formData = await request.formData();
  const { success, error, data } = formSchema.safeParse(
    Object.fromEntries(formData)
  );

  if (!success) {
    return {
      formErrors: error.flatten().fieldErrors,
    };
  }

  await createProductReview(client, {
    productId: params.productId,
    review: data.review,
    rating: data.rating,
    userId,
  });

  return {
    ok: true,
  };
};
```

**패턴**:
- `z.coerce.number()`로 문자열을 숫자로 자동 변환
- `min(1).max(5)`로 범위 검증
- 에러는 `formErrors`로 반환
- 성공 시 `{ ok: true }` 반환 (리다이렉트 없이 같은 페이지 유지)

### 3. Dialog 자동 닫기 패턴 (`useActionData` + `useEffect`)

**구현**:
```typescript
import { useActionData } from "react-router";
import { useEffect, useState } from "react";

export default function ProductReviewsPage({
  loaderData,
  actionData,
}: Route.ComponentProps) {
  const [open, setOpen] = useState(false);

  useEffect(() => {
    if (actionData?.ok) {
      setOpen(false); // 리뷰 작성 성공 시 다이얼로그 자동 닫기
    }
  }, [actionData]);

  return (
    <Dialog open={open} onOpenChange={setOpen}>
      {/* ... */}
    </Dialog>
  );
}
```

**패턴**:
- `useActionData`로 action 결과 확인
- `useEffect`로 `actionData.ok`가 `true`일 때 다이얼로그 닫기
- 리뷰 작성 성공 시 자동으로 다이얼로그 닫힘

**장점**:
- 사용자 경험 개선 (제출 후 자동 닫힘)
- 상태 동기화 자동화
- 수동으로 닫을 필요 없음

### 4. Form에 `method="post"` 명시

**구현**:
```typescript
<Form className="space-y-10" method="post">
  {/* 폼 내용 */}
</Form>
```

**패턴**: POST 요청 보장

### 5. Form 에러 메시지 표시

**구현**:
```typescript
{actionData?.formErrors?.rating && (
  <p className="text-red-500">
    {actionData.formErrors.rating.join(", ")}
  </p>
)}

{actionData?.formErrors?.review && (
  <p className="text-red-500">
    {actionData.formErrors.review.join(", ")}
  </p>
)}
```

**패턴**:
- `actionData.formErrors`에서 필드별 에러 확인
- `join(", ")`로 여러 에러 메시지 결합
- 빨간색 텍스트로 시각적 피드백 제공

**장점**:
- 사용자에게 명확한 에러 피드백
- 필드별 에러 표시 가능

### 6. 스키마 개선 (NOT NULL 제약조건 명시)

**변경 전**:
```typescript
product_id: bigint({ mode: "number" }).references(
  () => products.product_id,
  {
    onDelete: "cascade",
  }
),
profile_id: uuid().references(() => profiles.profile_id, {
  onDelete: "cascade",
}),
```

**변경 후**:
```typescript
product_id: bigint({ mode: "number" })
  .references(() => products.product_id, {
    onDelete: "cascade",
  })
  .notNull(),
profile_id: uuid()
  .references(() => profiles.profile_id, {
    onDelete: "cascade",
  })
  .notNull(),
```

**패턴**: NOT NULL 제약조건 명시로 데이터 무결성 보장

### 7. Queries에 정렬 추가

**변경**:
```typescript
.eq("product_id", productId)
.order("created_at", { ascending: false }); // 최신 리뷰부터 표시
```

**장점**: 최신 리뷰부터 표시

## 적용 방안

### ✅ 이미 적용된 패턴

1. **Mutations 파일 분리**: `app/features/projects/mutations.ts` 생성 완료
2. **`getLoggedInUserId` 사용**: 여러 파일에서 이미 적용됨
3. **Zod 검증**: 여러 페이지에서 사용 중
4. **Action 함수 패턴**: 여러 페이지에서 사용 중
5. **Form에 `method="post"` 명시**: 일부 Form에서 사용 중

### 🔄 추가로 적용 가능한 패턴

#### 1. Dialog 자동 닫기 패턴 (`useActionData` + `useEffect`) (우선순위: 높음)

**현재 상태**: 일부 Dialog에서만 적용

**적용 방안**:
```typescript
const [open, setOpen] = useState(false);
const actionData = useActionData<typeof action>();

useEffect(() => {
  if (actionData?.ok || actionData?.success) {
    setOpen(false);
  }
}, [actionData]);
```

**적용 대상**:
- 프로젝트 생성/수정 다이얼로그
- 폼 제출 후 닫아야 하는 모든 다이얼로그
- 모달 폼

**장점**:
- 사용자 경험 개선
- 상태 동기화 자동화

#### 2. Form 에러 메시지 표시 패턴 (우선순위: 중간)

**현재 상태**: 일부 Form에서만 에러 메시지 표시

**적용 방안**:
```typescript
{actionData?.formErrors?.fieldName && (
  <p className="text-red-500 text-sm mt-1">
    {actionData.formErrors.fieldName.join(", ")}
  </p>
)}
```

**적용 대상**:
- 모든 Form 컴포넌트
- 검증이 필요한 입력 필드

**장점**:
- 사용자에게 명확한 피드백
- 필드별 에러 표시 가능

#### 3. 스키마에 NOT NULL 제약조건 명시 (우선순위: 낮음)

**현재 상태**: 일부 스키마에서만 명시

**적용 방안**: 필수 필드에 `.notNull()` 추가

**장점**: 데이터 무결성 보장

#### 4. Queries에 정렬 추가 (우선순위: 낮음)

**현재 상태**: 일부 쿼리에 정렬이 없을 수 있음

**적용 방안**: 목록 조회 시 항상 정렬 명시

**예시**:
```typescript
.order("created_at", { ascending: false }) // 최신순
.order("created_at", { ascending: true })  // 오래된순
```

**장점**: 일관된 데이터 순서 보장

## 구현 우선순위

### 높음 (즉시 적용 권장)

1. **Dialog 자동 닫기 패턴 (`useActionData` + `useEffect`)**
   - 영향도: 높음 (UX 개선)
   - 난이도: 낮음
   - 효과: 사용자 경험 향상, 상태 동기화 자동화

### 중간 (점진적 적용)

2. **Form 에러 메시지 표시 패턴**
   - 영향도: 중간 (UX 개선)
   - 난이도: 낮음
   - 효과: 사용자 피드백 개선

### 낮음 (선택사항)

3. **스키마에 NOT NULL 제약조건 명시**
   - 영향도: 낮음 (데이터 무결성)
   - 난이도: 매우 낮음
   - 효과: 데이터 무결성 보장

4. **Queries에 정렬 추가**
   - 영향도: 낮음 (데이터 일관성)
   - 난이도: 매우 낮음
   - 효과: 일관된 데이터 순서

## 참고사항

- Dialog 자동 닫기는 `useActionData`와 함께 사용해야 함
- Form 에러 메시지는 `actionData.formErrors` 구조를 따라야 함
- `z.coerce.number()`는 Form 데이터(항상 문자열)를 숫자로 변환할 때 유용함
- `{ ok: true }` 반환은 리다이렉트가 필요 없는 경우에만 사용

