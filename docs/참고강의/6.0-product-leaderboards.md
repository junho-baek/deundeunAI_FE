# 6.0 Product Leaderboards

## 커밋 개요

이 커밋은 제품 리더보드 기능을 구현합니다. 날짜 범위 기반 쿼리를 사용하여 일/주/월/년별 인기 제품을 조회하고, JSONB 필드에서 통계 데이터를 추출하여 표시합니다. 병렬 데이터 로딩을 통해 성능을 최적화합니다.

## 주요 변경사항

### 1. 날짜 범위 기반 쿼리 함수 생성

**새 파일: `app/features/products/queries.ts`**

```typescript
import { DateTime } from "luxon";
import client from "~/supa-client";

export const getProductsByDateRange = async ({
  startDate,
  endDate,
  limit,
}: {
  startDate: DateTime;
  endDate: DateTime;
  limit: number;
}) => {
  const { data, error } = await client
    .from("products")
    .select(
      `
        product_id,
        name,
        description,
        upvotes:stats->>upvotes,
        views:stats->>views,
        reviews:stats->>reviews
    `
    )
    .order("stats->>upvotes", { ascending: false })
    .gte("created_at", startDate.toISO())
    .lte("created_at", endDate.toISO())
    .limit(limit);

  if (error) throw error;
  return data;
};
```

**핵심 포인트:**

- **날짜 범위 필터링**: `gte()`와 `lte()`로 시작일/종료일 필터링
- **JSONB 필드 추출**: `stats->>upvotes`로 JSONB에서 값 추출
- **정렬**: `order()`로 upvotes 기준 내림차순 정렬
- **제한**: `limit()`로 결과 개수 제한

### 2. 홈 페이지에 제품 데이터 로드

**변경된 파일: `app/common/pages/home-page.tsx`**

**Before (Mock 데이터):**

```typescript
export default function HomePage() {
  return (
    <div>
      {Array.from({ length: 11 }).map((_, index) => (
        <ProductCard
          key={`productId-${index}`}
          id={`productId-${index}`}
          name="Product Name"
          description="Product Description"
          commentsCount={12}
          viewsCount={12}
          votesCount={120}
        />
      ))}
    </div>
  );
}
```

**After (실제 데이터):**

```typescript
import { getProductsByDateRange } from "~/features/products/queries";
import { DateTime } from "luxon";

export const loader = async () => {
  const products = await getProductsByDateRange({
    startDate: DateTime.now().startOf("day"),
    endDate: DateTime.now().endOf("day"),
    limit: 7,
  });
  return { products };
};

export default function HomePage({ loaderData }: Route.ComponentProps) {
  return (
    <div>
      {loaderData.products.map((product) => (
        <ProductCard
          key={product.product_id}
          id={product.product_id.toString()}
          name={product.name}
          description={product.description}
          reviewsCount={product.reviews}
          viewsCount={product.views}
          votesCount={product.upvotes}
        />
      ))}
    </div>
  );
}
```

**핵심 포인트:**

- **Loader 함수**: 서버에서 오늘 날짜의 제품 데이터 로드
- **DateTime 사용**: `startOf("day")`와 `endOf("day")`로 하루 범위 설정
- **실제 데이터**: Mock 데이터를 실제 DB 데이터로 교체

### 3. 리더보드 페이지 구현

**변경된 파일: `app/features/products/pages/leaderboard-page.tsx`**

```typescript
export const loader = async () => {
  const [dailyProducts, weeklyProducts, monthlyProducts, yearlyProducts] =
    await Promise.all([
      getProductsByDateRange({
        startDate: DateTime.now().startOf("day"),
        endDate: DateTime.now().endOf("day"),
        limit: 7,
      }),
      getProductsByDateRange({
        startDate: DateTime.now().startOf("week"),
        endDate: DateTime.now().endOf("week"),
        limit: 7,
      }),
      getProductsByDateRange({
        startDate: DateTime.now().startOf("month"),
        endDate: DateTime.now().endOf("month"),
        limit: 7,
      }),
      getProductsByDateRange({
        startDate: DateTime.now().startOf("year"),
        endDate: DateTime.now().endOf("year"),
        limit: 7,
      }),
    ]);

  return { dailyProducts, weeklyProducts, monthlyProducts, yearlyProducts };
};
```

**핵심 포인트:**

- **병렬 로딩**: `Promise.all()`로 4개 기간의 데이터를 동시에 로드
- **다양한 기간**: 일/주/월/년별로 데이터 조회
- **DateTime 메서드**: `startOf()`와 `endOf()`로 기간 설정

### 4. JSONB 필드에서 데이터 추출

**Supabase 쿼리 패턴:**

```typescript
.select(`
  product_id,
  name,
  description,
  upvotes:stats->>upvotes,    // JSONB에서 upvotes 추출
  views:stats->>views,        // JSONB에서 views 추출
  reviews:stats->>reviews     // JSONB에서 reviews 추출
`)
```

**핵심 포인트:**

- `stats->>upvotes`: JSONB 필드에서 텍스트로 추출
- `stats->upvotes`: JSONB 필드에서 JSON 객체로 추출 (필요시)
- 별칭 사용: `upvotes:stats->>upvotes`로 필드명 변경

### 5. 스키마 업데이트

**변경된 파일: `app/features/products/schema.ts`**

```typescript
// Before
stats: jsonb().notNull().default({ views: 0, reviews: 0 }),

// After
stats: jsonb().notNull().default({ views: 0, reviews: 0, upvotes: 0 }),
```

**마이그레이션 파일: `0009_medical_silver_samurai.sql`**

```sql
ALTER TABLE "products" 
ALTER COLUMN "stats" 
SET DEFAULT '{"views":0,"reviews":0,"upvotes":0}'::jsonb;
```

**핵심 포인트:**

- JSONB 기본값에 `upvotes` 필드 추가
- 마이그레이션으로 기존 데이터와 호환성 유지

### 6. ProductCard 컴포넌트 타입 변경

**변경된 파일: `app/features/products/components/product-card.tsx`**

```typescript
// Before
interface ProductCardProps {
  commentsCount: number;
  viewsCount: number;
  votesCount: number;
}

// After
interface ProductCardProps {
  reviewsCount: string;  // JSONB에서 추출된 값은 문자열
  viewsCount: string;
  votesCount: string;
}
```

**핵심 포인트:**

- JSONB에서 추출된 값은 문자열 타입
- 타입 안전성을 위해 명시적 타입 지정

## 우리 프로젝트에 적용하기

### 현재 상태 분석

우리 프로젝트는 현재:

- ✅ React Router 7 사용 중
- ✅ Loader 함수 사용 중
- ✅ Supabase Client 사용 중
- ❌ 날짜 범위 기반 쿼리 미사용
- ❌ JSONB 필드 추출 미사용
- ❌ 리더보드 기능 미구현

### 적용 전략

#### 1단계: 날짜 범위 쿼리 함수 이해

**DateTime 사용:**

```typescript
import { DateTime } from "luxon";

// 오늘
const today = DateTime.now().startOf("day");
const endOfToday = DateTime.now().endOf("day");

// 이번 주
const weekStart = DateTime.now().startOf("week");
const weekEnd = DateTime.now().endOf("week");

// 이번 달
const monthStart = DateTime.now().startOf("month");
const monthEnd = DateTime.now().endOf("month");

// 올해
const yearStart = DateTime.now().startOf("year");
const yearEnd = DateTime.now().endOf("year");
```

**Supabase 날짜 필터링:**

```typescript
.gte("created_at", startDate.toISO())  // 이상 (Greater Than or Equal)
.lte("created_at", endDate.toISO())   // 이하 (Less Than or Equal)
```

#### 2단계: 프로젝트 리더보드 구현

**파일: `app/features/projects/queries.ts`**

```typescript
import { DateTime } from "luxon";
import client from "~/lib/supa-client";

/**
 * 날짜 범위로 프로젝트 조회 (리더보드용)
 * @param startDate - 시작 날짜
 * @param endDate - 종료 날짜
 * @param limit - 최대 조회 개수
 * @param orderBy - 정렬 기준 (기본값: "likes")
 * @returns 프로젝트 목록
 */
export async function getProjectsByDateRange({
  startDate,
  endDate,
  limit,
  orderBy = "likes",
}: {
  startDate: DateTime;
  endDate: DateTime;
  limit: number;
  orderBy?: "likes" | "views" | "ctr" | "budget";
}) {
  const { data, error } = await client
    .from("projects")
    .select(`
      project_id,
      title,
      description,
      thumbnail,
      likes,
      views,
      ctr,
      budget,
      created_at
    `)
    .order(orderBy, { ascending: false })
    .gte("created_at", startDate.toISO())
    .lte("created_at", endDate.toISO())
    .limit(limit);

  if (error) {
    console.error("프로젝트 리더보드 조회 실패:", error);
    throw new Error(`프로젝트를 불러오는데 실패했습니다: ${error.message}`);
  }

  return data ?? [];
}
```

#### 3단계: 프로젝트 리더보드 페이지 생성

**파일: `app/features/projects/pages/project-leaderboard-page.tsx`**

```typescript
import { type LoaderFunctionArgs, type MetaFunction, useLoaderData } from "react-router";
import type { Route } from "./+types/project-leaderboard-page";
import { getProjectsByDateRange } from "../queries";
import { DateTime } from "luxon";
import ProjectCard from "~/features/projects/components/project-card";

export const meta: MetaFunction = () => {
  return [
    {
      title: "든든AI - 프로젝트 리더보드",
    },
    {
      name: "description",
      content: "인기 프로젝트를 일/주/월/년별로 확인하세요.",
    },
  ];
};

export async function loader({ request }: LoaderFunctionArgs) {
  // 병렬로 모든 기간의 데이터 로드
  const [dailyProjects, weeklyProjects, monthlyProjects, yearlyProjects] =
    await Promise.all([
      getProjectsByDateRange({
        startDate: DateTime.now().startOf("day"),
        endDate: DateTime.now().endOf("day"),
        limit: 10,
        orderBy: "likes",
      }),
      getProjectsByDateRange({
        startDate: DateTime.now().startOf("week"),
        endDate: DateTime.now().endOf("week"),
        limit: 10,
        orderBy: "likes",
      }),
      getProjectsByDateRange({
        startDate: DateTime.now().startOf("month"),
        endDate: DateTime.now().endOf("month"),
        limit: 10,
        orderBy: "likes",
      }),
      getProjectsByDateRange({
        startDate: DateTime.now().startOf("year"),
        endDate: DateTime.now().endOf("year"),
        limit: 10,
        orderBy: "likes",
      }),
    ]);

  return {
    dailyProjects,
    weeklyProjects,
    monthlyProjects,
    yearlyProjects,
  };
}

export default function ProjectLeaderboardPage({
  loaderData,
}: Route.ComponentProps) {
  const { dailyProjects, weeklyProjects, monthlyProjects, yearlyProjects } =
    loaderData;

  return (
    <section className="mx-auto flex h-full min-h-0 w-full max-w-6xl flex-col overflow-hidden">
      <div className="flex-1 min-h-0 overflow-y-auto px-6 py-8 md:px-10">
        <div className="flex flex-col gap-12 pb-12">
          {/* 일간 리더보드 */}
          <div>
            <h2 className="mb-4 text-2xl font-bold">오늘의 인기 프로젝트</h2>
            <div className="grid gap-6 grid-cols-[repeat(auto-fit,minmax(220px,220px))]">
              {dailyProjects.map((project) => (
                <ProjectCard
                  key={project.project_id}
                  id={project.project_id}
                  to={`/my/dashboard/project/${project.project_id}/analytics`}
                  title={project.title}
                  description={project.description || undefined}
                  likes={formatNumber(project.likes || 0)}
                  ctr={formatCTR(project.ctr)}
                  budget={formatBudget(project.budget)}
                  thumbnail={project.thumbnail || undefined}
                />
              ))}
            </div>
          </div>

          {/* 주간 리더보드 */}
          <div>
            <h2 className="mb-4 text-2xl font-bold">이번 주 인기 프로젝트</h2>
            <div className="grid gap-6 grid-cols-[repeat(auto-fit,minmax(220px,220px))]">
              {weeklyProjects.map((project) => (
                <ProjectCard
                  key={project.project_id}
                  id={project.project_id}
                  to={`/my/dashboard/project/${project.project_id}/analytics`}
                  title={project.title}
                  description={project.description || undefined}
                  likes={formatNumber(project.likes || 0)}
                  ctr={formatCTR(project.ctr)}
                  budget={formatBudget(project.budget)}
                  thumbnail={project.thumbnail || undefined}
                />
              ))}
            </div>
          </div>

          {/* 월간 리더보드 */}
          <div>
            <h2 className="mb-4 text-2xl font-bold">이번 달 인기 프로젝트</h2>
            <div className="grid gap-6 grid-cols-[repeat(auto-fit,minmax(220px,220px))]">
              {monthlyProjects.map((project) => (
                <ProjectCard
                  key={project.project_id}
                  id={project.project_id}
                  to={`/my/dashboard/project/${project.project_id}/analytics`}
                  title={project.title}
                  description={project.description || undefined}
                  likes={formatNumber(project.likes || 0)}
                  ctr={formatCTR(project.ctr)}
                  budget={formatBudget(project.budget)}
                  thumbnail={project.thumbnail || undefined}
                />
              ))}
            </div>
          </div>

          {/* 연간 리더보드 */}
          <div>
            <h2 className="mb-4 text-2xl font-bold">올해 인기 프로젝트</h2>
            <div className="grid gap-6 grid-cols-[repeat(auto-fit,minmax(220px,220px))]">
              {yearlyProjects.map((project) => (
                <ProjectCard
                  key={project.project_id}
                  id={project.project_id}
                  to={`/my/dashboard/project/${project.project_id}/analytics`}
                  title={project.title}
                  description={project.description || undefined}
                  likes={formatNumber(project.likes || 0)}
                  ctr={formatCTR(project.ctr)}
                  budget={formatBudget(project.budget)}
                  thumbnail={project.thumbnail || undefined}
                />
              ))}
            </div>
          </div>
        </div>
      </div>
    </section>
  );
}

// 헬퍼 함수들
function formatNumber(num: number): string {
  if (num >= 1000) {
    return `${(num / 1000).toFixed(0)}K`;
  }
  return num.toString();
}

function formatCTR(ctr: number | null | undefined): string | undefined {
  if (ctr === null || ctr === undefined) return undefined;
  return `Top${Math.round(ctr * 100)}%`;
}

function formatBudget(budget: number | null | undefined): string | undefined {
  if (budget === null || budget === undefined) return undefined;
  if (budget >= 100000) return "High";
  if (budget >= 50000) return "Medium";
  return "Low";
}
```

#### 4단계: JSONB 필드 사용 (선택사항)

**만약 프로젝트에 JSONB 필드가 있다면:**

```typescript
// 스키마에 JSONB 필드 추가
export const projects = pgTable("projects", {
  // ... 기존 필드들
  stats: jsonb().notNull().default({
    likes: 0,
    views: 0,
    ctr: 0,
    budget: 0,
  }),
});

// 쿼리에서 JSONB 필드 추출
const { data, error } = await client
  .from("projects")
  .select(`
    project_id,
    title,
    likes:stats->>likes,
    views:stats->>views,
    ctr:stats->>ctr,
    budget:stats->>budget
  `);
```

## 날짜 범위 쿼리 패턴

### 기본 패턴

```typescript
export async function getDataByDateRange({
  startDate,
  endDate,
  limit,
}: {
  startDate: DateTime;
  endDate: DateTime;
  limit: number;
}) {
  const { data, error } = await client
    .from("table_name")
    .select("*")
    .gte("created_at", startDate.toISO())
    .lte("created_at", endDate.toISO())
    .limit(limit);

  if (error) throw error;
  return data;
}
```

### 다양한 기간 설정

```typescript
import { DateTime } from "luxon";

// 오늘
const today = {
  start: DateTime.now().startOf("day"),
  end: DateTime.now().endOf("day"),
};

// 이번 주
const thisWeek = {
  start: DateTime.now().startOf("week"),
  end: DateTime.now().endOf("week"),
};

// 이번 달
const thisMonth = {
  start: DateTime.now().startOf("month"),
  end: DateTime.now().endOf("month"),
};

// 올해
const thisYear = {
  start: DateTime.now().startOf("year"),
  end: DateTime.now().endOf("year"),
};

// 지난 7일
const last7Days = {
  start: DateTime.now().minus({ days: 7 }).startOf("day"),
  end: DateTime.now().endOf("day"),
};

// 지난 30일
const last30Days = {
  start: DateTime.now().minus({ days: 30 }).startOf("day"),
  end: DateTime.now().endOf("day"),
};
```

### 정렬 옵션

```typescript
// 좋아요 순
.order("likes", { ascending: false })

// 조회수 순
.order("views", { ascending: false })

// CTR 순
.order("ctr", { ascending: false })

// 예산 순
.order("budget", { ascending: false })

// 생성일 순
.order("created_at", { ascending: false })
```

## JSONB 필드 사용 패턴

### JSONB 필드 추출

```typescript
// 텍스트로 추출 (->>)
.select(`
  upvotes:stats->>upvotes,    // 문자열 반환
  views:stats->>views,
  reviews:stats->>reviews
`)

// JSON 객체로 추출 (->)
.select(`
  stats:stats->stats_object,  // JSON 객체 반환
  metadata:stats->metadata
`)
```

### JSONB 필드 업데이트

```typescript
// 특정 필드만 업데이트
await client
  .from("products")
  .update({
    stats: {
      upvotes: 100,
      views: 500,
      reviews: 20,
    },
  })
  .eq("product_id", productId);

// 또는 JSONB 연산자 사용
await client.rpc("increment_upvotes", { product_id: productId });
```

## 병렬 데이터 로딩 패턴

### Promise.all 사용

```typescript
export async function loader() {
  const [daily, weekly, monthly, yearly] = await Promise.all([
    getDataByDateRange({ startDate: todayStart, endDate: todayEnd }),
    getDataByDateRange({ startDate: weekStart, endDate: weekEnd }),
    getDataByDateRange({ startDate: monthStart, endDate: monthEnd }),
    getDataByDateRange({ startDate: yearStart, endDate: yearEnd }),
  ]);

  return { daily, weekly, monthly, yearly };
}
```

### Promise.allSettled 사용 (에러 허용)

```typescript
export async function loader() {
  const results = await Promise.allSettled([
    getDataByDateRange({ startDate: todayStart, endDate: todayEnd }),
    getDataByDateRange({ startDate: weekStart, endDate: weekEnd }),
    getDataByDateRange({ startDate: monthStart, endDate: monthEnd }),
    getDataByDateRange({ startDate: yearStart, endDate: yearEnd }),
  ]);

  return {
    daily: results[0].status === "fulfilled" ? results[0].value : [],
    weekly: results[1].status === "fulfilled" ? results[1].value : [],
    monthly: results[2].status === "fulfilled" ? results[2].value : [],
    yearly: results[3].status === "fulfilled" ? results[3].value : [],
  };
}
```

## 장단점 비교

### 날짜 범위 쿼리 장점

- ✅ **유연한 필터링**: 다양한 기간으로 데이터 조회 가능
- ✅ **성능 최적화**: 필요한 기간만 조회하여 성능 향상
- ✅ **사용자 경험**: 시간대별 인기 콘텐츠 제공

### 날짜 범위 쿼리 단점

- ❌ **인덱스 필요**: `created_at` 필드에 인덱스 필요
- ❌ **타임존 처리**: 타임존 고려 필요
- ❌ **복잡성 증가**: 날짜 계산 로직 필요

### JSONB 필드 장점

- ✅ **유연한 스키마**: 동적 필드 추가 가능
- ✅ **성능**: 단일 컬럼에 여러 데이터 저장
- ✅ **확장성**: 새로운 통계 필드 추가 용이

### JSONB 필드 단점

- ❌ **타입 안전성**: 런타임에만 검증 가능
- ❌ **쿼리 복잡성**: JSONB 연산자 사용 필요
- ❌ **인덱싱**: JSONB 필드 인덱싱 복잡

## 주의사항

1. **타임존 처리**
   - 서버와 클라이언트의 타임존 일치 확인
   - `DateTime`의 타임존 설정 확인

2. **인덱스 최적화**
   - `created_at` 필드에 인덱스 생성
   - JSONB 필드에도 인덱스 고려

3. **성능 고려**
   - 병렬 로딩으로 성능 최적화
   - 적절한 `limit` 설정

4. **에러 처리**
   - 날짜 범위가 유효한지 검증
   - JSONB 필드가 존재하는지 확인

5. **타입 안전성**
   - JSONB에서 추출된 값의 타입 명시
   - TypeScript 타입 정의

## 다음 단계

1. ✅ 날짜 범위 쿼리 패턴 이해
2. ✅ JSONB 필드 추출 패턴 학습
3. ⏳ 프로젝트 리더보드 구현
4. ⏳ 홈 페이지에 인기 프로젝트 표시
5. ⏳ 다양한 정렬 옵션 추가
6. ⏳ 필터링 기능 추가
7. ⏳ 캐싱 전략 구현

## 참고 자료

- [Luxon DateTime 문서](https://moment.github.io/luxon/#/parsing)
- [Supabase 날짜 필터링](https://supabase.com/docs/reference/javascript/filter)
- [Supabase JSONB 연산자](https://supabase.com/docs/reference/javascript/using-filters#jsonb-operators)
- [PostgreSQL JSONB 가이드](https://www.postgresql.org/docs/current/datatype-json.html)

