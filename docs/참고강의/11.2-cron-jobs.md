# 11.2 CRON Jobs

## 커밋 요약

아이디어 생성 엔드포인트를 loader → action으로 전환해 HTTP POST 전용 서버 액션으로 만들었습니다. Cron 서비스만 접근할 수 있도록 커스텀 헤더 검증을 추가해 예약 실행이 가능해졌습니다.

## 주요 변경사항

### 1. Loader → Action 전환

**구현**:
```typescript
// app/features/ideas/pages/generate-idea-page.tsx
import { Route } from "./+types/generate-idea-page";

export const action = async ({ request }: Route.ActionArgs) => {
  if (request.method !== "POST") {
    return new Response(null, { status: 404 });
  }
  // ...
};
```

**패턴**:
- `Route.ActionArgs`를 사용해 Remix Action으로 전환
- GET이 아닌 POST만 허용해 Cron 트리거를 명시적으로 표현
- 잘못된 메서드는 404로 응답해 엔드포인트 존재 자체를 숨김

**장점**:
- 브라우저 요청과 분리된 서버 전용 엔드포인트 확보
- Cron 서비스가 HTTP POST를 호출해도 Remix 라우팅과 충돌 없음

### 2. 시크릿 헤더 검증

**구현**:
```typescript
const header = request.headers.get("X-POTATO");
if (!header || header !== "X-TOMATO") {
  return new Response(null, { status: 404 });
}
```

**패턴**:
- Cron 호출 시 임의 헤더(`X-POTATO`)에 사전 공유 키(`X-TOMATO`)를 넣어 인증
- 조건 불일치 시 404 반환으로 모의 크롤링 방지

**장점**:
- 별도 인증 서버 없이도 간단히 비공개 엔드포인트 보호
- 헤더 키/값만 환경 변수로 바꾸면 회전(rotating secret) 용이

### 3. Cron 실행 시나리오

1. 호스팅 플랫폼(Vercel, Supabase Scheduler 등)에 HTTP Cron Job 작성  
2. URL: `/ideas/generate`  
3. 메서드: `POST`  
4. 헤더: `X-POTATO: X-TOMATO` (실제 서비스에서는 .env 값 사용 권장)  
5. 주기 설정(예: `0 */6 * * *` 로 6시간마다 실행)

실행 흐름:
1. Cron 서비스가 정해진 간격으로 POST 요청 전송
2. Action에서 메서드와 헤더 검증
3. 검증 통과 시 OpenAI 호출 → Supabase `gpt_ideas` 테이블에 insert
4. 응답은 JSON `{ ok: true }` 또는 404

## 적용 방안

1. **환경 변수화**  
   - `X-POTATO`, `X-TOMATO` 값을 `.env`로 이동해 배포마다 다른 시크릿을 적용.

2. **여러 Cron 엔드포인트 표준화**  
   - 공통 헬퍼(`assertCronRequest(request, envKeyName)`)를 만들어 같은 패턴을 재사용하면 코드 중복 감소.

3. **실패 모니터링 추가**  
   - Cron 서비스에서 200 이외 응답을 모니터링하거나 Sentry 로그를 남겨 GPT 호출 실패를 추적.

4. **Rate Limit 고려**  
   - 동시 Cron 실행을 막으려면 Supabase 락 테이블이나 Redis 락을 이용해 재진입을 제어.

