# 8.13 Upvotes

## 커밋 요약

업보트(Upvote) 기능의 UI 표시를 구현한 커밋입니다. SQL View에서 현재 사용자의 업보트 상태 조회, 조건부 스타일링, 컴포넌트에 상태 prop 전달 등의 패턴을 보여줍니다.

## 주요 변경사항

### 1. SQL View에 업보트 상태 필드 추가

**구현**:
```sql
-- community-post-detail.sql
(SELECT EXISTS (
  SELECT 1 
  FROM public.post_upvotes 
  WHERE post_upvotes.post_id = posts.post_id 
    AND post_upvotes.profile_id = auth.uid()
)) AS is_upvoted

-- community-post-list-view.sql
(SELECT EXISTS (
  SELECT 1 
  FROM public.post_upvotes 
  WHERE post_upvotes.post_id = posts.post_id 
    AND post_upvotes.profile_id = auth.uid()
)) AS is_upvoted
```

**패턴**:
- `EXISTS` 서브쿼리로 업보트 여부 확인
- `auth.uid()`로 현재 로그인한 사용자 ID 가져오기
- `post_upvotes` 테이블에서 매칭되는 레코드 존재 여부 확인

**장점**:
- 데이터베이스 레벨에서 효율적인 조회
- 한 번의 쿼리로 모든 정보 조회
- 서버 사이드에서 처리

### 2. 컴포넌트에 업보트 상태 prop 추가

**구현**:
```typescript
// app/features/community/components/post-card.tsx
interface PostCardProps {
  // ... 기존 props
  votesCount?: number;
  isUpvoted?: boolean;
}

export function PostCard({
  // ... 기존 props
  votesCount = 0,
  isUpvoted = false,
}: PostCardProps) {
  return (
    // ...
    <Button
      variant="outline"
      className={cn(
        "flex flex-col h-14",
        isUpvoted ? "border-primary text-primary" : ""
      )}
    >
      <ChevronUpIcon className="size-4 shrink-0" />
      <span>{votesCount}</span>
    </Button>
  );
}
```

**패턴**:
- `votesCount`와 `isUpvoted` prop 추가
- `cn()` 유틸리티로 조건부 스타일링
- 기본값 설정 (`votesCount = 0`, `isUpvoted = false`)

**장점**:
- 조건부 스타일링으로 시각적 피드백 제공
- 재사용 가능한 컴포넌트

### 3. 페이지에서 업보트 상태 전달

**구현**:
```typescript
// community-page.tsx
<PostCard
  // ... 기존 props
  votesCount={post.upvotes}
  isUpvoted={post.is_upvoted}
  expanded
/>

// post-page.tsx
<Button
  variant="outline"
  className={cn(
    "flex flex-col h-14",
    loaderData.post.is_upvoted ? "border-primary text-primary" : ""
  )}
>
  <ChevronUpIcon className="size-4 shrink-0" />
  <span>{loaderData.post.upvotes}</span>
</Button>
```

**패턴**: Loader에서 가져온 데이터를 컴포넌트에 전달

**장점**: 서버 사이드에서 조회한 데이터를 그대로 사용

### 4. Database Types 업데이트

**구현**:
```typescript
// database.types.ts
is_upvoted: boolean | null
```

**패턴**: SQL View의 새 필드를 타입에 반영

**장점**: 타입 안정성 보장

## 적용 방안

### ✅ 이미 적용된 패턴

1. **조건부 스타일링**: 일부 컴포넌트에서 사용 중
2. **Loader에서 데이터 조회**: 여러 페이지에서 사용 중
3. **SQL View 사용**: 일부 쿼리에서 사용 중

### 🔄 추가로 적용 가능한 패턴

#### 1. SQL View에서 사용자별 상태 조회 (우선순위: 중간)

**현재 상태**: 일부 View에서만 사용

**적용 방안**:
```sql
(SELECT EXISTS (
  SELECT 1 
  FROM public.resource_likes 
  WHERE resource_likes.resource_id = resources.id 
    AND resource_likes.profile_id = auth.uid()
)) AS is_liked
```

**적용 대상**:
- 좋아요 기능이 있는 리소스
- 북마크 기능
- 팔로우 상태

**장점**:
- 데이터베이스 레벨에서 효율적인 조회
- 한 번의 쿼리로 모든 정보 조회

#### 2. 조건부 스타일링 패턴 강화 (우선순위: 낮음)

**현재 상태**: 일부 컴포넌트에서만 사용

**적용 방안**: `cn()` 유틸리티를 사용한 조건부 스타일링

**장점**: 일관된 스타일링 패턴

#### 3. 컴포넌트에 상태 prop 추가 (우선순위: 낮음)

**현재 상태**: 일부 컴포넌트에서만 사용

**적용 방안**: 상태를 prop으로 전달하여 재사용성 향상

**장점**: 컴포넌트 재사용성 향상

## 구현 우선순위

### 중간 (점진적 적용)

1. **SQL View에서 사용자별 상태 조회**
   - 영향도: 중간 (성능 개선)
   - 난이도: 중간
   - 효과: 효율적인 데이터 조회

### 낮음 (선택사항)

2. **조건부 스타일링 패턴 강화**
   - 영향도: 낮음 (코드 품질)
   - 난이도: 낮음
   - 효과: 일관된 스타일링

3. **컴포넌트에 상태 prop 추가**
   - 영향도: 낮음 (코드 품질)
   - 난이도: 낮음
   - 효과: 컴포넌트 재사용성 향상

## 참고사항

- `EXISTS` 서브쿼리는 레코드 존재 여부만 확인하므로 효율적
- `auth.uid()`는 현재 로그인한 사용자 ID를 반환
- SQL View에서 사용자별 상태를 조회하면 클라이언트에서 추가 처리 불필요
- `cn()` 유틸리티로 조건부 스타일링 간편하게 처리
- 기본값 설정으로 옵셔널 prop 처리
- Database Types는 SQL View 변경 시 반드시 업데이트 필요

