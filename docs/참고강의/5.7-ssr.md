# 5.7 SSR (Server-Side Rendering)

## 커밋 개요

이 커밋은 React Router의 SSR 기능을 활용하여 페이지 전환 시 로딩 상태를 시각적으로 표시하는 패턴을 구현합니다. `useNavigation` 훅을 사용하여 네비게이션 상태를 감지하고, 로딩 중일 때 사용자에게 피드백을 제공합니다.

## 주요 변경사항

### 1. Loader에 의도적인 지연 추가 (테스트용)

**변경된 파일: `app/features/community/pages/community-page.tsx`**

```typescript
export const loader = async () => {
  await new Promise((resolve) => setTimeout(resolve, 10000)); // 10초 지연 추가
  const topics = await getTopics();
  const posts = await getPosts();
  return { topics, posts };
};
```

**핵심 포인트:**

- 의도적인 지연을 추가하여 로딩 상태를 테스트
- 실제 프로덕션에서는 제거해야 함
- 느린 네트워크나 데이터베이스 쿼리를 시뮬레이션

### 2. Root 컴포넌트에 로딩 상태 처리 추가

**변경된 파일: `app/root.tsx`**

#### Before

```typescript
import { useLocation } from "react-router";

export default function App() {
  const { pathname } = useLocation();
  
  return (
    <div className={pathname.includes("/auth/") ? "" : "py-28 px-5 md:px-20"}>
      {/* ... */}
    </div>
  );
}
```

#### After

```typescript
import { useLocation, useNavigation } from "react-router";
import { cn } from "./lib/utils";

export default function App() {
  const { pathname } = useLocation();
  const navigation = useNavigation();
  const isLoading = navigation.state === "loading";
  
  return (
    <div
      className={cn({
        "py-28 px-5 md:px-20": !pathname.includes("/auth/"),
        "transition-opacity animate-pulse": isLoading,
      })}
    >
      {/* ... */}
    </div>
  );
}
```

**핵심 포인트:**

- `useNavigation`: React Router의 네비게이션 상태를 추적하는 훅
- `navigation.state`: 네비게이션의 현재 상태 (`"idle"`, `"loading"`, `"submitting"`)
- `isLoading`: 로딩 상태를 boolean으로 변환
- `animate-pulse`: Tailwind CSS 애니메이션으로 로딩 피드백 제공
- `cn`: 조건부 클래스명 병합 유틸리티 사용

## 우리 프로젝트에 적용하기

### 현재 상태 분석

우리 프로젝트는 현재:

- ✅ React Router 7 사용 중
- ✅ SSR 지원됨
- ✅ Loader 함수 사용 중
- ❌ 로딩 상태 시각적 피드백 미구현
- ❌ 네비게이션 상태 추적 미사용

### 적용 전략

#### 1단계: useNavigation 훅 이해

**useNavigation의 상태:**

```typescript
const navigation = useNavigation();

// navigation.state 가능한 값:
// - "idle": 유휴 상태 (로딩 없음)
// - "loading": 로더가 실행 중
// - "submitting": 폼 제출 중
```

**사용 예시:**

```typescript
const isLoading = navigation.state === "loading";
const isSubmitting = navigation.state === "submitting";
const isIdle = navigation.state === "idle";
```

#### 2단계: Root 컴포넌트에 로딩 상태 추가

**파일: `app/root.tsx`**

```typescript
import { useLocation, useNavigation } from "react-router";
import { cn } from "~/lib/utils";

export default function App() {
  const { pathname } = useLocation();
  const navigation = useNavigation();
  const isLoading = navigation.state === "loading";

  return (
    <div
      className={cn({
        "py-28 px-5 md:px-20": !pathname.includes("/auth/"),
        "transition-opacity animate-pulse": isLoading, // 로딩 중 펄스 애니메이션
        "opacity-50": isLoading, // 로딩 중 투명도 감소 (선택사항)
      })}
    >
      {/* 기존 내용 */}
    </div>
  );
}
```

#### 3단계: 다양한 로딩 피드백 패턴

**패턴 1: 펄스 애니메이션**

```typescript
className={cn({
  "animate-pulse": isLoading,
})}
```

**패턴 2: 투명도 조절**

```typescript
className={cn({
  "opacity-50 transition-opacity": isLoading,
})}
```

**패턴 3: 블러 효과**

```typescript
className={cn({
  "blur-sm transition-all": isLoading,
})}
```

**패턴 4: 로딩 스피너 표시**

```typescript
{isLoading && (
  <div className="fixed top-4 right-4 z-50">
    <LoadingSpinner />
  </div>
)}
```

**패턴 5: 프로그레스 바**

```typescript
{isLoading && (
  <div className="fixed top-0 left-0 right-0 h-1 bg-primary animate-progress" />
)}
```

#### 4단계: 특정 페이지에서만 로딩 표시

**조건부 로딩 표시:**

```typescript
const navigation = useNavigation();
const isLoading = navigation.state === "loading";
const isNavigatingToDashboard = navigation.location?.pathname.startsWith("/my/dashboard");

return (
  <div
    className={cn({
      "animate-pulse": isLoading && isNavigatingToDashboard,
    })}
  >
    {/* ... */}
  </div>
);
```

#### 5단계: 로딩 상태를 컴포넌트로 추상화

**파일: `app/common/components/navigation-loading-indicator.tsx`**

```typescript
import { useNavigation } from "react-router";
import { cn } from "~/lib/utils";

export function NavigationLoadingIndicator() {
  const navigation = useNavigation();
  const isLoading = navigation.state === "loading";

  if (!isLoading) return null;

  return (
    <div className="fixed top-0 left-0 right-0 h-1 bg-primary/20 z-50">
      <div className="h-full bg-primary animate-progress" />
    </div>
  );
}
```

**Root 컴포넌트에서 사용:**

```typescript
import { NavigationLoadingIndicator } from "~/common/components/navigation-loading-indicator";

export default function App() {
  return (
    <>
      <NavigationLoadingIndicator />
      {/* 기존 내용 */}
    </>
  );
}
```

## useNavigation 활용 패턴

### 1. 기본 로딩 상태 감지

```typescript
import { useNavigation } from "react-router";

function MyComponent() {
  const navigation = useNavigation();
  const isLoading = navigation.state === "loading";
  
  return (
    <div>
      {isLoading && <LoadingSpinner />}
      {/* 컨텐츠 */}
    </div>
  );
}
```

### 2. 특정 경로로 이동 중인지 확인

```typescript
const navigation = useNavigation();
const isGoingToProfile = navigation.location?.pathname === "/my/dashboard/settings/profile";
```

### 3. 폼 제출 상태 확인

```typescript
const navigation = useNavigation();
const isSubmitting = navigation.state === "submitting";

<button disabled={isSubmitting}>
  {isSubmitting ? "제출 중..." : "제출"}
</button>
```

### 4. 로딩 상태와 함께 폼 데이터 확인

```typescript
const navigation = useNavigation();
const isSubmitting = navigation.state === "submitting";
const formData = navigation.formData;

// 폼 제출 중인 데이터 확인
if (isSubmitting && formData) {
  const action = formData.get("action");
  // ...
}
```

## SSR과 클라이언트 사이드 네비게이션

### React Router의 동작 방식

1. **초기 로드 (SSR)**
   - 서버에서 `loader` 함수 실행
   - HTML 생성 및 전송
   - 클라이언트에서 하이드레이션

2. **클라이언트 사이드 네비게이션**
   - `Link` 클릭 시 `loader` 함수 실행
   - `useNavigation`으로 상태 추적 가능
   - 로딩 중에도 이전 페이지 표시 (점진적 업데이트)

### 로딩 상태의 타이밍

```typescript
// navigation.state의 변화:
// 1. "idle" → 사용자가 링크 클릭
// 2. "loading" → loader 함수 실행 중
// 3. "idle" → loader 완료, 새 페이지 렌더링
```

## 장단점 비교

### useNavigation 사용 장점

- ✅ **간단한 구현**: 추가 라이브러리 없이 React Router 기본 기능 사용
- ✅ **자동 상태 관리**: React Router가 네비게이션 상태를 자동으로 관리
- ✅ **일관된 UX**: 모든 페이지 전환에 동일한 로딩 피드백 적용 가능
- ✅ **성능 최적화**: 로딩 상태를 활용하여 불필요한 렌더링 방지 가능

### useNavigation 사용 단점

- ❌ **제한적인 정보**: 로딩 중인 경로 정보만 제공 (세부 정보 제한적)
- ❌ **전역 상태**: Root 레벨에서만 사용하기 적합 (깊은 컴포넌트에서는 prop drilling 필요)
- ❌ **커스터마이징 제한**: React Router의 기본 동작에 의존

### 언제 useNavigation을 사용해야 할까?

**useNavigation 사용 권장:**

- 페이지 전환 시 전역 로딩 표시가 필요한 경우
- 간단한 로딩 피드백이 필요한 경우
- React Router의 기본 기능만으로 충분한 경우

**useNavigation 사용 비권장:**

- 복잡한 로딩 상태 관리가 필요한 경우 (React Query, SWR 등 고려)
- 세부적인 로딩 진행률이 필요한 경우
- 여러 비동기 작업을 동시에 추적해야 하는 경우

## 주의사항

1. **의도적인 지연 제거**
   - 테스트용 지연(`setTimeout`)은 프로덕션에서 제거
   - 실제 로딩 시간만 표시되도록

2. **과도한 애니메이션 방지**
   - 로딩 피드백이 너무 강하면 사용자 경험 저하
   - 미묘한 피드백이 더 나은 경우가 많음

3. **접근성 고려**
   - 스크린 리더 사용자를 위한 로딩 상태 알림
   - `aria-busy` 속성 사용 고려

```typescript
<div aria-busy={isLoading} aria-live="polite">
  {isLoading && <span className="sr-only">페이지를 불러오는 중입니다</span>}
  {/* 컨텐츠 */}
</div>
```

4. **성능 고려**
   - 로딩 애니메이션이 성능에 영향을 주지 않도록 주의
   - CSS 애니메이션은 GPU 가속 활용

5. **로딩 상태 일관성**
   - 모든 페이지에서 동일한 로딩 피드백 사용
   - 사용자가 혼란스럽지 않도록

## 다음 단계

1. ✅ useNavigation 훅 이해
2. ✅ 로딩 상태 감지 방법 학습
3. ⏳ Root 컴포넌트에 로딩 상태 추가
4. ⏳ 적절한 로딩 피드백 선택
5. ⏳ 접근성 고려사항 적용
6. ⏳ 테스트 및 사용자 피드백 수집

## 참고 자료

- [React Router useNavigation 문서](https://reactrouter.com/en/main/hooks/use-navigation)
- [React Router SSR 가이드](https://reactrouter.com/en/main/guides/ssr)
- [Tailwind CSS 애니메이션](https://tailwindcss.com/docs/animation)

