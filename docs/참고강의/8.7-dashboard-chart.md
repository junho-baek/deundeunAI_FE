# 8.7 Dashboard Chart

## ì»¤ë°‹ ìš”ì•½

ëŒ€ì‹œë³´ë“œ ì°¨íŠ¸ ê¸°ëŠ¥ì„ êµ¬í˜„í•œ ì»¤ë°‹ì…ë‹ˆë‹¤. Layoutì—ì„œ Loader ì‚¬ìš©, RPC í•¨ìˆ˜ë¥¼ í†µí•œ í†µê³„ ë°ì´í„° ì¡°íšŒ, Mock ë°ì´í„°ë¥¼ ì‹¤ì œ ë°ì´í„°ë¡œ êµì²´, ë™ì  ì‚¬ì´ë“œë°” ë©”ë‰´ ìƒì„± ë“±ì˜ íŒ¨í„´ì„ ë³´ì—¬ì¤ë‹ˆë‹¤.

## ì£¼ìš” ë³€ê²½ì‚¬í•­

### 1. Layoutì—ì„œ Loader ì‚¬ìš©

**êµ¬í˜„**:
```typescript
// app/features/users/layouts/dashboard-layout.tsx
export const loader = async ({ request }: Route.LoaderArgs) => {
  const { client } = await makeSSRClient(request);
  const userId = await getLoggedInUserId(client);
  const products = await getProductsByUserId(client, { userId });
  
  return {
    userId,
    products,
  };
};

export default function DashboardLayout({ loaderData }: Route.ComponentProps) {
  // loaderDataë¥¼ ì‚¬ìš©í•˜ì—¬ ë™ì  ì‚¬ì´ë“œë°” ë©”ë‰´ ìƒì„±
  return (
    <SidebarProvider className="flex min-h-full">
      {/* ... */}
      {loaderData.products.map((product) => (
        <SidebarMenuItem key={product.product_id}>
          <SidebarMenuButton asChild>
            <Link to={`/my/dashboard/products/${product.product_id}`}>
              <RocketIcon className="size-4" />
              <span>{product.name}</span>
            </Link>
          </SidebarMenuButton>
        </SidebarMenuItem>
      ))}
    </SidebarProvider>
  );
}
```

**íŒ¨í„´**:
- Layoutì—ì„œë„ Loader ì‚¬ìš© ê°€ëŠ¥
- Layoutì˜ Loader ë°ì´í„°ëŠ” í•˜ìœ„ í˜ì´ì§€ì—ì„œ `useLoaderData`ë¡œ ì ‘ê·¼ ê°€ëŠ¥
- ë™ì  ë©”ë‰´ ìƒì„±ì— í™œìš©

**ì¥ì **:
- Layout ë ˆë²¨ì—ì„œ ê³µí†µ ë°ì´í„° ì¡°íšŒ
- í•˜ìœ„ í˜ì´ì§€ì—ì„œ ì¤‘ë³µ ì¡°íšŒ ë°©ì§€
- ë™ì  ë©”ë‰´/ë„¤ë¹„ê²Œì´ì…˜ ìƒì„± ê°€ëŠ¥

### 2. RPC í•¨ìˆ˜ë¥¼ í†µí•œ í†µê³„ ë°ì´í„° ì¡°íšŒ

**SQL í•¨ìˆ˜ ìƒì„±**:
```sql
-- app/sql/functions/get_dashboard_stats.sql
CREATE OR REPLACE FUNCTION get_dashboard_stats(user_id uuid)
RETURNS TABLE (
    views bigint,
    month text
) AS $$
BEGIN
    RETURN QUERY
    SELECT
        COUNT(*) AS views,
        to_char(events.created_at, 'YYYY-MM') AS month
    FROM public.events
    JOIN public.profiles ON profiles.profile_id = user_id
    WHERE event_data ->> 'username' = profiles.username
    GROUP BY month;
END;
$$ LANGUAGE plpgsql;
```

**íŒ¨í„´**:
- ë³µì¡í•œ ì§‘ê³„ ì¿¼ë¦¬ë¥¼ RPC í•¨ìˆ˜ë¡œ ìº¡ìŠí™”
- `to_char`ë¡œ ë‚ ì§œ í¬ë§·íŒ…
- `GROUP BY`ë¡œ ì›”ë³„ ì§‘ê³„
- JSON í•„ë“œ ì ‘ê·¼ (`event_data ->> 'username'`)

**ì¥ì **:
- ë³µì¡í•œ ì¿¼ë¦¬ ë¡œì§ì„ ë°ì´í„°ë² ì´ìŠ¤ì— ìº¡ìŠí™”
- ì¬ì‚¬ìš© ê°€ëŠ¥
- ì„±ëŠ¥ ìµœì í™” ê°€ëŠ¥ (ì¸ë±ìŠ¤ í™œìš© ë“±)

### 3. Loaderì—ì„œ RPC í•¨ìˆ˜ í˜¸ì¶œ

**êµ¬í˜„**:
```typescript
// app/features/users/pages/dashboard-page.tsx
export const loader = async ({ request }: Route.LoaderArgs) => {
  const { client } = await makeSSRClient(request);
  const userId = await getLoggedInUserId(client);
  
  const { data, error } = await client.rpc("get_dashboard_stats", {
    user_id: userId,
  });
  
  if (error) {
    throw error;
  }
  
  return {
    chartData: data,
  };
};
```

**íŒ¨í„´**:
- `client.rpc()`ë¡œ RPC í•¨ìˆ˜ í˜¸ì¶œ
- ì—ëŸ¬ ë°œìƒ ì‹œ throw
- ë°ì´í„°ë¥¼ ê·¸ëŒ€ë¡œ ë°˜í™˜ (í•„ìš”ì‹œ ë³€í™˜)

**ì¥ì **:
- ì„œë²„ ì‚¬ì´ë“œì—ì„œ í†µê³„ ë°ì´í„° ì¡°íšŒ
- í´ë¼ì´ì–¸íŠ¸ ë¶€í•˜ ê°ì†Œ
- ë°ì´í„° ì¼ê´€ì„± ë³´ì¥

### 4. Mock ë°ì´í„°ë¥¼ ì‹¤ì œ ë°ì´í„°ë¡œ êµì²´

**ë³€ê²½ ì „**:
```typescript
const chartData = [
  { month: "January", views: 186 },
  { month: "February", views: 305 },
  // ...
];

export default function DashboardPage() {
  return (
    <LineChart data={chartData} />
  );
}
```

**ë³€ê²½ í›„**:
```typescript
export default function DashboardPage({ loaderData }: Route.ComponentProps) {
  return (
    <LineChart data={loaderData.chartData} />
  );
}
```

**íŒ¨í„´**: Mock ë°ì´í„°ë¥¼ Loaderì—ì„œ ê°€ì ¸ì˜¨ ì‹¤ì œ ë°ì´í„°ë¡œ êµì²´

**ì¥ì **:
- ì‹¤ì œ ë°ì´í„° ê¸°ë°˜ ì°¨íŠ¸
- ë™ì  ë°ì´í„° ì—…ë°ì´íŠ¸ ê°€ëŠ¥

### 5. Queriesì— ì‚¬ìš©ìë³„ ì œí’ˆ ì¡°íšŒ í•¨ìˆ˜ ì¶”ê°€

**êµ¬í˜„**:
```typescript
// app/features/users/queries.ts
export const getProductsByUserId = async (
  client: SupabaseClient<Database>,
  { userId }: { userId: string }
) => {
  const { data, error } = await client
    .from("products")
    .select(`name, product_id`)
    .eq("profile_id", userId);

  if (error) {
    throw error;
  }

  return data;
};
```

**íŒ¨í„´**:
- í•„ìš”í•œ í•„ë“œë§Œ ì„ íƒ (`select`)
- íŠ¹ì • ì‚¬ìš©ìì˜ ì œí’ˆë§Œ ì¡°íšŒ (`eq`)

### 6. Database Types ì—…ë°ì´íŠ¸

**ë³€ê²½**:
```typescript
// database.types.ts
Functions: {
  get_dashboard_stats: {
    Args: {
      user_id: string
    }
    Returns: {
      views: number
      month: string
    }[]
  }
}
```

**íŒ¨í„´**: RPC í•¨ìˆ˜ íƒ€ì… ì •ì˜ ì¶”ê°€

**ì¥ì **: TypeScript íƒ€ì… ì•ˆì •ì„± ë³´ì¥

## ì ìš© ë°©ì•ˆ

### âœ… ì´ë¯¸ ì ìš©ëœ íŒ¨í„´

1. **Loader ì‚¬ìš©**: ì—¬ëŸ¬ í˜ì´ì§€ì—ì„œ ì´ë¯¸ ì‚¬ìš© ì¤‘
2. **RPC í•¨ìˆ˜ í˜¸ì¶œ**: í¬ë ˆë”§ ì‹œìŠ¤í…œì—ì„œ ì´ë¯¸ ì‚¬ìš© ì¤‘
3. **Mock ë°ì´í„° êµì²´**: ì¼ë¶€ í˜ì´ì§€ì—ì„œ ì´ë¯¸ ì ìš©ë¨

### ğŸ”„ ì¶”ê°€ë¡œ ì ìš© ê°€ëŠ¥í•œ íŒ¨í„´

#### 1. Layoutì—ì„œ Loader ì‚¬ìš© (ìš°ì„ ìˆœìœ„: ë†’ìŒ)

**í˜„ì¬ ìƒíƒœ**: ì¼ë¶€ Layoutì—ì„œë§Œ Loader ì‚¬ìš©

**ì ìš© ë°©ì•ˆ**:
```typescript
// app/features/projects/layouts/project-detail-layout.tsx
export const loader = async ({ request, params }: LoaderFunctionArgs) => {
  const { client } = makeSSRClient(request);
  const userId = await getLoggedInUserId(client);
  
  // ê³µí†µ ë°ì´í„° ì¡°íšŒ
  const commonData = await getCommonData(client, userId);
  
  return { commonData };
};

export default function ProjectDetailLayout({ loaderData }: Route.ComponentProps) {
  // loaderDataë¥¼ ì‚¬ìš©í•˜ì—¬ ê³µí†µ UI êµ¬ì„±
}
```

**ì ìš© ëŒ€ìƒ**:
- ê³µí†µ ë°ì´í„°ê°€ í•„ìš”í•œ Layout
- ë™ì  ë©”ë‰´/ë„¤ë¹„ê²Œì´ì…˜ì´ í•„ìš”í•œ Layout

**ì¥ì **:
- í•˜ìœ„ í˜ì´ì§€ì—ì„œ ì¤‘ë³µ ì¡°íšŒ ë°©ì§€
- Layout ë ˆë²¨ì—ì„œ ê³µí†µ ë°ì´í„° ê´€ë¦¬

#### 2. RPC í•¨ìˆ˜ë¥¼ í†µí•œ ë³µì¡í•œ í†µê³„ ì¡°íšŒ (ìš°ì„ ìˆœìœ„: ì¤‘ê°„)

**í˜„ì¬ ìƒíƒœ**: ì¼ë¶€ í†µê³„ëŠ” í´ë¼ì´ì–¸íŠ¸ì—ì„œ ê³„ì‚°

**ì ìš© ë°©ì•ˆ**:
```sql
CREATE OR REPLACE FUNCTION get_project_stats(project_id uuid)
RETURNS TABLE (
    total_views bigint,
    total_likes bigint,
    avg_ctr numeric,
    month text
) AS $$
BEGIN
    RETURN QUERY
    SELECT
        COUNT(*) AS total_views,
        SUM(likes) AS total_likes,
        AVG(ctr) AS avg_ctr,
        to_char(created_at, 'YYYY-MM') AS month
    FROM public.project_metrics
    WHERE project_id = get_project_stats.project_id
    GROUP BY month;
END;
$$ LANGUAGE plpgsql;
```

**ì ìš© ëŒ€ìƒ**:
- ë³µì¡í•œ ì§‘ê³„ê°€ í•„ìš”í•œ í†µê³„
- ì„±ëŠ¥ì´ ì¤‘ìš”í•œ ëŒ€ì‹œë³´ë“œ

**ì¥ì **:
- ë°ì´í„°ë² ì´ìŠ¤ ë ˆë²¨ì—ì„œ ìµœì í™” ê°€ëŠ¥
- ë³µì¡í•œ ë¡œì§ ìº¡ìŠí™”
- ì¬ì‚¬ìš© ê°€ëŠ¥

#### 3. Mock ë°ì´í„°ë¥¼ ì‹¤ì œ ë°ì´í„°ë¡œ êµì²´ (ìš°ì„ ìˆœìœ„: ì¤‘ê°„)

**í˜„ì¬ ìƒíƒœ**: ì¼ë¶€ ì»´í¬ë„ŒíŠ¸ì—ì„œ Mock ë°ì´í„° ì‚¬ìš©

**ì ìš© ë°©ì•ˆ**: Loaderì—ì„œ ì‹¤ì œ ë°ì´í„° ì¡°íšŒ í›„ ì „ë‹¬

**ì ìš© ëŒ€ìƒ**:
- ì°¨íŠ¸ ë°ì´í„°
- ëª©ë¡ ë°ì´í„°
- í†µê³„ ë°ì´í„°

**ì¥ì **: ì‹¤ì œ ë°ì´í„° ê¸°ë°˜ UI

#### 4. ë™ì  ì‚¬ì´ë“œë°” ë©”ë‰´ ìƒì„± (ìš°ì„ ìˆœìœ„: ë‚®ìŒ)

**í˜„ì¬ ìƒíƒœ**: ì •ì  ë©”ë‰´ ì‚¬ìš©

**ì ìš© ë°©ì•ˆ**: Layout Loaderì—ì„œ ë°ì´í„° ì¡°íšŒ í›„ ë™ì  ë©”ë‰´ ìƒì„±

**ì¥ì **: ì‚¬ìš©ìë³„ ë§ì¶¤ ë©”ë‰´ ì œê³µ

## êµ¬í˜„ ìš°ì„ ìˆœìœ„

### ë†’ìŒ (ì¦‰ì‹œ ì ìš© ê¶Œì¥)

1. **Layoutì—ì„œ Loader ì‚¬ìš©**
   - ì˜í–¥ë„: ë†’ìŒ (ì½”ë“œ êµ¬ì¡° ê°œì„ )
   - ë‚œì´ë„: ë‚®ìŒ
   - íš¨ê³¼: ì¤‘ë³µ ì¡°íšŒ ë°©ì§€, ê³µí†µ ë°ì´í„° ê´€ë¦¬

### ì¤‘ê°„ (ì ì§„ì  ì ìš©)

2. **RPC í•¨ìˆ˜ë¥¼ í†µí•œ ë³µì¡í•œ í†µê³„ ì¡°íšŒ**
   - ì˜í–¥ë„: ì¤‘ê°„ (ì„±ëŠ¥ ê°œì„ )
   - ë‚œì´ë„: ì¤‘ê°„
   - íš¨ê³¼: ì„±ëŠ¥ ìµœì í™”, ë¡œì§ ìº¡ìŠí™”

3. **Mock ë°ì´í„°ë¥¼ ì‹¤ì œ ë°ì´í„°ë¡œ êµì²´**
   - ì˜í–¥ë„: ì¤‘ê°„ (ê¸°ëŠ¥ ì™„ì„±ë„)
   - ë‚œì´ë„: ë‚®ìŒ
   - íš¨ê³¼: ì‹¤ì œ ë°ì´í„° ê¸°ë°˜ UI

### ë‚®ìŒ (ì„ íƒì‚¬í•­)

4. **ë™ì  ì‚¬ì´ë“œë°” ë©”ë‰´ ìƒì„±**
   - ì˜í–¥ë„: ë‚®ìŒ (UX ê°œì„ )
   - ë‚œì´ë„: ë‚®ìŒ
   - íš¨ê³¼: ì‚¬ìš©ì ë§ì¶¤ ë©”ë‰´

## ì°¸ê³ ì‚¬í•­

- Layoutì˜ LoaderëŠ” í•˜ìœ„ í˜ì´ì§€ì—ì„œ `useLoaderData`ë¡œ ì ‘ê·¼ ê°€ëŠ¥
- RPC í•¨ìˆ˜ëŠ” ë³µì¡í•œ ì§‘ê³„ ì¿¼ë¦¬ì— ìœ ìš©í•¨
- `to_char`ë¡œ ë‚ ì§œ í¬ë§·íŒ… ì‹œ íƒ€ì„ì¡´ ì£¼ì˜
- JSON í•„ë“œ ì ‘ê·¼ ì‹œ `->>` (í…ìŠ¤íŠ¸) ë˜ëŠ” `->` (JSON) ì‚¬ìš©
- RPC í•¨ìˆ˜ íƒ€ì…ì€ `database.types.ts`ì— ì •ì˜í•´ì•¼ í•¨

