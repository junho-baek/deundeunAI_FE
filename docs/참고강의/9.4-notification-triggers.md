# 9.4 Notification Triggers

## 커밋 요약

NomadCoders 9.4 커밋(d95eab9)은 **데이터베이스 트리거**로 알림을 생성하는 패턴을 다룹니다. `follows`, `reviews`, `post_replies` 테이블에 새 행이 추가되면 Postgres 트리거가 `notifications` 테이블에 직접 레코드를 추가해 서버와 클라이언트 코드의 부하를 줄입니다.

## 핵심 아이디어

1. **트리거 함수 분리**  
   `notify_follow`, `notify_review`, `notify_reply` 같은 함수를 만들고 각각 관련 테이블에 `AFTER INSERT` 트리거를 붙입니다. 이렇게 하면 동일한 알림 로직을 다른 서비스에서도 재사용할 수 있습니다.

2. **최소 데이터 조회**  
   트리거 함수 내에서 필요한 필드만 조회(`product_owner`, `post_owner`)한 뒤 `notifications`에 title/body/cta 정보를 기록합니다. 기초 데이터만 확보하면 대부분의 알림은 서버 코드 개입 없이도 발송할 수 있다는 점을 보여줍니다.

3. **Drizzle/타입 시스템과 연결**  
   `schema.ts`에서 `notifications` Enum, `follows` 컬럼 제약 등을 정리해 타입 안전성을 유지했습니다. DB 스키마와 코드가 동시에 업데이트돼 “트리거가 추가됐는데 타입 정의는 낡은 상태”가 되는 문제를 방지합니다.

## Projects 적용

### 1. 프로젝트 단계 알림 트리거 추가

`app/sql/triggers/project-status-notifications.sql`에 프로젝트 단계가 시작/완료될 때 알림을 기록하는 트리거를 추가했습니다. 흐름은 다음과 같습니다.

1. `project_steps`의 `status` 값이 바뀔 때만 트리거 실행.
2. `projects` 테이블에서 `owner_profile_id`, `project_id`, `title`을 조회.
3. 상태가 `in_progress`면 “~ 단계가 시작되었습니다”, `completed`면 “~ 단계가 완료되었습니다”라는 알림을 `notifications` 테이블에 insert.
4. `cta_href`는 `/my/dashboard/project/{project_uuid}`로 설정해 곧바로 워크스페이스로 이동 가능.

### 2. 알림 컨텐츠 예시

```text
title: "Script 단계 완료"
body: ""든든AI 광고 캠페인" 프로젝트의 Script 단계가 완료되었습니다."
category: "project_workflow"
cta_label: "워크스페이스 열기"
cta_href: /my/dashboard/project/{uuid}
```

`metadata`에는 `project_id`, `step_key`, `status`, `step_id`, `project_title`을 담아 프런트엔드에서 알림을 누를 때 추가 정보를 활용할 수 있습니다.

### 3. 운영 팁

- 트리거는 서버 코드와 별도로 Supabase SQL Editor나 `pnpm supabase db push` 같은 배포 파이프라인에서 실행해야 합니다.
- 필요 시 `notifications` 테이블에 `category = 'project_workflow'` 필터를 두고 워크스페이스 알림과 커뮤니티 알림을 구분할 수 있습니다.
- 향후 협업자 초대 기능이 추가되면 트리거 함수에서 공동 작업자 목록을 조회해 다수의 알림을 생성하도록 확장할 수 있습니다.

추가로 적용할 아이디어가 있으면 언제든 알려 주세요. 트리거 패턴을 다른 프로젝트 이벤트(예: 배포 완료, 오류 발생)에도 확장할 수 있습니다.
