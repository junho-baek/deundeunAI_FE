# 8.11 Row Level Security

## 커밋 요약

아바타 업로드 기능의 보안 및 안정성을 개선한 커밋입니다. 파일 경로에 타임스탬프 추가, `upsert` 옵션 변경, 아바타 초기값 설정 등의 패턴을 보여줍니다.

## 주요 변경사항

### 1. 파일 업로드 경로에 타임스탬프 추가

**구현**:
```typescript
// 변경 전
.upload(userId, avatar, {
  contentType: avatar.type,
  upsert: true,
});

// 변경 후
.upload(`${userId}/${Date.now()}`, avatar, {
  contentType: avatar.type,
  upsert: false,
});
```

**패턴**:
- 파일 경로에 타임스탬프 추가 (`${userId}/${Date.now()}`)
- 고유한 파일 경로 생성
- `upsert: false`로 변경하여 덮어쓰기 방지

**장점**:
- 파일 버전 관리 가능
- 동시 업로드 시 충돌 방지
- 이전 파일 보존 가능

**주의사항**:
- Storage 정리 정책 필요 (오래된 파일 삭제)
- 파일 경로가 길어질 수 있음

### 2. upsert 옵션 변경

**구현**:
```typescript
// 변경 전
upsert: true,  // 덮어쓰기 허용

// 변경 후
upsert: false, // 덮어쓰기 방지
```

**패턴**: `upsert: false`로 변경하여 기존 파일 보호

**장점**:
- 실수로 인한 파일 덮어쓰기 방지
- 파일 버전 관리 용이

**단점**:
- Storage 사용량 증가 가능
- 정리 정책 필요

### 3. 아바타 초기값 설정

**구현**:
```typescript
// 변경 전
const [avatar, setAvatar] = useState<string | null>(null);

// 변경 후
const [avatar, setAvatar] = useState<string | null>(loaderData.user.avatar);
```

**패턴**: Loader에서 가져온 현재 아바타를 초기값으로 설정

**장점**:
- 현재 아바타 표시
- 사용자 경험 개선

## 적용 방안

### ✅ 이미 적용된 패턴

1. **Loader에서 사용자 정보 조회**: 이미 적용됨
2. **useState 초기값 설정**: 일부 적용됨

### 🔄 추가로 적용 가능한 패턴

#### 1. 파일 업로드 경로에 타임스탬프 추가 (우선순위: 높음)

**현재 상태**: `profileId`만 사용

**적용 방안**:
```typescript
.upload(`${profileId}/${Date.now()}`, avatar, {
  contentType: avatar.type,
  upsert: false,
});
```

**장점**:
- 파일 버전 관리 가능
- 동시 업로드 충돌 방지

**주의사항**: Storage 정리 정책 필요

#### 2. upsert 옵션 변경 (우선순위: 중간)

**현재 상태**: `upsert: true` 사용

**적용 방안**: `upsert: false`로 변경

**장점**: 실수로 인한 파일 덮어쓰기 방지

**단점**: Storage 사용량 증가 가능

#### 3. 아바타 초기값 설정 (우선순위: 높음)

**현재 상태**: `null`로 초기화

**적용 방안**: `profile.avatar_url`을 초기값으로 설정

**장점**: 현재 아바타 표시

## 구현 우선순위

### 높음 (즉시 적용 권장)

1. **아바타 초기값 설정**
   - 영향도: 높음 (UX 개선)
   - 난이도: 낮음
   - 효과: 현재 아바타 표시

2. **파일 업로드 경로에 타임스탬프 추가**
   - 영향도: 높음 (안정성 향상)
   - 난이도: 낮음
   - 효과: 파일 버전 관리, 충돌 방지

### 중간 (점진적 적용)

3. **upsert 옵션 변경**
   - 영향도: 중간 (안정성 향상)
   - 난이도: 낮음
   - 효과: 파일 덮어쓰기 방지

## 참고사항

- 타임스탬프를 사용하면 파일 경로가 길어질 수 있음
- `upsert: false` 사용 시 Storage 정리 정책 필요
- 아바타 초기값은 Loader에서 가져온 데이터 사용
- 파일 경로 형식: `${userId}/${Date.now()}` 또는 `${userId}/${timestamp}-${filename}`

