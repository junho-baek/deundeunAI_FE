# 10.4 Sending Message

## 커밋 요약

커밋 `70224a3`에서는 DM 화면에서 메시지를 작성·전송하는 전체 흐름을 완성했습니다.

1. **Message 페이지 Action**
   - `/my/messages/:messageRoomId` 경로에 `action`을 추가해 `Form` submit을 처리합니다.
   - `sendMessageToRoom`을 호출하기 전에 `message_room_members`로 접근 권한을 확인해 “해당 룸의 멤버인지” 검증합니다.
   - 성공 시 `{ ok: true }`를 반환해 프런트에서 폼 초기화 여부를 결정할 수 있게 했습니다.

2. **`Form` + `useRef` 리셋**
   - `actionData?.ok`가 true일 때 `formRef.current?.reset()`을 호출해 입력창을 비웁니다.
   - `useOutletContext`로 받은 `userId`를 이용해 본인 메시지와 상대 메시지를 구분합니다.

3. **`sendMessageToRoom` 쿼리 함수**
   - 룸 멤버 확인(`count` 쿼리) → `messages` 테이블에 INSERT.
   - 숫자형 `message_room_id`로 저장(데이터베이스 스키마에 맞춤).

## 적용 포인트 (Projects)

프로젝트 워크스페이스 채팅은 이미 시스템이 메시지를 삽입하는 구조라 사용자 입력 폼도 구현되어 있습니다. 다만 아래 내용을 참고하면 좋습니다.

- **권한 체크**: 위 패턴처럼, 메시지를 저장하기 전에 `project_steps` 또는 `projects.owner_profile_id`를 확인해 “이 프로젝트에 접근 권한이 있는 사용자만 메시지를 보낼 수 있도록” 서버 측에서 검증을 강화할 수 있습니다.
- **Form 리셋**: 현재 워크스페이스는 `fetcher.submit` 후 상태를 직접 조작하지만, Action 응답으로 `ok` 값을 반환하고 `useEffect`에서 폼을 리셋하면 UX가 보다 명확해집니다.

필요하다면 워크스페이스 액션에도 동일한 guard/리셋 패턴을 넣어드릴 수 있습니다.
