# 8.10 File Uploads

## 커밋 요약

프로필 아바타 파일 업로드 기능을 구현한 커밋입니다. Supabase Storage를 사용한 파일 업로드, 파일 크기 및 타입 검증, `encType="multipart/form-data"` 사용, 별도 Form으로 아바타 업로드 분리 등의 패턴을 보여줍니다.

## 주요 변경사항

### 1. Mutations에 아바타 업데이트 함수 추가

**구현**:
```typescript
// app/features/users/mutations.ts
export const updateUserAvatar = async (
  client: SupabaseClient<Database>,
  {
    id,
    avatarUrl,
  }: {
    id: string;
    avatarUrl: string;
  }
) => {
  const { error } = await client
    .from("profiles")
    .update({ avatar: avatarUrl })
    .eq("profile_id", id);

  if (error) {
    throw error;
  }
};
```

**패턴**:
- 간단한 update 작업
- `avatar` 필드만 업데이트
- 에러는 그대로 throw

**주의사항**: 
- `profile_id`를 사용하고 있지만, 현재 프로젝트는 `id`를 사용하므로 수정 필요

### 2. Action에서 파일 업로드 처리

**구현**:
```typescript
export const action = async ({ request }: Route.ActionArgs) => {
  const { client } = makeSSRClient(request);
  const userId = await getLoggedInUserId(client);
  const formData = await request.formData();

  const avatar = formData.get("avatar");

  // 아바타 파일이 있는 경우
  if (avatar && avatar instanceof File) {
    // 파일 크기 및 타입 검증
    if (avatar.size <= 2097152 && avatar.type.startsWith("image/")) {
      // Supabase Storage에 업로드
      const { data, error } = await client.storage
        .from("avatars")
        .upload(userId, avatar, {
          contentType: avatar.type,
          upsert: true,
        });

      if (error) {
        return { formErrors: { avatar: ["Failed to upload avatar"] } };
      }

      // 공개 URL 가져오기
      const {
        data: { publicUrl },
      } = await client.storage.from("avatars").getPublicUrl(data.path);

      // 프로필 업데이트
      await updateUserAvatar(client, {
        id: userId,
        avatarUrl: publicUrl,
      });
    } else {
      return { formErrors: { avatar: ["Invalid file size or type"] } };
    }
  } else {
    // 일반 프로필 업데이트 로직
    const { success, error, data } = formSchema.safeParse(
      Object.fromEntries(formData)
    );

    if (!success) {
      return { formErrors: error.flatten().fieldErrors };
    }

    // ... 프로필 업데이트 로직
  }

  return {
    ok: true,
  };
};
```

**패턴**:
- `formData.get("avatar")`로 파일 가져오기
- `instanceof File`로 파일 타입 확인
- 파일 크기 검증 (2MB = 2097152 bytes)
- 파일 타입 검증 (`image/`로 시작)
- Supabase Storage에 업로드
- `upsert: true`로 덮어쓰기
- 공개 URL 가져오기
- 프로필 업데이트

**장점**:
- 서버 사이드에서 파일 검증
- 안전한 파일 업로드
- 공개 URL 자동 생성

### 3. Form에 `encType="multipart/form-data"` 추가

**구현**:
```typescript
<Form
  method="post"
  encType="multipart/form-data"
>
  <input
    type="file"
    name="avatar"
    accept="image/*"
    onChange={onChange}
    required
  />
</Form>
```

**패턴**: 파일 업로드를 위해 `encType` 필수

**장점**: 파일 데이터 전송 가능

### 4. 별도 Form으로 아바타 업로드 분리

**구현**:
```typescript
// 프로필 편집 Form
<Form className="flex flex-col w-1/2 gap-5" method="post">
  {/* 프로필 필드들 */}
</Form>

// 아바타 업로드 Form (별도)
<Form
  className="col-span-2 p-6 rounded-lg border shadow-md"
  method="post"
  encType="multipart/form-data"
>
  {/* 아바타 업로드 필드 */}
</Form>
```

**패턴**: 아바타 업로드를 별도 Form으로 분리

**장점**:
- 프로필 편집과 아바타 업로드 분리
- 각각 독립적으로 제출 가능
- UI 구조 명확화

### 5. 에러 처리 개선

**구현**:
```typescript
{actionData?.formErrors && "avatar" in actionData?.formErrors ? (
  <Alert>
    <AlertTitle>Error</AlertTitle>
    <AlertDescription>
      {actionData.formErrors?.avatar?.join(", ")}
    </AlertDescription>
  </Alert>
) : null}
```

**패턴**: 타입 가드로 안전하게 에러 접근

**장점**: 타입 안정성 향상

## 적용 방안

### ✅ 이미 적용된 패턴

1. **Alert 컴포넌트**: 이미 존재하고 사용 중
2. **Form 에러 메시지 표시**: 일부 적용됨
3. **Mutations 파일 분리**: 이미 적용됨

### 🔄 추가로 적용 가능한 패턴

#### 1. 아바타 파일 업로드 기능 추가 (우선순위: 높음)

**현재 상태**: 프로필 편집 페이지에 아바타 업로드 없음

**적용 방안**:
- `updateUserAvatar` mutation 추가 (현재 프로젝트 스키마에 맞게 수정)
- 프로필 편집 페이지에 아바타 업로드 Form 추가
- Supabase Storage 설정 확인

**주의사항**:
- 현재 프로젝트는 `id` 필드를 사용하므로 `profile_id` 대신 `id` 사용
- Supabase Storage 버킷(`avatars`) 생성 필요
- 파일 크기 제한 및 타입 검증 필요

#### 2. 파일 업로드 검증 강화 (우선순위: 중간)

**현재 상태**: 기본 검증만 있음

**적용 방안**:
- 파일 크기 제한 명확화
- 지원 이미지 형식 제한 (jpg, png, webp 등)
- 이미지 리사이징 고려

**장점**: 보안 및 성능 향상

#### 3. 별도 Form으로 아바타 업로드 분리 (우선순위: 중간)

**현재 상태**: 프로필 편집과 아바타 업로드가 같은 Form

**적용 방안**: 아바타 업로드를 별도 Form으로 분리

**장점**: 사용자 경험 개선, 독립적인 제출

## 구현 우선순위

### 높음 (즉시 적용 권장)

1. **아바타 파일 업로드 기능 추가**
   - 영향도: 높음 (기능 추가)
   - 난이도: 중간
   - 효과: 사용자가 아바타를 업로드할 수 있음

### 중간 (점진적 적용)

2. **파일 업로드 검증 강화**
   - 영향도: 중간 (보안 강화)
   - 난이도: 낮음
   - 효과: 보안 및 성능 향상

3. **별도 Form으로 아바타 업로드 분리**
   - 영향도: 중간 (UX 개선)
   - 난이도: 낮음
   - 효과: 사용자 경험 개선

## 참고사항

- `encType="multipart/form-data"`는 파일 업로드에 필수
- 파일 크기는 바이트 단위 (2MB = 2097152 bytes)
- `instanceof File`로 파일 타입 확인
- Supabase Storage 버킷 생성 필요
- `upsert: true`로 기존 파일 덮어쓰기
- 공개 URL은 `getPublicUrl()`로 가져오기
- 현재 프로젝트는 `id` 필드를 사용하므로 `profile_id` 대신 `id` 사용 필요

