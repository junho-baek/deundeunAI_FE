# 8.8 Product Analytics Chart

## ì»¤ë°‹ ìš”ì•½

ì œí’ˆ ë¶„ì„ ì°¨íŠ¸ ê¸°ëŠ¥ì„ êµ¬í˜„í•œ ì»¤ë°‹ì…ë‹ˆë‹¤. RPC í•¨ìˆ˜ë¥¼ í†µí•œ ì œí’ˆ í†µê³„ ì¡°íšŒ, Loaderì—ì„œ ì ‘ê·¼ ì œì–´(ì†Œìœ ê¶Œ í™•ì¸), ë™ì  ì‚¬ì´ë“œë°” ë©”ë‰´ í™œì„± ìƒíƒœ í‘œì‹œ, Mock ë°ì´í„°ë¥¼ ì‹¤ì œ ë°ì´í„°ë¡œ êµì²´ ë“±ì˜ íŒ¨í„´ì„ ë³´ì—¬ì¤ë‹ˆë‹¤.

## ì£¼ìš” ë³€ê²½ì‚¬í•­

### 1. RPC í•¨ìˆ˜ë¥¼ í†µí•œ ì œí’ˆ í†µê³„ ì¡°íšŒ

**SQL í•¨ìˆ˜ ìƒì„±**:
```sql
-- app/sql/functions/get_product_stats.sql
CREATE OR REPLACE FUNCTION get_product_stats(product_id text)
RETURNS TABLE (
    product_views bigint,
    product_visits bigint,
    month text
) AS $$
BEGIN
    RETURN QUERY
    SELECT
        SUM(CASE WHEN event_type = 'product_view' THEN 1 ELSE 0 END) AS product_views,
        SUM(CASE WHEN event_type = 'product_visit' THEN 1 ELSE 0 END) AS product_visits,
        to_char(events.created_at, 'YYYY-MM') AS month
    FROM public.events
    WHERE event_data ->> 'product_id' = product_id
    GROUP BY month;
END;
$$ LANGUAGE plpgsql;
```

**íŒ¨í„´**:
- `CASE WHEN`ìœ¼ë¡œ ì¡°ê±´ë¶€ ì§‘ê³„
- `SUM`ìœ¼ë¡œ ì´ë²¤íŠ¸ ê°œìˆ˜ ì§‘ê³„
- `to_char`ë¡œ ë‚ ì§œ í¬ë§·íŒ…
- JSON í•„ë“œ ì ‘ê·¼ (`event_data ->> 'product_id'`)
- `GROUP BY`ë¡œ ì›”ë³„ ì§‘ê³„

**ì¥ì **:
- ë³µì¡í•œ ì§‘ê³„ ë¡œì§ì„ ë°ì´í„°ë² ì´ìŠ¤ì— ìº¡ìŠí™”
- ì„±ëŠ¥ ìµœì í™” ê°€ëŠ¥
- ì¬ì‚¬ìš© ê°€ëŠ¥

### 2. Loaderì—ì„œ ì ‘ê·¼ ì œì–´ (ì†Œìœ ê¶Œ í™•ì¸)

**êµ¬í˜„**:
```typescript
// app/features/users/pages/dashboard-product-page.tsx
export const loader = async ({ request, params }: Route.LoaderArgs) => {
  const { client } = await makeSSRClient(request);
  const userId = await getLoggedInUserId(client);
  
  // ì œí’ˆ ì†Œìœ ê¶Œ í™•ì¸
  const { error } = await client
    .from("products")
    .select("product_id")
    .eq("profile_id", userId)
    .eq("product_id", params.productId)
    .single();
  
  if (error) {
    throw redirect("/my/dashboard/products"); // ì†Œìœ í•˜ì§€ ì•Šì€ ì œí’ˆ ì ‘ê·¼ ì‹œ ë¦¬ë‹¤ì´ë ‰íŠ¸
  }
  
  // í†µê³„ ë°ì´í„° ì¡°íšŒ
  const { data, error: rpcError } = await client.rpc("get_product_stats", {
    product_id: params.productId,
  });
  
  if (rpcError) {
    throw rpcError;
  }
  
  return {
    chartData: data,
  };
};
```

**íŒ¨í„´**:
- ì œí’ˆ ì†Œìœ ê¶Œ í™•ì¸ í›„ í†µê³„ ì¡°íšŒ
- ì†Œìœ í•˜ì§€ ì•Šì€ ê²½ìš° ë¦¬ë‹¤ì´ë ‰íŠ¸
- ì„œë²„ ì‚¬ì´ë“œ ì ‘ê·¼ ì œì–´

**ì¥ì **:
- ë³´ì•ˆ ê°•í™” (URL ì§ì ‘ ì ‘ê·¼ ì‹œì—ë„ ë³´í˜¸)
- ì‚¬ìš©ì ê²½í—˜ ê°œì„  (ìë™ ë¦¬ë‹¤ì´ë ‰íŠ¸)

### 3. ë™ì  ì‚¬ì´ë“œë°” ë©”ë‰´ í™œì„± ìƒíƒœ í‘œì‹œ

**êµ¬í˜„**:
```typescript
// app/features/users/layouts/dashboard-layout.tsx
<SidebarMenuButton
  asChild
  isActive={
    location.pathname === `/my/dashboard/products/${product.product_id}`
  }
>
  <Link to={`/my/dashboard/products/${product.product_id}`}>
    <RocketIcon className="size-4" />
    <span>{product.name}</span>
  </Link>
</SidebarMenuButton>
```

**íŒ¨í„´**:
- `isActive` propìœ¼ë¡œ í˜„ì¬ ê²½ë¡œì™€ ë¹„êµ
- `location.pathname`ìœ¼ë¡œ í˜„ì¬ ê²½ë¡œ í™•ì¸
- í™œì„± ë©”ë‰´ ì‹œê°ì  í‘œì‹œ

**ì¥ì **:
- ì‚¬ìš©ì ê²½í—˜ ê°œì„  (í˜„ì¬ ìœ„ì¹˜ ëª…í™•íˆ í‘œì‹œ)
- ë„¤ë¹„ê²Œì´ì…˜ ê°€ë…ì„± í–¥ìƒ

### 4. Mock ë°ì´í„°ë¥¼ ì‹¤ì œ ë°ì´í„°ë¡œ êµì²´

**ë³€ê²½ ì „**:
```typescript
const chartData = [
  { month: "January", views: 186, visitors: 100 },
  // ...
];

export default function DashboardProductPage() {
  return <AreaChart data={chartData} />;
}
```

**ë³€ê²½ í›„**:
```typescript
export default function DashboardProductPage({
  loaderData,
}: Route.ComponentProps) {
  return <AreaChart data={loaderData.chartData} />;
}
```

**íŒ¨í„´**: Loaderì—ì„œ ê°€ì ¸ì˜¨ ì‹¤ì œ ë°ì´í„° ì‚¬ìš©

### 5. ì°¨íŠ¸ ë°ì´í„° í‚¤ ë³€ê²½

**ë³€ê²½**:
```typescript
// ë³€ê²½ ì „
dataKey="views"
dataKey="visitors"

// ë³€ê²½ í›„
dataKey="product_views"
dataKey="product_visits"
```

**íŒ¨í„´**: RPC í•¨ìˆ˜ ë°˜í™˜ê°’ê³¼ ì¼ì¹˜í•˜ë„ë¡ í‚¤ ë³€ê²½

### 6. ìƒìˆ˜ ê°’ ë³€ê²½

**ë³€ê²½**:
```typescript
// app/features/products/contants.ts
export const PAGE_SIZE = 2; // ë³€ê²½ ì „
export const PAGE_SIZE = 10; // ë³€ê²½ í›„
```

**íŒ¨í„´**: í˜ì´ì§€ í¬ê¸° ìƒìˆ˜ ì¡°ì •

## ì ìš© ë°©ì•ˆ

### âœ… ì´ë¯¸ ì ìš©ëœ íŒ¨í„´

1. **Loaderì—ì„œ ì ‘ê·¼ ì œì–´**: `project-workspace-page.tsx`ì—ì„œ ì´ë¯¸ ì ìš©ë¨
2. **RPC í•¨ìˆ˜ í˜¸ì¶œ**: ì—¬ëŸ¬ ê³³ì—ì„œ ì´ë¯¸ ì‚¬ìš© ì¤‘
3. **Mock ë°ì´í„° êµì²´**: ì¼ë¶€ í˜ì´ì§€ì—ì„œ ì´ë¯¸ ì ìš©ë¨

### ğŸ”„ ì¶”ê°€ë¡œ ì ìš© ê°€ëŠ¥í•œ íŒ¨í„´

#### 1. ë™ì  ì‚¬ì´ë“œë°” ë©”ë‰´ í™œì„± ìƒíƒœ í‘œì‹œ (ìš°ì„ ìˆœìœ„: ë†’ìŒ)

**í˜„ì¬ ìƒíƒœ**: ì‚¬ì´ë“œë°” ë©”ë‰´ì— í™œì„± ìƒíƒœ í‘œì‹œ ì—†ìŒ

**ì ìš© ë°©ì•ˆ**:
```typescript
import { useLocation } from "react-router";

const location = useLocation();

<SidebarMenuButton
  asChild
  isActive={location.pathname === `/my/dashboard/project/${projectId}`}
>
  <Link to={`/my/dashboard/project/${projectId}`}>
    {/* ë©”ë‰´ ë‚´ìš© */}
  </Link>
</SidebarMenuButton>
```

**ì ìš© ëŒ€ìƒ**:
- í”„ë¡œì íŠ¸ ì‚¬ì´ë“œë°” ë©”ë‰´
- ëŒ€ì‹œë³´ë“œ ë„¤ë¹„ê²Œì´ì…˜
- ê¸°íƒ€ ë™ì  ë©”ë‰´

**ì¥ì **:
- ì‚¬ìš©ì ê²½í—˜ ê°œì„ 
- í˜„ì¬ ìœ„ì¹˜ ëª…í™•íˆ í‘œì‹œ

#### 2. Loaderì—ì„œ ë¦¬ì†ŒìŠ¤ ì†Œìœ ê¶Œ í™•ì¸ íŒ¨í„´ ê°•í™” (ìš°ì„ ìˆœìœ„: ë†’ìŒ)

**í˜„ì¬ ìƒíƒœ**: ì¼ë¶€ í˜ì´ì§€ì—ì„œë§Œ ì ìš©

**ì ìš© ë°©ì•ˆ**:
```typescript
export const loader = async ({ request, params }: Route.LoaderArgs) => {
  const { client } = makeSSRClient(request);
  const userId = await getLoggedInUserId(client);
  
  // ë¦¬ì†ŒìŠ¤ ì†Œìœ ê¶Œ í™•ì¸
  const resource = await getResource(client, { id: params.id });
  
  if (!resource || resource.owner_id !== userId) {
    throw redirect("/unauthorized");
  }
  
  // ë°ì´í„° ì¡°íšŒ
  const data = await getResourceData(client, params.id);
  
  return { data };
};
```

**ì ìš© ëŒ€ìƒ**:
- í”„ë¡œì íŠ¸ ìƒì„¸ í˜ì´ì§€
- ë¶„ì„ í˜ì´ì§€
- ê¸°íƒ€ ì†Œìœ ìë§Œ ì ‘ê·¼ ê°€ëŠ¥í•œ í˜ì´ì§€

**ì¥ì **:
- ë³´ì•ˆ ê°•í™”
- ì¼ê´€ëœ ì ‘ê·¼ ì œì–´

#### 3. RPC í•¨ìˆ˜ë¥¼ í†µí•œ ì´ë²¤íŠ¸ ê¸°ë°˜ í†µê³„ ì¡°íšŒ (ìš°ì„ ìˆœìœ„: ì¤‘ê°„)

**í˜„ì¬ ìƒíƒœ**: ì´ë²¤íŠ¸ íŠ¸ë˜í‚¹ì€ ìˆì§€ë§Œ í†µê³„ ì¡°íšŒëŠ” ì œí•œì 

**ì ìš© ë°©ì•ˆ**:
```sql
CREATE OR REPLACE FUNCTION get_project_stats_by_events(
    project_id uuid,
    start_date date,
    end_date date
)
RETURNS TABLE (
    month text,
    total_views bigint,
    total_clicks bigint,
    conversion_rate numeric
) AS $$
BEGIN
    RETURN QUERY
    SELECT
        to_char(created_at, 'YYYY-MM') AS month,
        SUM(CASE WHEN event_type = 'project_view' THEN 1 ELSE 0 END) AS total_views,
        SUM(CASE WHEN event_type = 'project_click' THEN 1 ELSE 0 END) AS total_clicks,
        CASE 
            WHEN SUM(CASE WHEN event_type = 'project_view' THEN 1 ELSE 0 END) > 0
            THEN (SUM(CASE WHEN event_type = 'project_click' THEN 1 ELSE 0 END)::numeric / 
                  SUM(CASE WHEN event_type = 'project_view' THEN 1 ELSE 0 END)::numeric) * 100
            ELSE 0
        END AS conversion_rate
    FROM public.events
    WHERE event_data ->> 'project_id' = project_id::text
      AND created_at >= start_date
      AND created_at <= end_date
    GROUP BY month
    ORDER BY month;
END;
$$ LANGUAGE plpgsql;
```

**ì ìš© ëŒ€ìƒ**:
- í”„ë¡œì íŠ¸ ë¶„ì„ í˜ì´ì§€
- ëŒ€ì‹œë³´ë“œ í†µê³„
- ì´ë²¤íŠ¸ ê¸°ë°˜ ë¶„ì„

**ì¥ì **:
- ì´ë²¤íŠ¸ ê¸°ë°˜ ìƒì„¸ ë¶„ì„
- ì„±ëŠ¥ ìµœì í™”

#### 4. ì°¨íŠ¸ ë°ì´í„° í‚¤ ëª…ëª… ê·œì¹™ í†µì¼ (ìš°ì„ ìˆœìœ„: ë‚®ìŒ)

**í˜„ì¬ ìƒíƒœ**: ì¼ë¶€ ì°¨íŠ¸ì—ì„œ í‚¤ ì´ë¦„ì´ ì¼ê´€ë˜ì§€ ì•Šì„ ìˆ˜ ìˆìŒ

**ì ìš© ë°©ì•ˆ**: RPC í•¨ìˆ˜ ë°˜í™˜ê°’ê³¼ ì°¨íŠ¸ ë°ì´í„° í‚¤ë¥¼ ì¼ì¹˜ì‹œí‚¤ê¸°

**ì˜ˆì‹œ**:
```typescript
// RPC í•¨ìˆ˜ ë°˜í™˜ê°’
{ product_views: number, product_visits: number, month: string }

// ì°¨íŠ¸ì—ì„œ ì‚¬ìš©
dataKey="product_views" // ì¼ì¹˜
```

**ì¥ì **: ì½”ë“œ ì¼ê´€ì„± í–¥ìƒ

## êµ¬í˜„ ìš°ì„ ìˆœìœ„

### ë†’ìŒ (ì¦‰ì‹œ ì ìš© ê¶Œì¥)

1. **ë™ì  ì‚¬ì´ë“œë°” ë©”ë‰´ í™œì„± ìƒíƒœ í‘œì‹œ**
   - ì˜í–¥ë„: ë†’ìŒ (UX ê°œì„ )
   - ë‚œì´ë„: ë‚®ìŒ
   - íš¨ê³¼: ì‚¬ìš©ì ê²½í—˜ í–¥ìƒ, ë„¤ë¹„ê²Œì´ì…˜ ê°€ë…ì„± í–¥ìƒ

2. **Loaderì—ì„œ ë¦¬ì†ŒìŠ¤ ì†Œìœ ê¶Œ í™•ì¸ íŒ¨í„´ ê°•í™”**
   - ì˜í–¥ë„: ë†’ìŒ (ë³´ì•ˆ ê°•í™”)
   - ë‚œì´ë„: ë‚®ìŒ
   - íš¨ê³¼: ë³´ì•ˆ ê°•í™”, ì¼ê´€ëœ ì ‘ê·¼ ì œì–´

### ì¤‘ê°„ (ì ì§„ì  ì ìš©)

3. **RPC í•¨ìˆ˜ë¥¼ í†µí•œ ì´ë²¤íŠ¸ ê¸°ë°˜ í†µê³„ ì¡°íšŒ**
   - ì˜í–¥ë„: ì¤‘ê°„ (ê¸°ëŠ¥ ì¶”ê°€)
   - ë‚œì´ë„: ì¤‘ê°„
   - íš¨ê³¼: ìƒì„¸ ë¶„ì„ ê¸°ëŠ¥, ì„±ëŠ¥ ìµœì í™”

### ë‚®ìŒ (ì„ íƒì‚¬í•­)

4. **ì°¨íŠ¸ ë°ì´í„° í‚¤ ëª…ëª… ê·œì¹™ í†µì¼**
   - ì˜í–¥ë„: ë‚®ìŒ (ì½”ë“œ í’ˆì§ˆ)
   - ë‚œì´ë„: ë§¤ìš° ë‚®ìŒ
   - íš¨ê³¼: ì½”ë“œ ì¼ê´€ì„± í–¥ìƒ

## ì°¸ê³ ì‚¬í•­

- `isActive` propì€ SidebarMenuButton ì»´í¬ë„ŒíŠ¸ì—ì„œ ì§€ì›í•´ì•¼ í•¨
- `location.pathname`ì€ ì •í™•íˆ ì¼ì¹˜í•´ì•¼ í•˜ë¯€ë¡œ ê²½ë¡œ êµ¬ì¡°ì— ì£¼ì˜
- RPC í•¨ìˆ˜ì—ì„œ `CASE WHEN`ì„ ì‚¬ìš©í•œ ì¡°ê±´ë¶€ ì§‘ê³„ëŠ” ìœ ìš©í•¨
- JSON í•„ë“œ ì ‘ê·¼ ì‹œ `->>` (í…ìŠ¤íŠ¸) ë˜ëŠ” `->` (JSON) ì‚¬ìš©
- ì†Œìœ ê¶Œ í™•ì¸ì€ ë³´ì•ˆìƒ ì¤‘ìš”í•˜ë¯€ë¡œ ë°˜ë“œì‹œ ì„œë²„ ì‚¬ì´ë“œì—ì„œ ìˆ˜í–‰

