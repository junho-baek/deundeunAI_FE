# 6.14 RPC Calls (이벤트 트래킹)

## 커밋 요약

Supabase RPC (Remote Procedure Call) 함수를 사용하여 사용자 행동 이벤트를 트래킹하는 시스템을 구현한 커밋입니다. 페이지 조회, 외부 링크 클릭 등의 이벤트를 데이터베이스에 기록하여 분석 데이터를 수집합니다.

## 주요 변경사항

### 1. Analytics 스키마 생성

**파일**: `app/features/analytics/schema.ts`

```typescript
export const eventType = pgEnum("event_type", [
  "product_view",
  "product_visit",
  "profile_view",
]);

export const events = pgTable("events", {
  event_id: uuid("event_id").primaryKey().defaultRandom(),
  event_type: eventType("event_type"),
  event_data: jsonb("event_data"),
  created_at: timestamp("created_at").defaultNow(),
});
```

**패턴**:
- `event_type` enum으로 이벤트 타입 정의
- `event_data` jsonb 필드로 유연한 데이터 저장
- `created_at`으로 시간 정보 자동 기록

### 2. SQL 함수 생성

**파일**: `app/sql/functions/track_event.sql`

```sql
create or replace function track_event(
    event_type event_type,
    event_data jsonb
) returns void as $$
begin
    insert into events (event_type, event_data) 
    values (event_type, event_data);
end;
$$ language plpgsql;
```

**장점**:
- 서버 사이드에서 실행되어 보안성 향상
- 클라이언트에서 직접 테이블에 접근할 필요 없음
- 함수 레벨에서 검증 및 로직 추가 가능

### 3. Loader에서 RPC 호출

**파일**: `app/features/products/pages/product-overview-page.tsx`

```typescript
export const loader = async ({ params }: Route.LoaderArgs) => {
  await client.rpc("track_event", {
    event_type: "product_view",
    event_data: {
      product_id: params.productId,
    },
  });
  return null;
};
```

**패턴**:
- `loader` 함수에서 RPC 호출
- 서버 사이드에서 실행되므로 클라이언트 조작 불가
- 페이지 로드 시 자동으로 이벤트 기록

### 4. 외부 링크 방문 트래킹

**파일**: `app/features/products/pages/product-visit-page.tsx`

```typescript
export const loader = async ({ params }: Route.LoaderArgs) => {
  const { error, data } = await client
    .from("products")
    .select("url")
    .eq("product_id", params.productId)
    .single();

  if (data) {
    await client.rpc("track_event", {
      event_type: "product_visit",
      event_data: {
        product_id: params.productId,
      },
    });
    return redirect(data.url);
  }
};
```

**패턴**:
- 외부 URL 조회
- 이벤트 트래킹 후 리다이렉트
- 실제 방문만 기록 (클릭만으로는 기록 안 됨)

### 5. 프로필 조회 트래킹

**파일**: `app/features/users/pages/profile-page.tsx`

```typescript
export const loader = async ({ params }: Route.LoaderArgs) => {
  await client.rpc("track_event", {
    event_type: "profile_view",
    event_data: {
      username: params.username,
    },
  });
  return null;
};
```

## 적용 패턴

### 1. RPC 함수 호출 패턴

```typescript
// Supabase 클라이언트에서 RPC 호출
await client.rpc("function_name", {
  param1: value1,
  param2: value2,
});
```

### 2. Loader에서 이벤트 트래킹

```typescript
export const loader = async ({ params }: Route.LoaderArgs) => {
  // 이벤트 트래킹 (비동기, 에러 무시 가능)
  await client.rpc("track_event", {
    event_type: "event_type",
    event_data: {
      // 이벤트 관련 데이터
    },
  }).catch(console.error); // 에러가 있어도 페이지는 계속 로드
  
  // 기존 로더 로직
  return { data };
};
```

### 3. 외부 링크 방문 트래킹

```typescript
export const loader = async ({ params }: Route.LoaderArgs) => {
  // 외부 URL 조회
  const { data } = await client
    .from("table_name")
    .select("url")
    .eq("id", params.id)
    .single();

  if (data) {
    // 이벤트 트래킹
    await client.rpc("track_event", {
      event_type: "visit",
      event_data: { id: params.id },
    });
    
    // 리다이렉트
    return redirect(data.url);
  }
};
```

## 장점

1. **서버 사이드 실행**: 클라이언트 조작 불가, 보안성 향상
2. **자동 트래킹**: 페이지 로드 시 자동으로 이벤트 기록
3. **유연한 데이터**: jsonb로 다양한 이벤트 데이터 저장 가능
4. **성능**: RPC 함수로 최적화된 쿼리 실행
5. **확장성**: 새로운 이벤트 타입 추가 용이

## 주의사항

1. **에러 처리**: RPC 호출 실패 시 페이지 로드가 중단되지 않도록 처리
2. **비동기 처리**: `await`를 사용하되, 에러는 무시하거나 로깅만 수행
3. **데이터 구조**: `event_data`의 구조를 일관되게 유지
4. **성능**: 이벤트 트래킹이 페이지 로드 시간에 영향을 주지 않도록 주의

## 데이터베이스 마이그레이션

```sql
-- Enum 타입 생성
CREATE TYPE "public"."event_type" AS ENUM(
  'product_view', 
  'product_visit', 
  'profile_view'
);

-- Events 테이블 생성
CREATE TABLE "events" (
  "event_id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
  "event_type" "event_type",
  "event_data" jsonb,
  "created_at" timestamp DEFAULT now()
);

-- RPC 함수 생성
CREATE OR REPLACE FUNCTION track_event(
    event_type event_type,
    event_data jsonb
) RETURNS void AS $$
BEGIN
    INSERT INTO events (event_type, event_data) 
    VALUES (event_type, event_data);
END;
$$ LANGUAGE plpgsql;
```

## 참고

- Supabase RPC 함수는 서버 사이드에서 실행되므로 보안성이 높음
- `client.rpc()`는 Supabase 클라이언트의 메서드
- `event_data`는 jsonb 타입이므로 유연한 데이터 구조 저장 가능
- Loader에서 트래킹하면 페이지 로드 시 자동으로 기록됨

