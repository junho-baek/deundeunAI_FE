# 9.3 Optimistic UI

## 커밋 요약

`useFetcher`로 Action을 호출할 때, 서버 응답을 기다리지 않고 UI를 즉시 업데이트하는 낙관적 렌더링 패턴입니다. 노마드코더 9.3 강의 커밋(a1befc3)에서는 커뮤니티 게시글 업보트 버튼에 적용되었습니다.

## 핵심 패턴

### 1. fetcher 상태를 이용한 낙관적 값

```tsx
const fetcher = useFetcher();
const optimisticVotes =
  fetcher.state === "idle"
    ? votesCount
    : isUpvoted
      ? votesCount - 1
      : votesCount + 1;
const optimisticIsUpvoted =
  fetcher.state === "idle" ? isUpvoted : !isUpvoted;
```

- `fetcher.state`가 `"submitting"` 또는 `"loading"`이면 아직 서버 응답이 오지 않은 상태로 간주.
- 기존 값 대신 낙관적 값을 계산해 즉시 UI에 반영(카운트, 버튼 색상 등).
- 실패 시 Action에서 에러를 돌려주면 `fetcher.state`가 `"idle"`로 돌아가면서 자동으로 기존 값으로 복구.

### 2. `<Link>` 내부 버튼에서 `fetcher.submit` 사용

```tsx
const absorbClick = (event: React.MouseEvent<HTMLButtonElement>) => {
  event.preventDefault();
  fetcher.submit(null, {
    method: "post",
    action: `/community/${id}/upvote`,
  });
};
```

- `null`을 전달하면 내부에서 자동으로 `FormData`가 만들어짐.
- `<Link>`를 감싼 카드 안에서도 페이지 전환 없이 서버 액션만 실행.

### 3. Action & Mutation 분리

```tsx
export const action = async ({ request, params }: Route.ActionArgs) => {
  if (request.method !== "POST") throw new Response("Method not allowed", { status: 405 });

  const { client } = makeSSRClient(request);
  const userId = await getLoggedInUserId(client);
  await toggleUpvote(client, { postId: params.postId, userId });

  return { ok: true };
};
```

- Action에서 인증/권한을 체크하고 비즈니스 로직은 `mutations.ts`에 분리.
- 서버 지연을 테스트하기 위해 `setTimeout`을 거는 패턴도 함께 시연.

## Projects 모듈 적용

### 1. 워크스페이스 단계 상태를 낙관적으로 갱신

`app/features/projects/pages/project-workspace-page.tsx`에서 각 단계 Action(`brief/submit`, `script/submit`, …)의 `fetcher.state`를 감시해 `loading`/`done` 값을 즉시 반영했습니다.

```tsx
const optimisticDone = React.useMemo(() => ({
  brief: done.brief || briefSubmitPending,
  script: done.script || scriptSubmitPending,
  ...
}), [...]);

const optimisticLoading = React.useMemo(() => ({
  brief: loading.brief || briefSubmitPending || briefUpdatePending,
  script: loading.script || scriptSubmitPending || briefSubmitPending,
  ...
}), [...]);
```

- 사용자가 “이대로 제출”을 누르는 즉시 다음 단계가 진행 중인 것처럼 렌더링됩니다.
- 폴링(`useProjectStepStatus`)으로 실제 DB 상태가 도착하면 자연스럽게 덮어씌워집니다.

### 2. 추가 적용 아이디어

1. **프로젝트 카드 좋아요/북마크**: 추후 좋아요 수를 표시할 때, 카드 CTA에서 `useFetcher`를 사용해 낙관적 카운트 반영 가능.
2. **이미지/영상 재생성 버튼**: 재생성 액션 동안 썸네일 skeleton을 즉시 교체하거나 “재생성 중” 배지를 띄우도록 fetcher state를 활용.
3. **프로젝트 생성 채팅**: 초기 메시지/키워드 전송 시 로컬 메시지 목록에 즉시 “제출됨” 태그를 붙이고 실패 시 되돌리는 패턴으로 확장 가능.

필요하면 다른 컴포넌트에도 동일한 `optimistic` 계산 함수를 도입해 드릴 수 있습니다.
