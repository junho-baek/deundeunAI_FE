# 10.5 Realtime Messages

## 커밋 요약

커밋 `b568063`에서는 DM 화면에 Supabase Realtime을 연결해 새 메시지를 실시간으로 반영했습니다.

1. **Outlet Context 확장**  
   - Messages 레이아웃에서 `useOutletContext`로 `userId`, `name`, `avatar`를 하위 라우트에 전달합니다.  
   - Message 페이지에서 본인 메시지를 구분하거나 아바타를 재사용할 수 있도록 함.

2. **Message 페이지**  
   - 컴포넌트 내부에서 `useState`로 메시지 배열을 관리하고, Loader 결과를 초기값으로 사용합니다.  
   - `browserClient.channel(...).on('postgres_changes', ...)`를 통해 `messages` 테이블의 INSERT 이벤트를 구독.  
   - 새로운 메시지가 오면 state에 push하고, cleanup에서 구독을 해제합니다.  
   - `shouldRevalidate = () => false`로 포스트 제출 후 전체 리로드를 막고, Realtime 업데이트에만 의존합니다.

3. **쿼리/데이터 변경**  
   - `getMessagesByMessagesRoomId`에서 sender 조인을 제거하고, Realtime payload에 포함된 sender_id 기준으로 UI에서 아바타·이름을 결정합니다.

## 든든 AI 적용 포인트

워크스페이스 채팅은 이미 React state에 메시지를 쌓는 구조이지만, 아래 부분에 참고할 가치가 있습니다.

- Supabase Realtime을 구독해 n8n 또는 LLM이 생성한 어시스턴트 메시지를 폴링 없이 바로 반영할 수 있습니다.  
- `shouldRevalidate = () => false` 패턴을 쓰면 submit/Action 이후 페이지 전체를 재로딩하지 않고 fetcher 결과 또는 Realtime 이벤트만 반영하게 만들 수 있습니다.

필요하면 워크스페이스 채팅에도 Realtime channel 설정을 붙여 단계 진행과 동시에 메시지가 자동으로 도착하도록 확장할 수 있습니다.
