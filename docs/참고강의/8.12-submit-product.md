# 8.12 Submit Product

## ì»¤ë°‹ ìš”ì•½

ì œí’ˆ ì œì¶œ ê¸°ëŠ¥ì„ êµ¬í˜„í•œ ì»¤ë°‹ì…ë‹ˆë‹¤. ì œí’ˆ ìƒì„± mutation, íŒŒì¼ ì—…ë¡œë“œ(ì•„ì´ì½˜), Zod ê²€ì¦, ì¹´í…Œê³ ë¦¬ ì„ íƒ, Loaderì—ì„œ ì¹´í…Œê³ ë¦¬ ì¡°íšŒ ë“±ì˜ íŒ¨í„´ì„ ë³´ì—¬ì¤ë‹ˆë‹¤.

## ì£¼ìš” ë³€ê²½ì‚¬í•­

### 1. Mutationsì— ì œí’ˆ ìƒì„± í•¨ìˆ˜ ì¶”ê°€

**êµ¬í˜„**:
```typescript
// app/features/products/mutations.ts
export const createProduct = async (
  client: SupabaseClient<Database>,
  {
    name,
    tagline,
    description,
    howItWorks,
    url,
    iconUrl,
    categoryId,
    userId,
  }: {
    name: string;
    tagline: string;
    description: string;
    howItWorks: string;
    url: string;
    iconUrl: string;
    categoryId: number;
    userId: string;
  }
) => {
  const { data, error } = await client
    .from("products")
    .insert({
      name,
      tagline,
      description,
      how_it_works: howItWorks,
      url,
      icon: iconUrl,
      category_id: categoryId,
      profile_id: userId,
    })
    .select("product_id")
    .single();

  if (error) throw error;
  return data.product_id;
};
```

**íŒ¨í„´**:
- ì—¬ëŸ¬ í•„ë“œ ì‚½ì…
- `.select("product_id").single()`ë¡œ ìƒì„±ëœ ID ë°˜í™˜
- ì—ëŸ¬ëŠ” ê·¸ëŒ€ë¡œ throw

**ì¥ì **: ì œí’ˆ ìƒì„± ë¡œì§ ìº¡ìŠí™”

### 2. Loaderì—ì„œ ì¹´í…Œê³ ë¦¬ ì¡°íšŒ

**êµ¬í˜„**:
```typescript
export const loader = async ({ request }: Route.LoaderArgs) => {
  const { client } = makeSSRClient(request);
  const userId = await getLoggedInUserId(client);
  const categories = await getCategories(client);
  return { categories };
};
```

**íŒ¨í„´**: Loaderì—ì„œ ì¹´í…Œê³ ë¦¬ ëª©ë¡ ì¡°íšŒ

**ì¥ì **: ì„œë²„ ì‚¬ì´ë“œì—ì„œ ë°ì´í„° ì¡°íšŒ

### 3. Actionì—ì„œ íŒŒì¼ ì—…ë¡œë“œ ë° ì œí’ˆ ìƒì„±

**êµ¬í˜„**:
```typescript
const formSchema = z.object({
  name: z.string().min(1),
  tagline: z.string().min(1),
  url: z.string().min(1),
  description: z.string().min(1),
  howItWorks: z.string().min(1),
  category: z.coerce.number(),
  icon: z.instanceof(File).refine((file) => {
    return file.size <= 2097152 && file.type.startsWith("image/");
  }),
});

export const action = async ({ request }: Route.ActionArgs) => {
  const { client } = makeSSRClient(request);
  const userId = await getLoggedInUserId(client);
  const formData = await request.formData();
  
  const { data, success, error } = formSchema.safeParse(
    Object.fromEntries(formData)
  );

  if (!success) {
    return { formErrors: error.flatten().fieldErrors };
  }

  const { icon, ...rest } = data;

  // ì•„ì´ì½˜ ì—…ë¡œë“œ
  const { data: uploadData, error: uploadError } = await client.storage
    .from("icons")
    .upload(`${userId}/${Date.now()}`, icon, {
      contentType: icon.type,
      upsert: false,
    });

  if (uploadError) {
    return { formErrors: { icon: ["Failed to upload icon"] } };
  }

  const {
    data: { publicUrl },
  } = await client.storage.from("icons").getPublicUrl(uploadData.path);

  // ì œí’ˆ ìƒì„±
  const productId = await createProduct(client, {
    name: rest.name,
    tagline: rest.tagline,
    description: rest.description,
    howItWorks: rest.howItWorks,
    url: rest.url,
    iconUrl: publicUrl,
    categoryId: rest.category,
    userId,
  });

  return redirect(`/products/${productId}`);
};
```

**íŒ¨í„´**:
- Zod ìŠ¤í‚¤ë§ˆë¡œ ê²€ì¦
- `z.instanceof(File)`ë¡œ íŒŒì¼ íƒ€ì… ê²€ì¦
- `.refine()`ìœ¼ë¡œ íŒŒì¼ í¬ê¸° ë° íƒ€ì… ê²€ì¦
- `z.coerce.number()`ë¡œ ë¬¸ìì—´ì„ ìˆ«ìë¡œ ë³€í™˜
- íŒŒì¼ ì—…ë¡œë“œ í›„ ì œí’ˆ ìƒì„±
- ì„±ê³µ ì‹œ ì œí’ˆ ìƒì„¸ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸

**ì¥ì **:
- ê°•ë ¥í•œ ìœ íš¨ì„± ê²€ì‚¬
- íƒ€ì… ì•ˆì •ì„±
- íŒŒì¼ ê²€ì¦

### 4. Formì— `encType="multipart/form-data"` ì¶”ê°€

**êµ¬í˜„**:
```typescript
<Form
  method="post"
  encType="multipart/form-data"
  className="grid grid-cols-2 gap-10 max-w-screen-lg mx-auto"
>
```

**íŒ¨í„´**: íŒŒì¼ ì—…ë¡œë“œë¥¼ ìœ„í•´ `encType` í•„ìˆ˜

### 5. SelectPairì— ë™ì  ì˜µì…˜ ì „ë‹¬

**êµ¬í˜„**:
```typescript
<SelectPair
  label="Category"
  description="The category of your product"
  name="category"
  required
  placeholder="Select a category"
  options={loaderData.categories.map((category) => ({
    label: category.name,
    value: category.category_id.toString(),
  }))}
/>
```

**íŒ¨í„´**: Loaderì—ì„œ ê°€ì ¸ì˜¨ ë°ì´í„°ë¥¼ ì˜µì…˜ìœ¼ë¡œ ë³€í™˜

**ì¥ì **: ë™ì  ì¹´í…Œê³ ë¦¬ ëª©ë¡

### 6. ì—ëŸ¬ ë©”ì‹œì§€ í‘œì‹œ

**êµ¬í˜„**:
```typescript
{actionData &&
  "formErrors" in actionData &&
  actionData?.formErrors?.name && (
    <p className="text-red-500">{actionData.formErrors.name}</p>
  )}
```

**íŒ¨í„´**: íƒ€ì… ê°€ë“œë¡œ ì•ˆì „í•˜ê²Œ ì—ëŸ¬ ì ‘ê·¼

**ì¥ì **: íƒ€ì… ì•ˆì •ì„± í–¥ìƒ

### 7. ìŠ¤í‚¤ë§ˆ ë³€ê²½

**êµ¬í˜„**:
```typescript
profile_id: uuid()
  .notNull()
  .references(() => profiles.profile_id, {
    onDelete: "cascade",
  }),
category_id: bigint({ mode: "number" })
  .references(() => categories.category_id, { onDelete: "set null" })
  .notNull(),
```

**íŒ¨í„´**:
- `profile_id`ì— `onDelete: "cascade"` ì¶”ê°€
- `category_id`ì— `notNull()` ì¶”ê°€

**ì¥ì **: ë°ì´í„° ë¬´ê²°ì„± ë³´ì¥

## ì ìš© ë°©ì•ˆ

### âœ… ì´ë¯¸ ì ìš©ëœ íŒ¨í„´

1. **Loader ì‚¬ìš©**: ì—¬ëŸ¬ í˜ì´ì§€ì—ì„œ ì´ë¯¸ ì‚¬ìš© ì¤‘
2. **Zod ê²€ì¦**: ì—¬ëŸ¬ í˜ì´ì§€ì—ì„œ ì‚¬ìš© ì¤‘
3. **Mutations íŒŒì¼ ë¶„ë¦¬**: ì´ë¯¸ ì ìš©ë¨
4. **Formì— `method="post"` ëª…ì‹œ**: ì¼ë¶€ Formì—ì„œ ì‚¬ìš© ì¤‘
5. **íŒŒì¼ ì—…ë¡œë“œ**: ì•„ë°”íƒ€ ì—…ë¡œë“œì—ì„œ ì‚¬ìš© ì¤‘

### ğŸ”„ ì¶”ê°€ë¡œ ì ìš© ê°€ëŠ¥í•œ íŒ¨í„´

#### 1. ì œí’ˆ ì œì¶œ í˜ì´ì§€ êµ¬í˜„ (ìš°ì„ ìˆœìœ„: ë‚®ìŒ)

**í˜„ì¬ ìƒíƒœ**: ì œí’ˆ ì œì¶œ í˜ì´ì§€ ì—†ìŒ

**ì ìš© ë°©ì•ˆ**: í•„ìš” ì‹œ êµ¬í˜„

**ì£¼ì˜ì‚¬í•­**: í˜„ì¬ í”„ë¡œì íŠ¸ëŠ” í”„ë¡œì íŠ¸ ì¤‘ì‹¬ì´ë¯€ë¡œ ì œí’ˆ ì œì¶œ ê¸°ëŠ¥ì´ í•„ìš”í•˜ì§€ ì•Šì„ ìˆ˜ ìˆìŒ

#### 2. Zod ìŠ¤í‚¤ë§ˆì—ì„œ íŒŒì¼ ê²€ì¦ ê°•í™” (ìš°ì„ ìˆœìœ„: ì¤‘ê°„)

**í˜„ì¬ ìƒíƒœ**: ê¸°ë³¸ ê²€ì¦ë§Œ ìˆìŒ

**ì ìš© ë°©ì•ˆ**:
```typescript
icon: z.instanceof(File).refine((file) => {
  return file.size <= 2097152 && file.type.startsWith("image/");
}, "íŒŒì¼ í¬ê¸°ëŠ” 2MB ì´í•˜ì´ê³  ì´ë¯¸ì§€ íŒŒì¼ì´ì–´ì•¼ í•©ë‹ˆë‹¤."),
```

**ì¥ì **: ë” ëª…í™•í•œ ì—ëŸ¬ ë©”ì‹œì§€

#### 3. SelectPairì— ë™ì  ì˜µì…˜ ì „ë‹¬ íŒ¨í„´ (ìš°ì„ ìˆœìœ„: ì¤‘ê°„)

**í˜„ì¬ ìƒíƒœ**: ì¼ë¶€ SelectPairì—ì„œë§Œ ì‚¬ìš©

**ì ìš© ë°©ì•ˆ**: Loaderì—ì„œ ë°ì´í„° ì¡°íšŒ í›„ ë™ì  ì˜µì…˜ ìƒì„±

**ì¥ì **: ë™ì  ë°ì´í„° í‘œì‹œ

## êµ¬í˜„ ìš°ì„ ìˆœìœ„

### ë‚®ìŒ (í•„ìš” ì‹œ ì ìš©)

1. **ì œí’ˆ ì œì¶œ í˜ì´ì§€ êµ¬í˜„**
   - ì˜í–¥ë„: ë‚®ìŒ (í˜„ì¬ í”„ë¡œì íŠ¸ì— í•„ìš” ì—†ì„ ìˆ˜ ìˆìŒ)
   - ë‚œì´ë„: ì¤‘ê°„
   - íš¨ê³¼: ì œí’ˆ ì œì¶œ ê¸°ëŠ¥ ì¶”ê°€

### ì¤‘ê°„ (ì ì§„ì  ì ìš©)

2. **Zod ìŠ¤í‚¤ë§ˆì—ì„œ íŒŒì¼ ê²€ì¦ ê°•í™”**
   - ì˜í–¥ë„: ì¤‘ê°„ (UX ê°œì„ )
   - ë‚œì´ë„: ë‚®ìŒ
   - íš¨ê³¼: ë” ëª…í™•í•œ ì—ëŸ¬ ë©”ì‹œì§€

3. **SelectPairì— ë™ì  ì˜µì…˜ ì „ë‹¬ íŒ¨í„´**
   - ì˜í–¥ë„: ì¤‘ê°„ (ì½”ë“œ í’ˆì§ˆ)
   - ë‚œì´ë„: ë‚®ìŒ
   - íš¨ê³¼: ë™ì  ë°ì´í„° í‘œì‹œ

## ì°¸ê³ ì‚¬í•­

- `z.instanceof(File)`ë¡œ íŒŒì¼ íƒ€ì… ê²€ì¦
- `.refine()`ìœ¼ë¡œ ì¶”ê°€ ê²€ì¦ ë¡œì§ ì¶”ê°€ ê°€ëŠ¥
- `z.coerce.number()`ë¡œ ë¬¸ìì—´ì„ ìˆ«ìë¡œ ë³€í™˜
- íŒŒì¼ ì—…ë¡œë“œ í›„ ìƒì„±ëœ URLì„ ì‚¬ìš©í•˜ì—¬ ë°ì´í„° ì €ì¥
- ì„±ê³µ ì‹œ ìƒì„¸ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
- `encType="multipart/form-data"`ëŠ” íŒŒì¼ ì—…ë¡œë“œì— í•„ìˆ˜
- SelectPairì— ë™ì  ì˜µì…˜ ì „ë‹¬ ì‹œ `.map()` ì‚¬ìš©

