# 6.4 IdeasGPT Pages

## 커밋 개요

이 커밋은 IdeasGPT 기능을 구현하고 실제 DB 데이터를 사용하도록 개선합니다. View를 활용한 효율적인 데이터 조회와 DateTime을 사용한 상대 시간 표시를 구현합니다.

## 주요 변경사항

### 1. View 생성: `gpt_ideas_view.sql`

**새 파일: `app/sql/views/gpt_ideas_view.sql`**

```sql
CREATE OR REPLACE VIEW gpt_ideas_view AS
SELECT
  gpt_ideas.gpt_idea_id,
  gpt_ideas.idea,
  gpt_ideas.views,
  CASE WHEN gpt_ideas.claimed_at IS NULL THEN FALSE ELSE TRUE END AS is_claimed,
  COUNT(gpt_ideas_likes.gpt_idea_id) AS likes,
  gpt_ideas.created_at
FROM public.gpt_ideas
LEFT JOIN public.gpt_ideas_likes USING (gpt_idea_id)
GROUP BY gpt_ideas.gpt_idea_id;
```

**핵심 포인트:**
- **LEFT JOIN**: 좋아요가 없는 아이디어도 포함
- **CASE 문**: `claimed_at`이 NULL이면 `is_claimed = FALSE`
- **COUNT 집계**: 좋아요 개수를 그룹화하여 계산
- **GROUP BY**: `gpt_idea_id`로 그룹화하여 중복 제거

### 2. 쿼리 함수 생성: `queries.ts`

**새 파일: `app/features/ideas/queries.ts`**

```typescript
import client from "~/supa-client";

export const getGptIdeas = async ({ limit }: { limit: number }) => {
  const { data, error } = await client
    .from("gpt_ideas_view")
    .select("*")
    .limit(limit);

  if (error) {
    throw error;
  }

  return data;
};

export const getGptIdea = async (ideaId: string) => {
  const { data, error } = await client
    .from("gpt_ideas_view")
    .select("*")
    .eq("gpt_idea_id", ideaId)
    .single();

  if (error) {
    throw error;
  }

  return data;
};
```

**핵심 포인트:**
- **View 사용**: `gpt_ideas_view`를 통해 JOIN된 데이터 조회
- **단일 아이디어 조회**: `.single()`로 단일 결과 반환
- **에러 처리**: 에러 발생 시 throw

### 3. 홈 페이지에 실제 데이터 적용

**변경된 파일: `app/common/pages/home-page.tsx`**

**Before (Mock 데이터):**
```typescript
export const loader = async () => {
  const products = await getProductsByDateRange({
    startDate: DateTime.now().startOf("day"),
    endDate: DateTime.now().endOf("day"),
    limit: 7,
  });
  const posts = await getPosts({ limit: 7, sorting: "newest" });
  return { products, posts };
};

// 컴포넌트에서
{Array.from({ length: 5 }).map((_, index) => (
  <IdeaCard
    key={`ideaId-${index}`}
    id={`ideaId-${index}`}
    title="A startup that creates..."
    viewsCount={123}
    postedAt="12 hours ago"
    likesCount={12}
    claimed={index % 2 === 0}
  />
))}
```

**After (실제 데이터):**
```typescript
import { getGptIdeas } from "~/features/ideas/queries";

export const loader = async () => {
  const products = await getProductsByDateRange({
    startDate: DateTime.now().startOf("day"),
    endDate: DateTime.now().endOf("day"),
    limit: 7,
  });
  const posts = await getPosts({ limit: 7, sorting: "newest" });
  const ideas = await getGptIdeas({ limit: 7 });
  return { products, posts, ideas };
};

// 컴포넌트에서
{loaderData.ideas.map((idea) => (
  <IdeaCard
    key={idea.gpt_idea_id}
    id={idea.gpt_idea_id}
    title={idea.idea}
    viewsCount={idea.views}
    postedAt={idea.created_at}
    likesCount={idea.likes}
    claimed={idea.is_claimed}
  />
))}
```

**핵심 포인트:**
- 더미 데이터 대신 실제 DB 데이터 사용
- View를 통해 JOIN된 데이터를 평탄화된 구조로 받음

### 4. 아이디어 상세 페이지 구현

**변경된 파일: `app/features/ideas/pages/idea-page.tsx`**

**Before:**
```typescript
export default function IdeaPage() {
  return (
    <div>
      <Hero title="Idea #1212122" />
      <p>"A startup that creates..."</p>
      <div>
        <span>123</span>
        <span>12 hours ago</span>
        <span>12</span>
      </div>
    </div>
  );
}
```

**After:**
```typescript
import { getGptIdea } from "../queries";
import { DateTime } from "luxon";

export const loader = async ({ params }: Route.LoaderArgs) => {
  const idea = await getGptIdea(params.ideaId);
  return { idea };
};

export const meta = ({
  data: {
    idea: { gpt_idea_id, idea },
  },
}: Route.MetaArgs) => {
  return [
    { title: `Idea #${gpt_idea_id}: ${idea} | wemake` },
    { name: "description", content: "Find ideas for your next project" },
  ];
};

export default function IdeaPage({ loaderData }: Route.ComponentProps) {
  return (
    <div>
      <Hero title={`Idea #${loaderData.idea.gpt_idea_id}`} />
      <p>"{loaderData.idea.idea}"</p>
      <div>
        <span>{loaderData.idea.views}</span>
        <span>
          {DateTime.fromISO(loaderData.idea.created_at).toRelative()}
        </span>
        <span>{loaderData.idea.likes}</span>
      </div>
    </div>
  );
}
```

**핵심 포인트:**
- **Loader 추가**: 서버 사이드에서 데이터 로드
- **Meta 함수**: 동적 메타 태그 생성
- **DateTime 사용**: 상대 시간 표시 (`toRelative()`)

### 5. 아이디어 목록 페이지 구현

**변경된 파일: `app/features/ideas/pages/ideas-page.tsx`**

**Before:**
```typescript
export default function IdeasPage() {
  return (
    <div>
      <Hero title="IdeasGPT" subtitle="Find ideas for your next project" />
      <div>
        {Array.from({ length: 10 }).map((_, index) => (
          <IdeaCard
            key={`ideaId-${index}`}
            id={`ideaId-${index}`}
            title="A startup that creates..."
            viewsCount={123}
            postedAt="12 hours ago"
            likesCount={12}
            claimed={index % 2 === 0}
          />
        ))}
      </div>
    </div>
  );
}
```

**After:**
```typescript
import { getGptIdeas } from "../queries";

export const loader = async () => {
  const ideas = await getGptIdeas({ limit: 20 });
  return { ideas };
};

export default function IdeasPage({ loaderData }: Route.ComponentProps) {
  return (
    <div>
      <Hero title="IdeasGPT" subtitle="Find ideas for your next project" />
      <div>
        {loaderData.ideas.map((idea) => (
          <IdeaCard
            key={idea.gpt_idea_id}
            id={idea.gpt_idea_id}
            title={idea.idea}
            viewsCount={idea.views}
            postedAt={idea.created_at}
            likesCount={idea.likes}
            claimed={idea.is_claimed}
          />
        ))}
      </div>
    </div>
  );
}
```

**핵심 포인트:**
- Loader로 서버 사이드 데이터 로드
- 실제 DB 데이터 사용

### 6. IdeaCard 컴포넌트 개선

**변경된 파일: `app/features/ideas/components/idea-card.tsx`**

**Before:**
```typescript
interface IdeaCardProps {
  id: string;
  postedAt: string;
}

export function IdeaCard({ id, postedAt }: IdeaCardProps) {
  return (
    <Card>
      <span>{postedAt}</span>
    </Card>
  );
}
```

**After:**
```typescript
import { DateTime } from "luxon";

interface IdeaCardProps {
  id: number; // gpt_idea_id는 number 타입
  postedAt: string;
}

export function IdeaCard({ id, postedAt }: IdeaCardProps) {
  return (
    <Card>
      <span>{DateTime.fromISO(postedAt).toRelative()}</span>
    </Card>
  );
}
```

**핵심 포인트:**
- **타입 변경**: `id`를 `string`에서 `number`로 변경 (DB 타입과 일치)
- **DateTime 사용**: ISO 문자열을 상대 시간으로 변환 (`toRelative()`)

### 7. 타입 정의 업데이트

**변경된 파일: `app/supa-client.ts`**

```typescript
gpt_ideas_view: {
  Row: SetNonNullable<
    SupabaseDatabase["public"]["Views"]["gpt_ideas_view"]["Row"]
  >;
};
```

**변경된 파일: `database.types.ts`**

```typescript
gpt_ideas_view: {
  Row: {
    created_at: string | null;
    gpt_idea_id: number | null;
    idea: string | null;
    is_claimed: boolean | null;
    likes: number | null;
    views: number | null;
  };
  Relationships: [];
};
```

**핵심 포인트:**
- View 타입을 Supabase 타입에 추가
- `type-fest`의 `SetNonNullable`로 타입 안전성 향상

## 우리 프로젝트에 적용하기

### 현재 상태 분석

우리 프로젝트는 현재:
- ✅ Supabase 클라이언트 사용 중
- ✅ View를 활용한 데이터 조회 패턴 적용 중
- ✅ Loader 함수 사용 중
- ❌ DateTime을 사용한 상대 시간 표시 미구현
- ❌ View 타입 정의 미완성

### 적용 전략

#### 1단계: View 생성 패턴 이해

**CASE 문 사용:**
```sql
CASE WHEN gpt_ideas.claimed_at IS NULL THEN FALSE ELSE TRUE END AS is_claimed
```

**LEFT JOIN과 COUNT:**
```sql
LEFT JOIN public.gpt_ideas_likes USING (gpt_idea_id)
GROUP BY gpt_ideas.gpt_idea_id
```

#### 2단계: DateTime을 사용한 상대 시간 표시

**Luxon 설치:**
```bash
npm install luxon
npm install --save-dev @types/luxon
```

**사용 예시:**
```typescript
import { DateTime } from "luxon";

// ISO 문자열을 상대 시간으로 변환
DateTime.fromISO("2024-01-01T00:00:00Z").toRelative();
// "2 hours ago", "3 days ago" 등

// 현재 시간 기준으로 변환
DateTime.fromISO(dateString).toRelative({ base: DateTime.now() });
```

#### 3단계: View 타입 정의

**파일: `app/lib/supa-client.ts`**

```typescript
import type { Database as SupabaseDatabase } from "~/database.types";
import type { SetNonNullable } from "type-fest";

type Database = MergeDeep<
  SupabaseDatabase,
  {
    public: {
      Views: {
        gpt_ideas_view: {
          Row: SetNonNullable<
            SupabaseDatabase["public"]["Views"]["gpt_ideas_view"]["Row"]
          >;
        };
      };
    };
  }
>;
```

## View 패턴

### 기본 패턴

```sql
CREATE OR REPLACE VIEW view_name AS
SELECT
  table1.id,
  table1.field1,
  CASE WHEN table1.field2 IS NULL THEN FALSE ELSE TRUE END AS boolean_field,
  COUNT(table2.id) AS count_field,
  table1.created_at
FROM table1
LEFT JOIN table2 USING (id)
GROUP BY table1.id;
```

### CASE 문 패턴

```sql
-- NULL 체크
CASE WHEN field IS NULL THEN default_value ELSE field END AS alias

-- 조건부 값
CASE 
  WHEN condition1 THEN value1
  WHEN condition2 THEN value2
  ELSE default_value
END AS alias
```

### COUNT 집계 패턴

```sql
-- LEFT JOIN과 함께 사용
LEFT JOIN related_table USING (id)
GROUP BY main_table.id

-- COUNT 결과는 number 타입
COUNT(related_table.id) AS count_field
```

## DateTime 사용 패턴

### 기본 사용법

```typescript
import { DateTime } from "luxon";

// ISO 문자열 파싱
const date = DateTime.fromISO("2024-01-01T00:00:00Z");

// 상대 시간 표시
date.toRelative(); // "2 hours ago"

// 포맷팅
date.toFormat("yyyy-MM-dd HH:mm"); // "2024-01-01 00:00"
```

### 다양한 포맷

```typescript
// 상대 시간
DateTime.fromISO(dateString).toRelative();

// 절대 시간
DateTime.fromISO(dateString).toFormat("yyyy-MM-dd");

// 로컬 시간대
DateTime.fromISO(dateString).setZone("Asia/Seoul").toFormat("yyyy-MM-dd HH:mm");
```

## 장점

1. **View 활용**: 복잡한 JOIN을 View로 캡슐화
2. **타입 안전성**: TypeScript로 View 타입 정의
3. **사용자 경험**: 상대 시간 표시로 더 직관적
4. **성능**: View를 통한 효율적인 쿼리

## 주의사항

1. **타입 일치**: DB 타입과 TypeScript 타입 일치 확인
2. **NULL 처리**: CASE 문으로 NULL 값 처리
3. **타임존**: DateTime 사용 시 타임존 고려
4. **성능**: COUNT 집계 시 인덱스 확인

## 다음 단계

1. ✅ View 생성 패턴 이해
2. ✅ DateTime 사용 패턴 학습
3. ⏳ 아이디어 필터링 기능 추가
4. ⏳ 아이디어 검색 기능 추가
5. ⏳ 아이디어 좋아요 기능 구현
6. ⏳ 아이디어 클레임 기능 구현

## 참고 자료

- [Luxon DateTime 문서](https://moment.github.io/luxon/#/parsing)
- [Supabase Views 문서](https://supabase.com/docs/guides/database/views)
- [PostgreSQL CASE 문](https://www.postgresql.org/docs/current/functions-conditional.html)
- [PostgreSQL COUNT 집계](https://www.postgresql.org/docs/current/functions-aggregate.html)

